(function (window, document) {
    var EMPTY_LIGHTBOX = 'none',
        ADORIC_IDENTIFIER = '__ADORIC__',
        ADORIC_SCRIPT_OLD_ID = '__ADORIC__SCRIPT__',
        ADORIC_SCRIPT_ID = 'Adoric_Script',
        ADORIC_SCRIPT_LOAD_TIME = Date.now(),

        GET_METHOD = 'GET',
        POST_METHOD = 'POST',
        PUT_METHOD = 'PUT',

        MAILCHIMP_SUBSCRIBE_ACTION = 'mailchimp/subscribe',
        ADORIC_SCRIPT = document.getElementById(ADORIC_SCRIPT_OLD_ID) || document.getElementById(ADORIC_SCRIPT_ID),

        ADORIC_HOST = /\S+\//.exec(ADORIC_SCRIPT.getAttribute('src'))[0].replace(/\/\/(\d+)/g, '//app').replace(/adoric.com/g, 'app.adoric-om.com'),
        PROTOCOL = (ADORIC_HOST.indexOf('http:') === -1 && ADORIC_HOST.indexOf('https:') === -1) ? 'https:' : '',
        ADORIC_URL = PROTOCOL + ADORIC_HOST,
        S3_URL = 'https://s3.amazonaws.com/adoric-fonts/',
        ADORIC_API_URL = ADORIC_URL,
        LOCATION_API_URL_0 = 'https://api.geoipcloud.com/v1/json?country=1&city=1',
        LOCATION_API_URL_2 = '//api.sypexgeo.net/',
        LIGHTBOX_API_URL = ADORIC_API_URL + 'v1/campaigns/',
        LIGHTBOX_HTML_API_URL = ADORIC_API_URL + 'v1/versions/html/',
        VERSION_API_URL = ADORIC_API_URL + 'v1/versions/version/',
        TRACK_EVENT_API_URL = ADORIC_API_URL + 'v1/analytics/events',
        TRACK_GOAL_API_URL = ADORIC_API_URL + 'v1/analytics/goals',
        UPDATE_USER_API_URL = ADORIC_API_URL + 'v1/analytics/goals/liftUser',
        LIGHTBOX_INCREASE_CLICK_API_URL = ADORIC_API_URL + 'v1/statistics/click',
        LIGHTBOX_INCREASE_SHOW_API_URL = ADORIC_API_URL + 'v1/statistics/showed',
        LIGHTBOX_INCREASE_ERROR_API_URL = ADORIC_API_URL + 'v1/statistics/error',
        WEBHOOK_ACTION = ADORIC_API_URL + 'v1/forms/webhook',

        CLOSE_LIGHTBOX_CLASS = 'closeLightboxButton',

        ADORIC_CSS_URL = '//s3.amazonaws.com/adoric-static/adoric.min.css',
        ADORIC_STYLES_LOADED = false,

        SB_TYPE_MOBILE = 'mobile',
        SB_TYPE_TABLET = 'tablet',
        SB_TYPE_DESKTOP = 'desktop',
        EVENT_TYPE_LOAD = 'load',

        CLOSED_BY_CLICK_LINK_REDIRECT = 0,
        CLOSED_BY_SUBMIT_FORM = 1,
        CLOSED_BY_AUTOCLOSE_TIMER = 2,
        CLOSED_BY_SCROLL_TOP = 3,
        CLOSED_BY_CLOSE_ELEMENT = 4,
        CLOSED_BY_REFRESH = 5,
        CLOSED_BY_TIMER = 6,

        SHOWED_BY_DEFAULT = 0,
        SHOWED_BY_TIMER = 1,
        SHOWED_BY_SCROLL_TOP = 3,
        SHOWED_BY_DOCUMENT_MOUSEOUT = 4,
        SHOWED_BY_CLICK_LINK = 5,
        SHOWED_BY_CLOSE_WINDOW = 6,
        SHOWED_BY_EVENT = 7,

        CLICKED_LINK_REDIRECT = 0,
        CLICKED_BY_SUBMIT_FORM = 1,
        CLICKED_BY_DYNAMIC_LINK = 2,
        CLICKED_TO_CONVERSION_TARGET = 3,

        CONDITIONS_TYPE_URL = 0,
        CONDITIONS_TYPE_QUERY = 1,

        SEARCH_SYSTEMS = ['.daum.', '.eniro.', '.naver.', '.google.', '.yahoo.', '.msn.', '.aol.', '.lycos.', '.ask.', '.altavista.', '.cnn.', '.about.', '.alltheweb.', '.voila.', '.bing.', '.baidu.', '.alice.', '.yandex.', '.najdi.', '.mamma.', '.seznam.', '.search.', '.wp.', '.szukacz.', '.yam.', '.pchome.', '.kvasir.', '.ozu.', '.terra.', '.mynet.', '.ekolay.', '.rambler.'],
        SEARCH_SYSTEMS_REG_EXP = new RegExp(SEARCH_SYSTEMS.join('|'), 'i'),

        SEARCH_NAMES_SYSTEMS = ['daum', 'eniro', 'naver', 'google', 'yahoo', 'msn', 'lycos', 'ask', 'altavista', 'cnn', 'about', 'alltheweb', 'voila', 'bing', 'baidu', 'alice', 'yandex', 'najdi', 'aol', 'mamma', 'seznam', 'search', 'wp', 'szukacz', 'yam', 'pchome', 'kvasir', 'ozu', 'terra', 'mynet', 'ekolay', 'rambler'],
        SEARCH_NAMES_SYSTEMS_REG_EXP = new RegExp(SEARCH_NAMES_SYSTEMS.join('|'), 'i'),

        SOCIAL_NETWORKS = ['.blab.', '.facebook.', '.fb.', '.plus.google.', '.hi5.', '.linkedin.', '.joinhouse.', '.mylife.', '.ning.', '.periscope.', '.plaxo.', '.twitter.', '.xing.', '.bing.', '.apple.', '.vimeo.', '.myspace.', '.youtube.', '.instagram.', '.digg.', '.hootsuite.', '.path.', '.pinterest.', '.reddit.', '.scribd.', '.slideshare.', '.stumbleupon.', '.tumblr.', '.vk.', '.flickr.', '.vine.', '.meetup.', '.ask.', '.classmates.'],
        SOCIAL_NETWORKS_REG_EXP = new RegExp(SOCIAL_NETWORKS.join('|'), 'i'),

        SOCIAL_NAMES_NETWORKS = ['blab', 'facebook', 'fb', 'plusgoogle', 'hi5', 'linkedin', 'joinhouse', 'mylife', 'ning', 'periscope', 'plaxo', 'twitter', 'xing', 'bing', 'apple', 'vimeo', 'myspace', 'youtube', 'instagram', 'digg', 'hootsuite', 'path', 'pinterest', 'reddit', 'scribd', 'slideshare', 'stumbleupon', 'tumblr', 'vk', 'flickr', 'vine', 'meetup', 'ask', 'classmates'],
        SOCIAL_NAMES_NETWORKS_REG_EXP = new RegExp(SOCIAL_NAMES_NETWORKS.join('|'), 'i'),

        PAID_TYPE = ['cpc', 'ppc', 'cpm', 'paidsearch', 'cpa'],
        PAID_TYPE_REG_EXP = new RegExp(PAID_TYPE.join('|'), 'i'),

        NO_CAMPAIGN_FOR_URL = 1,
        CONDITIONS_DONT_MEET = 2,
        ALREADY_SAW = 3,

        TRACKED_EVENT_TIME = 0,
        TRACKED_EVENT_COUNT = 1,
        TRACKED_EVENT_VALUE = 2,

        EVENT_IS_UNIQUE = 1,

        LB_POSITION_TOP_CENTER = 2,
        LB_POSITION_BOTTOM_CENTER = 8,

        SCREEN_WIDTH = screen.width,
        DEVICE_TYPE = (SCREEN_WIDTH > 800) && SB_TYPE_DESKTOP || (SCREEN_WIDTH < 600) && SB_TYPE_MOBILE || SB_TYPE_TABLET,

        CLIENT_ID,

        BOUCLAIR_USER_ID = '596f3de34e768eb800bd6cda',
        TEST_BETA_USER_ID = '55e9af1c12d62f7f00cf936f',

        _eventHandlers = {},

        storagePrefixes = {
            closed_: 'closed_',
            clicked_: 'clicked_',
            showTime_: 'showTime_',
            showVersionTime_: 'showVersionTime_',
            isShowing_: 'isShowing_',
            allSpentTime_: 'allSpentTime_',
            readed_event_: 'readed_event_',
            countShowsLB_: 'countShowsLB_',
            lastSpentTime_: 'lastSpentTime_',
            show_referrer_: 'show_referrer_',
            except_referrer_: 'except_referrer_',
            selectedVersion_: 'selectedVersion_',
            adoric_lb_combination: 'adoric_lb_combination',
        },

        cookieItems = {
            adoric_user: 'adoric_user',
            adoric_goals: 'adoric_goals',
            adoric_uniq_day_id: 'adoric_uniq_day_id',
            adoric_popup: 'adoric_popup'
        },

        localStorageItems = {
            tabs_open: 'tabs_open',
            time_closed: 'time_closed',
            session_data: 'session_data',
            adoric_visitors: 'adoric_visitors',
            adoric_client_id: 'adoric_client_id',
            adoric_buyer_info: 'adoric_buyer_info',
            adoric_events_obj: 'adoric_events_obj',
            adoric_saw_lightbox: 'adoric_saw_lightbox',
            adoric_user_behavior: 'adoric_user_behavior',
            adoric_control_group: 'adoric_control_group',
            adoric_url_conditions: 'adoric_url_conditions',
            adoric_show_lightboxes: 'adoric_show_lightboxes',
            adoric_query_conditions: 'adoric_query_conditions',
            adoric_uniq_day_id: 'adoric_uniq_day_id'
        },

        sessionStorageItems = {
            showed: 'showed',
            isLanding: 'isLanding',
            adoric_channel: 'adoric_channel',
            adoric_ip_info: 'adoric_ip_info',
            countReachingPage: 'countReachingPage',
            adoric_new_session: 'adoric_new_session',
            country_code_cache: 'country_code_cache',
            adoric_referrer_url: 'adoric_referrer_url',
            adoric_session_events: 'adoric_session_events',
        },
        //don't touch values in any reason! clients use it as is!
        OWN_EVENTS = {
            versionSelectedBasedOnEventConditions: 'versionSelectedBasedOnEventConditions',
            animateCssBeforeLoad: 'animateCss:before:load',
            animateCssAfterLoad: 'animateCss:after:load',
            locationBeforeDetect: 'location:before:detect',
            locationAfterDetect: 'location:after:detect',
            emptyLb: 'lightbox:empltyLb',
            versionSelected: 'version:selected',
            lbBeforeInit: 'lightbox:before:init',
            lbInitError: 'lightbox:init:error',
            lbAfterInit: 'lightbox:after:init',
            lbNoLoad: 'lightboxes:no:load',
            lbBeforeLoad: 'lightboxes:before:load',
            lbAfterLoad: 'lightboxes:after:load',
            infoReady: 'info:ready',
            fontsBeforeLoad: 'fonts:before:load',
            fontsAfterLoad: 'fonts:after:load',
            linkBeforeClick: 'link:before:click',
            linkAfterClick: 'link:after:click',
            formBeforeSubmit: 'form:before:submit',
            formAfterSubmit: 'form:after:submit',
            lbBeforeShow: 'lightbox:before:show',
            lbAfterShow: 'lightbox:after:show',
            lbBeforeClose: 'lightbox:before:close',
            lbAfterClose: 'lightbox:after:close',
            lbAfterCLick: 'lightbox:after:click',
            lbBeforeClick: 'lightbox:before:click',
            setDynamicLink: 'setDynamicLink',
            setDynamicVars: 'setDynamicVars',
            setConfig: 'setConfig',
            clearAllowedShow: 'clearAllowedShow',
            eventBeforeTrigger: 'event:before:trigger',
            eventAfterTrigger: 'event:after:trigger'
        },

        compareChecker = {
            '>': function (getElementValue, compareValue) {
                return parseInt(getElementValue) > parseInt(compareValue);
            },
            '<': function (getElementValue, compareValue) {
                return parseInt(getElementValue) < parseInt(compareValue);
            },
            '==': function (getElementValue, compareValue) {
                return parseInt(getElementValue) == parseInt(compareValue);
            },
            '<>': function (getElementValue, compareValue, compareValueBetween) {
                return (parseInt(compareValue) <= parseInt(getElementValue)) && (parseInt(compareValueBetween) >= parseInt(getElementValue));
            }
        },

        checkerGoalDestination = {
            '0': function (location, value) {
                return location && location.startsWith(value)
            },
            '1': function (location, value) {
                return location && location.endsWith(value)
            },
            '2': function (location, value) {
                return location && ~location.indexOf(value)
            },
            '3': function (location, value) {
                return location && (location == value)
            }
        },

        OWN_EVENTS_ARR = Object.keys(OWN_EVENTS).map(function (eventIndex) {
            return OWN_EVENTS[eventIndex];
        }),

        MOUSE_EVENT = {
            click: 'click',
            hover: 'hover',
            mousemove: 'mousemove',
            touchstart: 'touchstart'
        },

        currentInitedCount = 0,
        currentGoals = [],
        currentLift,
        currentUserId,
        currentPlanId,
        currentDomain,
        currentPlanType,
        showAdoricBranding,
        currentPlanLimits,
        currentInitError,
        currentExposure,
        currentCountry,
        currentSessionId,
        currentLanguage,
        refreshProcessing = {
            running: false,
            location: null
        },

        console = window.console || {
            log: function () {},
            warn: function () {},
            error: function () {}
        },

        currentConfig = {
            isVisible: true,
            debugMode: location.href.indexOf('adoricDebugMode=true') !== -1,
            loadedFonts: {},
            excludeEvents: [],
            analytics: false
        };
    /**
     * @polyfill
     * @method Array.prototype.some
     */
    if (typeof Prototype !== 'undefined') {
        Array.prototype.some = function (fun) {
            'use strict';

            if (this === null) {
                throw new TypeError('Array.prototype.some called on null or undefined');
            }

            if (typeof fun !== 'function') {
                throw new TypeError();
            }

            var t = Object(this);
            var len = t.length >>> 0;

            var thisArg = arguments.length >= 2 ? arguments[1] : void 0;
            for (var i = 0; i < len; i++) {
                if (i in t && fun.call(thisArg, t[i], i, t)) {
                    return true;
                }
            }

            return false;
        };

        Array.prototype.every = function (callbackfn, thisArg) {
            'use strict';
            var T, k;

            if (this == null) {
                throw new TypeError('this is null or not defined');
            }
            var O = Object(this);
            var len = O.length >>> 0;

            if (typeof callbackfn !== 'function') {
                throw new TypeError();
            }

            if (arguments.length > 1) {
                T = thisArg;
            }

            k = 0;

            while (k < len) {

                var kValue;

                if (k in O) {
                    kValue = O[k];
                    var testResult = callbackfn.call(T, kValue, k, O);

                    if (!testResult) {
                        return false;
                    }
                }
                k++;
            }
            return true;
        };
    }

    /**
     * @polyfill
     * @method Array.prototype.startsWith
     */
    if (!String.prototype.startsWith) {
        Object.defineProperty(String.prototype, 'startsWith', {
            enumerable: false,
            configurable: false,
            writable: false,
            value: function (searchString, position) {
                position = position || 0;
                return this.lastIndexOf(searchString, position) === position;
            }
        });
    }

    /**
     * @polyfill
     * @method Array.prototype.endsWith
     */
    if (!String.prototype.endsWith) {
        Object.defineProperty(String.prototype, 'endsWith', {
            value: function (searchString, position) {
                var subjectString = this.toString();
                if (position === undefined || position > subjectString.length) {
                    position = subjectString.length;
                }
                position -= searchString.length;
                var lastIndex = subjectString.indexOf(searchString, position);
                return lastIndex !== -1 && lastIndex === position;
            }
        });
    }

    var EventEmitter = {
        /**
         * Bind subscriber to event
         * @param {String|Object} eventName To which event you want subscribe
         * @param {Function} handler Your handler
         * @return {EventEmitter}
         */
        on: function (eventName, handler) {
            var eventHandlers = this.eventHandlers = this.eventHandlers || {};

            if (typeof eventName === 'object') {
                for (var property in eventName) {
                    if (eventName.hasOwnProperty(property)) {
                        this.on(property, eventName[property]);
                    }
                }
            } else {
                if (!eventHandlers[eventName]) {
                    eventHandlers[eventName] = [];
                }

                eventHandlers[eventName].push(handler);
            }

            return this;
        },

        /**
         * Unbind subscriber from event
         * @param  {String|Object} eventType From which event you want unsubscribe
         * @param  {Function} handler Your handler
         * @return {EventEmitter}
         */
        off: function (eventType, handler) {
            var eventHandlers = this.eventHandlers || {},
                index = -1;

            if (typeof eventType === 'object') {
                for (var property in eventType) {
                    if (eventType.hasOwnProperty(property)) {
                        this.off(property, eventType[property]);
                    }
                }
            } else {
                if (eventHandlers[eventType]) {
                    index = eventHandlers[eventType].indexOf(handler);
                    if (index !== -1) {
                        eventHandlers[eventType].splice(index, 1);
                    }
                }
            }

            return this;
        },

        /**
         * Triggers event to broadcast
         * @param {Object} context Context of this in event handlers
         * @param  {String} eventName What type of event need to trigger
         * @return {EventEmitter}
         */
        trigger: function () {
            var context = arguments[0];
            var eventName = arguments[1];
            var ownArgsCount = 2;
            var eventHandlers;
            var args;

            if (typeof context === 'string') {
                ownArgsCount = 1;
                eventName = arguments[0];
                context = this;
            }
            args = Array.prototype.slice.call(arguments, ownArgsCount);
            eventHandlers = this.eventHandlers && this.eventHandlers[eventName];
            if (currentConfig.debugMode) {
                console.log(Util.getExactTime(),
                    '_Adoric DEBUG_ triggered event: \'' + eventName + '\', ' +
                    'handlers:', eventHandlers,
                    'args:', args,
                    'context:', context);
            }
            if (!~[OWN_EVENTS.eventBeforeTrigger, OWN_EVENTS.eventAfterTrigger].indexOf(eventName)) {
                this.trigger.apply(this, [].concat(this, OWN_EVENTS.eventBeforeTrigger, eventName, args));
            }
            if (eventHandlers) {
                for (var i = eventHandlers.length - 1; i >= 0; i--) {
                    if (typeof eventHandlers[i] == 'function') {
                        eventHandlers[i].apply(context, args);
                    }
                }
            }
            if (!~[OWN_EVENTS.eventBeforeTrigger, OWN_EVENTS.eventAfterTrigger].indexOf(eventName)) {
                this.trigger.apply(this, [].concat(this, OWN_EVENTS.eventAfterTrigger, eventName, args));
            }

            return this;
        }
    };

    var Conditions = (function () {
        var OR = 0;
        var AND = 1;
        var OR_NOT = 2;
        var AND_NOT = 3;
        var compare = {};

        compare[OR] = function (event1, event2) {
            currentConfig.debugMode && console.log('compare[OR]', arguments);

            return Math.max(event1, event2);

        };
        compare[AND] = function (event1, event2) {
            currentConfig.debugMode && console.log('compare[AND]', arguments);

            return Math.min(event1, event2);
        };
        compare[OR_NOT] = function (event1, event2) {
            currentConfig.debugMode && console.log('compare[OR_NOT]', arguments);

            return event1 || +!event2;

        };
        compare[AND_NOT] = function (event1, event2) {
            currentConfig.debugMode && console.log('compare[AND_NOT]', arguments);

            return event1 && +!event2;
        };

        function stringifyEventName(event) {
            return event.join ? event.join(':') : event;
        }

        function checkCondition(conditionArray, triggeredEvents) {
            var eventName;
            var result = 0;

            if (conditionArray && conditionArray.length) {
                eventName = stringifyEventName(conditionArray[0]);
                result = triggeredEvents[eventName] && triggeredEvents[eventName][TRACKED_EVENT_TIME] || 0;
                for (var i = 1; i < conditionArray.length; i += 2) {
                    eventName = stringifyEventName(conditionArray[i + 1]);
                    result = compare[conditionArray[i]](result, triggeredEvents[eventName] && triggeredEvents[eventName][TRACKED_EVENT_TIME] || 0);
                }
            }

            return result;
        }

        function checkConditions(conditions) {
            var triggeredEvents = Util.trackedEvents();
            var result = 0;

            if (Object.keys(triggeredEvents).length && conditions[0] && conditions[0].length) {
                result = checkCondition(conditions[0], triggeredEvents);
                for (var c = 1; c < conditions.length; c += 2) {
                    result = compare[conditions[c]](result, checkCondition(conditions[c + 1], triggeredEvents));
                }
            }

            return result;
        }

        function checkCancelEvents(events) {
            var triggeredEvents = Util.trackedEvents();
            var result = 0;

            if (Object.keys(triggeredEvents).length && events) {
                events.forEach(function (event) {
                    result = Math.max(result, triggeredEvents[event.value] && triggeredEvents[event.value][TRACKED_EVENT_TIME] || 0);
                });
            }

            return result;
        }

        function getEventsList(conditions) {
            var list = [];
            var i, j;

            for (i = 0; i < conditions.length; i += 2) {
                for (j = 0; j < conditions[i].length; j += 2) {
                    list[list.length] = stringifyEventName(conditions[i][j]);
                }
            }

            return list;
        }

        return {
            OR: OR,
            AND: AND,
            OR_NOT: OR_NOT,
            AND_NOT: AND_NOT,
            checkConditions: checkConditions,
            checkCancelEvents: checkCancelEvents,
            getEventsList: getEventsList
        }
    })();

    function filterEnabled(item) {
        return item.enabled;
    }

    /*CREATE GLOBAL STORAGE IF STORAGE IS DISABLED*/
    function isLocalStorageOn() {
        if (typeof localStorage === 'object') {
            try {
                localStorage.setItem('localStorage', 1);
                localStorage.removeItem('localStorage');
                return true;
            } catch (e) {
                console.error("_Adoric_error: " + e);
                return false;
            }
        } else {
            return false;
        }
    }

    function isSessionStorageOn() {
        if (typeof sessionStorage === 'object') {
            try {
                sessionStorage.setItem('sessionStorage', 1);
                sessionStorage.removeItem('sessionStorage');
                return true;
            } catch (e) {
                console.error("_Adoric_error: " + e);
                return false;
            }
        } else {
            return false;
        }
    }

    if (!isLocalStorageOn()) {
        window._localStorage = {};
        window.localStorage.__proto__.setItem = function (id, val) {
            return window._localStorage[id] = String(val);
        };
        window.localStorage.__proto__.getItem = function (id) {
            return window._localStorage.hasOwnProperty(id) ? window._localStorage[id] : undefined;
        };
        window.localStorage.__proto__.removeItem = function (id) {
            return delete window._localStorage[id];
        };
        window.localStorage.__proto__.clear = function () {
            return window._localStorage = {};
        };
    }

    if (!isSessionStorageOn()) {
        window._sessionStorage = {};
        window.sessionStorage.__proto__.setItem = function (id, val) {
            return window._sessionStorage[id] = String(val);
        };
        window.sessionStorage.__proto__.getItem = function (id) {
            return window._sessionStorage.hasOwnProperty(id) ? window._sessionStorage[id] : undefined;
        };
        window.sessionStorage.__proto__.removeItem = function (id) {
            return delete window._sessionStorage[id];
        };
        window.sessionStorage.__proto__.clear = function () {
            return window._sessionStorage = {};
        };
    }
    /*END CREATE GLOBAL STORAGE IF STORAGE IS DISABLED*/

    function bindEvent(element, type, handler, intercept) {
        if (!(element in _eventHandlers)) {
            _eventHandlers[element] = {
                element: element
            };
        }
        if (!(type in _eventHandlers[element])) {
            _eventHandlers[element][type] = [];
        }

        _eventHandlers[element][type].push([handler, intercept]);

        if (element.addEventListener) {
            element.addEventListener(type, handler, intercept || false);
        } else {
            element.attachEvent('on' + type, handler);
        }
    }

    function unbindEvents(element, type) {
        if (element in _eventHandlers) {
            var handlers = _eventHandlers[element];

            if (type in handlers) {
                var eventHandlers = handlers[type];

                for (var i = eventHandlers.length; i--;) {
                    var handler = eventHandlers[i];

                    if (element.removeEventListener) {
                        element.removeEventListener(type, handler[0], handler[1]);
                    } else {
                        element.detachEvent('on' + type, handler[0]);
                    }
                }
            }
        }
    }

    function unbindEvent(element, type, handler, intercept) {
        if (element.removeEventListener) {
            element.removeEventListener(type, handler, intercept || false);
        } else {
            element.detachEvent('on' + type, handler);
        }
    }

    function preventDefault(e) {
        e = e || window.event;
        e.preventDefault && e.preventDefault();
        e.returnValue = false;
    }

    /**
     * Helper object
     */
    var Util = {
        getExactTime: function () {
            var time = new Date(),
                milliseconds = (time.getMilliseconds() / 1000).toFixed(3).slice(1),
                result;

            result = time.toLocaleTimeString().split(' ');
            if (result.length > 1) {
                result = result.join(milliseconds + ' ');
            } else {
                result = result.pop() + milliseconds;
            }

            return result;
        },

        serializeForm: function (form) {
            var result = {
                merge_vars: {},
                optin: form.getAttribute('data-optin'),
                send_welcome: form.getAttribute('data-send_welcome')
            };

            Array.prototype.forEach.call(form.elements, function (element) {
                var input = element.nodeName === "FIELDSET" ? (element.querySelector('input') || element.querySelector('select')) : element,
                    attrDataTag = input.getAttribute('data-tag'),
                    attrName = input.getAttribute('name'),
                    attrType = input.getAttribute('type');

                if (attrDataTag) {
                    result.merge_vars[attrDataTag] = attrName;
                }
                if (input.nodeName === 'textarea') {
                    result[attrName] = input.value;
                } else {
                    if (attrType === 'checkbox') {
                        result[attrName] = input.checked;
                    } else if (attrType === 'radio') {
                        if (input.checked) {
                            result[attrName] = input.value;
                        }
                    } else if (attrType !== 'submit') {
                        result[attrName] = input.value;
                    }
                }
            });

            result.referrer = Util.sessionStorageData(sessionStorageItems.adoric_referrer_url) || '';
            result.country = Util.sessionStorageData(sessionStorageItems.country_code_cache) || '';
            result.merge_vars = JSON.stringify(result.merge_vars);

            return result;
        },

        serializeListForm: function (form) {
            var result = {
                subscribe: {}
            };

            Array.prototype.forEach.call(form.elements, function (element) {
                var input = element.nodeName === "FIELDSET" ? (element.querySelector('input') || element.querySelector('select')) : element,
                    attrName = input.getAttribute('name'),
                    nodeName = input.nodeName.toLowerCase(),
                    attrType = input.getAttribute('type');

                if (attrName && nodeName === 'textarea') {
                    result.subscribe[attrName] = input.value;
                } else {
                    if (attrType === 'checkbox') {
                        result.subscribe[attrName] = input.checked;
                    } else if (attrType === 'radio') {
                        if (input.checked) {
                            result.subscribe[attrName] = input.value;
                        }
                    } else if (attrType !== 'submit') {
                        result.subscribe[attrName] = input.value;
                    }
                }
            });

            result.referrer = Util.sessionStorageData(sessionStorageItems.adoric_referrer_url) || '';
            result.country = Util.sessionStorageData(sessionStorageItems.country_code_cache) || '';

            return result;
        },
        /**
         * Get parsed object with adoric.js parameters
         * @return {Object}
         */
        parseScriptParameters: function () {
            var script = ADORIC_SCRIPT;
            var dataKey = script.getAttribute('data-key');

            return dataKey ? {
                key: dataKey
            } : Util.parseQueryURL(script.src.replace(/^[^\?]+\??/, ''));
        },

        /**
         * Load external css-file
         * @param url Where css file is located
         * @param className class name which were added to link
         * @param callback Function which execute on loading finished
         */
        loadExternalStyle: function (url, className, callback) {
            callback = (typeof callback === 'function') ? callback : function () {};

            function createElem(url, callback) {
                Element('link').attribute({
                    'class': className,
                    rel: 'stylesheet',
                    type: 'text/css',
                    href: url,
                    media: 'none',
                    onload: callback,
                    onerror: callback
                }).appendToHead();
            }

            if (typeof url === 'string') {
                createElem(url, callback);
            }
        },

        /**
         * Load external js-file
         * @param url Where js file is located
         * @param callback Function which execute on loading finished
         */
        loadExternalScript: function (url, callback) {
            callback = (typeof callback === 'function') ? callback : function () {};

            function createElem(url, callback) {
                Element('script').attribute({
                    'class': ADORIC_IDENTIFIER,
                    type: 'text/javascript',
                    src: url,
                    onload: callback,
                    onerror: callback
                }).appendToHead();
            }

            if (typeof url === 'string') {
                createElem(url, callback);
            }
        },

        /**
         * Generate param url from object
         * @param params Object with parameters which need decode
         * @param url If provide then concat url with ? and param url
         * @returns Query string
         */
        generateQueryURL: function (params, url) {
            var queryString = '',
                key,
                value;

            url = url ? url : '';

            for (key in params) {
                if (params.hasOwnProperty(key)) {
                    value = params[key];
                    typeof value === 'object' && (value = JSON.stringify(value));
                    if (queryString.length) {
                        queryString += '&';
                    }
                    queryString += encodeURIComponent(key) + '=' + encodeURIComponent(value);
                }
            }

            if (url.length && url.indexOf('?') == -1) {
                url += '?';
            }

            return url + queryString;
        },

        /**
         * Parse paramURL and return object
         * @param queryURL URL with decode parameters
         * @returns object with key=value
         */
        parseQueryURL: function (queryURL) {
            var vars = queryURL.split('&'),
                result = {},
                pair,
                i;

            for (i = 0; i < vars.length; i++) {
                pair = vars[i].split('=');
                result[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
            }

            return result;
        },

        queryString: function queryString(location) {
            var queryString = {};
            var query = location.split("?")[1];
            var vars = query && query.split("&") || [];

            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");

                if (typeof queryString[pair[0]] === "undefined") {
                    queryString[pair[0]] = decodeURIComponent(pair[1]);
                } else if (typeof queryString[pair[0]] === "string") {
                    queryString[pair[0]] = [queryString[pair[0]], decodeURIComponent(pair[1])];
                } else {
                    queryString[pair[0]].push(decodeURIComponent(pair[1]));
                }
            }

            return queryString;
        },

        /**
         * Make AJAX-request
         * @param _url URL to which need make request
         * @param _method Which of method need to use (GET, POST, PUT, DELETE)
         * @param _params Object with POST params for request
         * @param _callback Function which will execute on success
         * @returns false if something went wrong in callback function
         */
        ajax: function (_url, _method, _params, _callback) {
            var createCORSRequest = function (method, url) {
                var xhr = new XMLHttpRequest();

                if (document.documentMode < 10 && typeof XDomainRequest !== 'undefined') {
                    xhr = new XDomainRequest();
                    xhr.open(method, url);
                } else if ("withCredentials" in xhr) {
                    xhr.open(method, url, true);
                } else {
                    xhr = null;
                }

                return xhr;
            };

            var response,
                url = typeof _url === 'string' ? _url : '',
                method = typeof _method === 'string' ? _method : GET_METHOD,
                params = typeof _params === 'object' ? _params : {},
                callback = typeof _callback === 'function' ? _callback : function () {};

            if (arguments.length === 2) {
                if (typeof arguments[0] === 'string' && typeof arguments[1] === 'object') {
                    method = POST_METHOD;
                    params = arguments[1];
                    //URL + PARAMS
                } else if (typeof arguments[0] === 'string' && typeof arguments[1] === 'function') {
                    //URL + CALLBACK
                    callback = arguments[1];
                }
            } else if (arguments.length === 3) {
                if (typeof arguments[0] === 'string' && typeof arguments[1] === 'string' && typeof arguments[2] === 'function') {
                    //URL + METHOD + CALLBACK
                    callback = arguments[2];
                } else if (typeof arguments[0] === 'string' && typeof arguments[1] === 'object' && typeof arguments[2] === 'function') {
                    //URL + PARAMS + CALLBACK
                    method = POST_METHOD;
                    params = arguments[1];
                    callback = arguments[2];
                }
            }

            var xmlHttp;

            if (method === GET_METHOD) {
                url = Util.generateQueryURL(params, url);
            } else if (method === POST_METHOD) {
                params = JSON.stringify(params)
            } else if (method === PUT_METHOD) {
                params = JSON.stringify(params);
            }

            try {
                xmlHttp = createCORSRequest(method, url);
            } catch (error) {
                console.error("_Adoric_error:" + error);
                callback(false);
                return false;
            }

            // xmlHttp.setRequestHeader('Content-Type', 'application/json');
            xmlHttp.onreadystatechange = function () {
                if (xmlHttp.readyState === 4) {
                    try {
                        response = JSON.parse(xmlHttp.responseText);
                    } catch (e) {
                        response = xmlHttp.responseText;
                    }
                    callback(response, xmlHttp);
                }
            };

            if (method === GET_METHOD) {
                xmlHttp.send();
            } else {
                xmlHttp.send(params);
            }
        },

        /**
         * Get size of client area in browser
         * @returns Object with width and height properties
         */
        getScreenSize: function () {
            return {
                width: window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth,
                height: window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight
            };
        },

        /**
         * get UTC day's end time
         *
         * @returns {number}
         */
        geDayEnd: function () {
            var d = new Date();
            var res = d.getTime();

            res += (23 - d.getHours()) * 60 * 60 * 1000;
            res += (59 - d.getMinutes()) * 60 * 1000;
            res += (59 - d.getSeconds()) * 1000;
            res += 999 - d.getMilliseconds();

            return res;
        },

        /**
         * @param hour
         * @return {String}
         */
        getPartOfDay: function (hour) {
            if (hour >= 0 && hour < 6) {
                return 'N'; //night
            } else if (hour >= 6 && hour < 11) {
                return 'M'; //morning
            } else if (hour >= 11 && hour < 18) {
                return 'A'; // afternoon
            } else {
                return 'E'; //evening
            }
        },

        getCookie: function getCookie(cookieName) {
            var name = cookieName + "=",
                cookiesArray = document.cookie.split(';'),
                cookie;

            for (var i = 0; i < cookiesArray.length; i++) {
                cookie = cookiesArray[i];
                while (cookie.charAt(0) == ' ') {
                    cookie = cookie.substring(1);
                }
                if (cookie.indexOf(name) == 0) {
                    return decodeURIComponent(cookie.substring(name.length, cookie.length));
                }
            }

            return "";
        },

        setCookie: function setCookie(cname, cvalue, expire) {
            var date = new Date(expire);
            var expires = "expires=" + date.toUTCString();
            typeof cvalue === 'string' || (cvalue = encodeURIComponent(JSON.stringify(cvalue)));
            document.cookie = cname + "=" + cvalue + "; " + expires;
        },

        assign: function (_target, _source) {
            var target = _target || {};
            var source = _source || {};
            var keys = Object.keys(source);

            for (var i = 0; i < keys.length; i++) {
                target[keys[i]] = source[keys[i]];
            }

            return target;
        },

        sessionStorageData: function (key, val) {
            if (typeof val !== 'undefined') {
                return sessionStorage.setItem(key, val);
            } else if (key) {
                return sessionStorage.getItem(key) || 0
            } else {
                return sessionStorage;
            }
        },

        localStorageData: function (key, val) {
            if (typeof val !== 'undefined') {
                return localStorage.setItem(key, val);
            } else if (key) {
                return localStorage.getItem(key) || 0
            } else {
                return localStorage;
            }
        },

        checkIsUrlInSettings: function (settings, testUrl) {
            var inExceptSubUrl = false,
                inSpecificSubUrl = false,
                exceptSubUrl = '',
                specificSubUrl = '',
                exceptUrl,
                specificUrl,
                i;

            if (testUrl.slice(-1) == "#") {
                testUrl = testUrl.slice(0, -1);
            }

            for (i = 0; i < settings.exceptUrl.length; i++) {
                if (!settings.exceptUrl[i].enabled) {
                    continue;
                }
                exceptUrl = settings.exceptUrl[i].value;
                if (exceptUrl == testUrl) {
                    return false;
                }
                if (exceptUrl.slice(-1) == "*" && testUrl.indexOf(exceptUrl.slice(0, -1)) == 0) {
                    return false;
                    // if need to show specific url in except url:
                    //inExceptSubUrl = true;
                    //exceptSubUrl = exceptSubUrl.length > exceptUrl.length ? exceptSubUrl : exceptUrl;
                }
            }

            for (i = 0; i < settings.specificUrl.length; i++) {
                if (!settings.specificUrl[i].enabled) {
                    continue;
                }
                specificUrl = settings.specificUrl[i].value;
                if (specificUrl == testUrl) {
                    return true;
                }
                if (specificUrl.slice(-1) == "*" && testUrl.indexOf(specificUrl.slice(0, -1)) == 0) {
                    if (!inExceptSubUrl) {
                        return true;
                    }
                    inSpecificSubUrl = true;
                    specificSubUrl = specificSubUrl.length > specificUrl.length ? specificSubUrl : specificUrl;
                }
            }

            if (inExceptSubUrl) {
                return (inSpecificSubUrl && specificSubUrl.length > exceptSubUrl.length);
            }

            return inSpecificSubUrl;
        },

        runScript: function runScript(elem) {
            data = (elem.text || elem.textContent || elem.innerHTML || "");

            var head = document.getElementsByTagName("head")[0] || document.documentElement,
                script = document.createElement("script");
            script.type = "text/javascript";

            if (elem.src) script.src = elem.src;
            if (elem.id) script.id = elem.id;

            script.appendChild(document.createTextNode(data));
            head.insertBefore(script, head.firstChild);

            if (!elem.src) {
                head.removeChild(script);
            }
            if (elem.parentNode) {
                elem.parentNode.removeChild(elem);
            }
        },

        onDocumentReady: function onDocumentReady(callback) {
            function waitBody() {
                if (document.body) {
                    callback();
                } else {
                    setTimeout(waitBody, 1);
                }
            }

            if (["interactive", "loaded", "complete"].indexOf(document.readyState) !== -1) {
                waitBody();
            } else {
                bindEvent.call(document, document, "DOMContentLoaded", waitBody, false);
            }
        },

        isTabFocused: (function getCheckFocusFunction() {
            var VISIBILITY_API_PREFIXES = ['hidden', 'mozHidden', 'msHidden', 'webkitHidden'];
            var hidden = null;

            for (var i = 0; i < VISIBILITY_API_PREFIXES.length; i++) {
                if (typeof document[VISIBILITY_API_PREFIXES[i]] !== 'undefined') {
                    hidden = VISIBILITY_API_PREFIXES[i];
                    break;
                }
            }

            // if Page Visibility API works
            if (hidden) {
                // if document.hasFocus() works too, for better results use them together
                if (document.hasFocus) {
                    if (!document[hidden] && !document.hasFocus() && (typeof window.focus === 'function')) {
                        window.focus();
                    }
                    return function () {
                        return document.hasFocus() && !document[hidden];
                    };
                } else {
                    return function () {
                        return !document[hidden];
                    };
                }
            } else if (document.hasFocus) {

                // if document.hasFocus() works
                if (typeof window.focus === 'function') {
                    window.focus();
                }

                return function () {
                    return document.hasFocus();
                };
            } else {

                //other browsers
                var lastFocusState = true;
                var onFocus = function onFocus() {
                    lastFocusState = true;
                };
                var onBlur = function onBlur() {
                    if (!document.activeElement instanceof HTMLIFrameElement) {
                        lastFocusState = false;
                    }
                };

                if ( /*@cc_on!@*/ false) { // check for Internet Explorer
                    bindEvent(document, 'focusin', onFocus, true);
                    bindEvent(document, 'focusout', onBlur, true);
                } else {
                    bindEvent(window, 'focus', onFocus, true);
                    bindEvent(window, 'blur', onBlur, true);
                }

                return function () {
                    return lastFocusState;
                }
            }
        })(),

        saveReferrerURL: function saveReferrerURL() {
            if (Util.sessionStorageData(sessionStorageItems.adoric_referrer_url)) return;

            var query = Util.queryString(window.location.href);
            var checkUTM = Object.keys(query).some(function (key) {
                return ~key.indexOf('utm_')
            });

            if (checkUTM) {
                Util.sessionStorageData(sessionStorageItems.adoric_referrer_url, decodeURIComponent(window.location.href));
            } else if (document.referrer) {
                Util.sessionStorageData(sessionStorageItems.adoric_referrer_url, document.referrer);
            }
        },

        bindEvent: bindEvent,

        unbindEvent: unbindEvent,

        getAllShowedLB: function getAllShowedLB() {
            var localStorage = Util.localStorageData();
            var result = {};
            var withAdoric = '';

            for (var key in localStorage) {
                if (localStorage.hasOwnProperty(key) && key.indexOf(storagePrefixes.showTime_) !== -1) {
                    withAdoric = true;
                    result[key.slice(storagePrefixes.showTime_.length)] = localStorage[key];
                }
            }

            return {
                withAdoric: withAdoric,
                showedLbs: result
            };
        },

        optimizeEventSettings: function optimizeEventSettings(events) {
            return events.map(function (event) {
                return event.value;
            });
        },

        optimizeHardcodedEventSettings: function optimizeHardcodedEventSettings(events) {
            return events.map(function (event) {
                return [event.subName, event.status];
            });
        },

        optimized2conditions: function optimized2conditions(events) {
            var newEvents = new Array(events.length * 2 - 1);

            events.forEach(function (event, i) {
                newEvents[i * 2] = event;
                i && (newEvents[i * 2 - 1] = Conditions.OR);
            });

            return [newEvents];
        },

        actualizeEventSettings: function actualizeEventSettings(eventsSettings) {
            if (!Array.isArray(eventsSettings)) {
                eventsSettings = [];
            } else if (!Array.isArray(eventsSettings[0])) {
                eventsSettings = eventsSettings.filter(filterEnabled);
                if (eventsSettings.length) {
                    eventsSettings = eventsSettings[0].subName ?
                        Util.optimizeHardcodedEventSettings(eventsSettings) :
                        Util.optimizeEventSettings(eventsSettings);

                    eventsSettings = Util.optimized2conditions(eventsSettings);
                    currentConfig.debugMode && console.log('settings is actualized', eventsSettings);
                } else {
                    currentConfig.debugMode && console.log('settings is empty');
                }
            } else {
                currentConfig.debugMode && console.log('settings is actual', eventsSettings);
            }

            return eventsSettings;
        },


        /**
         * get tracked events
         *
         *
         * format example
         * {
         *   event: [lastTrackTime, trackCount, sumValue],
         *   otherEvent: -|-  - - ,
         *   -|-|_\|-
         * }
         *
         * @returns {*}
         */
        getTrackedEvents: function getTrackedEvents() {
            var events = Util.localStorageData(localStorageItems.adoric_events_obj);
            events = events ? JSON.parse(events) : {};
            var keys = Object.keys(events);
            //migrate old format
            keys.forEach(function (key) {
                if (!Array.isArray(events[key])) {
                    events[key] = [events[key], 0, 0];
                }
            });
            return events;
        },

        setTrackedEvents: function setTrackedEvents(events) {
            return Util.localStorageData(localStorageItems.adoric_events_obj, JSON.stringify(events));
        },

        trackedEvents: function trackedEvents(events) {
            return events ? Util.setTrackedEvents(events) : Util.getTrackedEvents();
        },

        saveEvent: function saveEvent(name, value) {
            var events = Util.trackedEvents();
            var prevCount = 0;
            var prevVal = 0;

            if (events[name]) {
                prevCount = events[name][TRACKED_EVENT_COUNT];
                prevVal = events[name][TRACKED_EVENT_VALUE];
            }
            events[name] = [
                Date.now(),
                1 + prevCount, +value + prevVal
            ];

            return Util.trackedEvents(events);
        },

        /**
         * @param {Number} value
         * @description buyerInfo -> [[day, count, value],[day, count, value]...]
         */
        saveBuyerInfo: function (value) {
            value = value || 0;

            var today = new Date().setHours(0, 0, 0, 0);
            var buyerInfo = JSON.parse(Util.localStorageData(localStorageItems.adoric_buyer_info) || '{}');

            if (!buyerInfo[today]) {
                buyerInfo[today] = [1, value];
            } else {
                buyerInfo[today] = [++buyerInfo[today][0], buyerInfo[today][1] + value];
            }

            !buyerInfo['tVal'] ? buyerInfo['tVal'] = value : buyerInfo['tVal'] += value;
            !buyerInfo['tCount'] ? buyerInfo['tCount'] = 1 : ++buyerInfo['tCount'];


            Util.localStorageData(localStorageItems.adoric_buyer_info, JSON.stringify(buyerInfo))
        },

        /**
         * Remove events from local storage
         *
         * @example1: remove some event
         * adoric.removeEvents('userProfile:registered:true');
         *
         * @example2: remove some events
         * adoric.removeEvents('userProfile:registered:true, userProfile:subscribed:false');
         *
         * @example3: remove all events
         * adoric.removeEvents({all: true});
         *
         * @param eventName {Object} or {String} with events to remove
         * @returns true if some event was removed;
         */
        removeEvents: function (eventName) {
            var adoricEvents = Util.trackedEvents();

            if (!adoricEvents) {
                currentConfig.debugMode && console.log('no events to remove');
                return false;
            } else {
                if (typeof eventName === 'object' && eventName.all === true) {
                    currentConfig.debugMode && console.log('removing all events!');
                    Util.trackedEvents({});
                } else {
                    ('' + eventName).split(',').forEach(function (name) {
                        name = name.trim();
                        currentConfig.debugMode && console.log('delete event', name);
                        delete adoricEvents[name];
                    });
                    Util.trackedEvents(adoricEvents);
                }

                return true;
            }
        },

        getBrowserName: function () {
            var winNav = window.navigator || navigator;
            var navUserAgent = winNav.userAgent;
            var isOpera = ((!!window.opr && !!window.opr.addons) || (navUserAgent.indexOf(' OPR/') >= 0) || (!!~navUserAgent.indexOf('Opera')) || (navUserAgent.indexOf('Opera Mini') > -1)) ? 'opera' : false;
            var isFirefox = (navUserAgent.toLowerCase().indexOf('firefox') > -1) ? 'firefox' : false;
            var isSafari = ((navUserAgent.indexOf('Safari') !== -1 && navUserAgent.indexOf('Chrome') === -1) && (!!navUserAgent.match(/Version\/[\d\.]+.*Safari/))) ? 'safari' : false;
            var isIE = (navUserAgent.indexOf('MSIE ') > 0 || navUserAgent.indexOf('Trident/') > 0) ? 'ie' : false;
            var isEdge = (!isIE && (!!window.StyleMedia || /Edge\//gi.test(navUserAgent))) ? 'edge' : false;
            var isChrome = ((window.chrome !== null && window.chrome !== undefined && winNav.vendor === "Google Inc." && isOpera === false && isEdge === false) || (navUserAgent.match("CriOS"))) ? 'chrome' : false;

            return isOpera || isFirefox || isSafari || isIE || isEdge || isChrome || 'notIdentified';
        },

        getOSName: function () {
            var OSName = false,
                fullName = false,
                winNav = window.navigator || navigator,
                navUserAgent = (winNav.userAgent || winNav.vendor || window.opera),
                navAppVersion = winNav.appVersion;

            /* desktop */
            if (~navAppVersion.indexOf("Win")) OSName = "win", fullName = "Windows";
            if (~navAppVersion.indexOf("Mac")) OSName = "mac", fullName = "Macintosh";
            if (/X11|Linux/gmi.test(navAppVersion)) OSName = "unix", fullName = "Unix";
            if (/\bCrOS\b/.test(navUserAgent)) OSName = "chromeos", fullName = "Unix";
            /* tablet, mobile */
            if (navUserAgent.match(/Android/i)) OSName = "android", fullName = "Android";
            if (navUserAgent.match(/iPhone|iPad|iPod/i)) OSName = "ios", fullName = "iOS";
            if (navUserAgent.match(/BlackBerry/i)) OSName = "blackberry", fullName = "Blackberry";
            if ((!!~navUserAgent.toLowerCase().indexOf("windows phone")) || (!!~navUserAgent.toLowerCase().indexOf("windows nt") && !!~navUserAgent.toLowerCase().indexOf("touch"))) OSName = "winphone", fullName = "Windows Phone";

            return {
                os: OSName,
                osFullName: fullName
            };
        },

        saveVisitors: function () {
            var newArray = [];
            var timeVisit = Date.now();
            var adoricVisitors = JSON.parse(Util.localStorageData(localStorageItems.adoric_visitors));

            if (typeof adoricVisitors !== 'object') {
                adoricVisitors = [];
            }

            if (!Util.sessionStorageData(sessionStorageItems.adoric_new_session)) {
                if (adoricVisitors) {
                    adoricVisitors.push(timeVisit);
                    Util.localStorageData(localStorageItems.adoric_visitors, JSON.stringify(adoricVisitors));
                } else {
                    newArray.push(timeVisit);
                    Util.localStorageData(localStorageItems.adoric_visitors, JSON.stringify(newArray));
                }
            }

            if (!Util.sessionStorageData(sessionStorageItems.adoric_new_session)) {
                Util.sessionStorageData(sessionStorageItems.adoric_new_session, true);

                adoricVisitors = JSON.parse(Util.localStorageData(localStorageItems.adoric_visitors));

                /*drop old data*/
                function lessThanMonth(value) {
                    var date = new Date(timeVisit);
                    var monthAgo = date.setDate(date.getDate() - 30);

                    return value >= monthAgo;
                }

                var filteredVisitors = adoricVisitors && adoricVisitors.filter(lessThanMonth);

                Util.localStorageData(localStorageItems.adoric_visitors, JSON.stringify(filteredVisitors));
                /*end drop old data*/
            }
        },

        saveURLConditions: function () {
            var location = window.location.href;
            var queries = Util.parseQueryURL(location);
            var parseUrl = JSON.parse(Util.localStorageData(localStorageItems.adoric_url_conditions) || '{}');
            var parseQuery = JSON.parse(Util.localStorageData(localStorageItems.adoric_query_conditions) || '{}');

            parseUrl[location] = this.getURLConditions() + 1;
            Util.localStorageData(localStorageItems.adoric_url_conditions, JSON.stringify(parseUrl));

            for (var key in queries) {
                if (queries[key] !== 'undefined') {
                    parseQuery[queries[key]] = this.getQueryConditions(queries[key]) + 1;
                }
            }
            Util.localStorageData(localStorageItems.adoric_query_conditions, JSON.stringify(parseQuery));

            return this;
        },

        getURLConditions: function () {
            var parseUrl = JSON.parse(Util.localStorageData(localStorageItems.adoric_url_conditions));

            return parseUrl[window.location.href] || 0;
        },

        getQueryConditions: function (query) {
            var parseQuery = JSON.parse(Util.localStorageData(localStorageItems.adoric_query_conditions));

            return parseQuery[query] || 0;
        },

        createID: function () {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        },

        getClientID: function () {
            var clientID = Util.localStorageData(localStorageItems.adoric_client_id);

            if (!clientID) {
                clientID = Util.createID();
                Util.localStorageData(localStorageItems.adoric_client_id, clientID);
            }

            return clientID;
        },

        checkChannels: function (referrer, LOCATION) {
            var adoricChannel = Util.sessionStorageData(sessionStorageItems.adoric_channel);
            if (adoricChannel) return JSON.parse(adoricChannel);

            //continue if session storage not have key 'adoric_channel'
            var query = Util.queryString(LOCATION);
            var checkUTM = Object.keys(query).some(function (key) {
                return ~key.indexOf('utm_')
            });
            var channel;
            var hostname = '/';
            var pathname = '/';
            var EMAIL = 'email';
            var PAID = 'paid';
            var SOCIAL = 'social';
            var ORGANIC = 'organic';
            var REFERRAL = 'referral';
            var DIRECT = 'direct';
            var OTHER = 'other';
            var UTM_MEDIUM = query['utm_medium'];

            if (checkUTM && UTM_MEDIUM) {
                if (PAID_TYPE_REG_EXP.test(UTM_MEDIUM)) { //is paid
                    channel = PAID
                } else if (~UTM_MEDIUM.indexOf(EMAIL)) { //is email
                    channel = EMAIL
                } else if (SOCIAL_NAMES_NETWORKS_REG_EXP.test(UTM_MEDIUM)) { //is social
                    channel = SOCIAL
                } else if (SEARCH_NAMES_SYSTEMS_REG_EXP.test(UTM_MEDIUM)) { //is organic
                    channel = ORGANIC
                } else {
                    channel = OTHER
                }
                hostname = query['utm_source'] || 'not identified';
            } else if (referrer) {
                var a = document.createElement('a');
                a.href = decodeURIComponent(referrer);

                if (SEARCH_SYSTEMS_REG_EXP.test(referrer)) { //is organic
                    channel = ORGANIC;
                } else if (SOCIAL_NETWORKS_REG_EXP.test(referrer)) { //is social
                    channel = SOCIAL;
                } else {
                    channel = REFERRAL;
                }

                hostname = a.hostname;
                pathname = a.pathname;
            } else {
                channel = DIRECT;
                hostname = window.location.hostname;
                pathname = window.location.pathname;
            }
            var data = {
                channel: channel,
                hostname: hostname,
                pathname: pathname
            };

            Util.sessionStorageData(sessionStorageItems.adoric_channel, JSON.stringify(data));

            return data;
        },

        /**
         * Save count reaching user page
         * return {Object}
         */
        countReachingPage: function countReachingPage() {
            Util.sessionStorageData(sessionStorageItems.countReachingPage, Util.getCountReachingPage() + 1);

            return this;
        },

        /**
         * Get count reaching user page
         * @return {Number}
         */
        getCountReachingPage: function getCountReachingPage() {
            return +Util.sessionStorageData(sessionStorageItems.countReachingPage);
        },

        /**
         * Save count tabs reaching user
         * return {Object}
         */
        countTabs: function countTabs() {
            var timeClosed = +Util.localStorageData(localStorageItems.time_closed);
            var today = Date.now();

            function tabInit() {
                var adoricStorage = Util.localStorageData();

                for (var key in adoricStorage) {
                    if (adoricStorage.hasOwnProperty(key) && key.indexOf(storagePrefixes.countShowsLB_) !== -1) {
                        Util.localStorageData(key, 0);
                    }
                }

                Util.localStorageData(localStorageItems.tabs_open, 1);
                Util.localStorageData(localStorageItems.session_data, 0);
                Util.localStorageData(localStorageItems.time_closed, today);
            }

            function getOpenTabs() {
                return +Util.localStorageData(localStorageItems.tabs_open);
            }

            function tabOpened() {
                Util.localStorageData(localStorageItems.tabs_open, getOpenTabs() + 1);
            }

            function tabClosed() {
                if (getOpenTabs()) {
                    Util.localStorageData(localStorageItems.tabs_open, getOpenTabs() - 1);
                }
                Util.localStorageData(localStorageItems.time_closed, Date.now());
            }

            if (!getOpenTabs() && (today - timeClosed) > 60000) {
                tabInit();
            } else {
                tabOpened();
            }

            bindEvent.call(window, window, 'beforeunload', tabClosed);

            return this;
        },

        removeIsShowingItems: function () {
            var i = Util.sessionStorageData().length;

            while (i--) {
                var key = Util.sessionStorageData().key(i);

                if (/isShowing_/.test(key)) {
                    Util.sessionStorageData().removeItem(key);
                }
            }

            return this;
        },

        styleFilesHandler: function styleFilesHandler(event) {
            // @context {DOM} this - is dom link element

            // async load styles
            this.setAttribute('media', 'all');

            ADORIC_STYLES_LOADED = event.type === EVENT_TYPE_LOAD
        }

        //@todo: write Util.parseJSON() method to correct getting objects
        //@todo: (and replace native JSON parse in whole adoric.js)
    };

    /**
     * Goals functionality module
     */
    var Goals = (function () {
        /**
         * checks is the goal destination reached
         *
         * @param goal
         * @returns {*}
         */
        var checkGoalType = {
            '0': function (destination) { //Check URL
                return checkerGoalDestination[destination.matchingType](decodeURIComponent(window.location.href), decodeURIComponent(destination.value));
            },
            '1': function (destination) { //Check query
                var query = Util.queryString(decodeURIComponent(window.location.search));
                var needTrack;

                for (var key in query) {
                    if (query[key] !== 'undefined') {
                        needTrack = checkerGoalDestination[destination.matchingType](query[key], destination.value);
                        if (needTrack) {
                            break;
                        }
                    }
                }

                return needTrack;
            },
            '2': function (destination, event) { //Check event
                if (!event) return false;

                return (destination.value === event.name);
            }
        };

        /**
         * save's step in adoric API
         * @important! Param goalId is required!
         *
         * @param data
         * @param cb callback to call after track (ajax request)
         */
        function trackGoals(data, cb) {
            var showedLbData = Util.getAllShowedLB();
            var browser = Util.getBrowserName();
            var referrer = Util.sessionStorageData(sessionStorageItems.adoric_referrer_url) || '';
            var sawLightbox = Util.localStorageData(localStorageItems.adoric_saw_lightbox) || '';
            var channels = Util.checkChannels(referrer, window.location.href);
            var newVisitor = JSON.parse(Util.localStorageData(localStorageItems.adoric_visitors) || '[]').length <= 1;
            var goalsCookie = JSON.parse(Util.getCookie(cookieItems.adoric_goals) || '[]');
            var goalsCookieChanged = false;

            typeof cb !== 'function' && (cb = function () {});

            Util.setCookie(cookieItems.adoric_goals, goalsCookie, Util.geDayEnd());

            var params = {
                country: currentCountry,
                language: currentLanguage,
                userId: currentUserId,
                planType: currentPlanType,
                planId: currentPlanId,
                domainId: currentDomain._id,
                isVisible: currentConfig.isVisible,
                referrer: channels.channel,
                pathname: channels.pathname,
                hostname: channels.hostname,
                newVisitor: newVisitor || '',
                userAgent: navigator["userAgent"],
                platform: navigator["platform"],
                os: Util.getOSName().os,
                browser: browser,
                device: DEVICE_TYPE,
                withAdoric: LiftTest.isNeedShow() || '',
                controlGroup: LiftTest.isControlGroup() || '',
                showedLbs: showedLbData.showedLbs,
                clientId: CLIENT_ID,
                liftId: currentLift && currentLift._id || '',
                sawLightbox: sawLightbox
            };

            for (var name in data)
                if (data.hasOwnProperty(name)) {
                    params[name] = data[name];
                }
            //@TODO: README! don't replace it up! last param can contain '#' at the end! @IMPORTANT!
            params.location = window.location.href;

            params.goals.forEach(function (goal) {
                if (!~goalsCookie.indexOf(goal.id)) {
                    goal.new = true;
                    goalsCookie.push(goal.id);
                    goalsCookieChanged = true;
                }
            });
            goalsCookieChanged && Util.setCookie(cookieItems.adoric_goals, goalsCookie, Util.geDayEnd());

            Util.ajax(TRACK_GOAL_API_URL, GET_METHOD, params, cb);
        }

        function getCombinations() {
            var localStorage = Util.localStorageData();
            var combinations = {};
            var sortable = [];

            for (var key in localStorage) {
                if (localStorage.hasOwnProperty(key) && key.indexOf(storagePrefixes.showVersionTime_) !== -1) {
                    combinations[key.slice(storagePrefixes.showVersionTime_.length)] = localStorage[key];
                }
            }

            for (var index in combinations) {
                sortable.push([index, combinations[index]]);
            }

            // sort by time showed
            sortable.sort(function (a, b) {
                return a[1] - b[1];
            });

            // get last 10 versions
            sortable = sortable.slice(-10);

            // return string versions ids
            return sortable.map(function (item) {
                return item[0];
            }).join(',');
        }

        /**
         * Checks each current goal
         */
        function checkGoals(type, event) {
            if (!currentGoals || !currentGoals.length) return;
            var goalsData;

            /**
             * collects data about goals completions
             * @type {Array} of {Objects}
             *
             * @format
             * [{
             *    id: goalId,
             *    dest: goalCompleted
             *    val: goalValue
             *    combinations: {String}
             * },
             * ...]
             */
            goalsData = currentGoals.filter(function (goal) {
                return goal.destination.type === type && checkGoalType[type](goal.destination, event);
            }).map(function (goal) {
                return {
                    id: goal._id,
                    dest: true,
                    val: (event && event.value) || goal.value,
                    combinations: getCombinations()
                };
            });

            if (goalsData.length) {
                trackGoals({
                    goals: goalsData
                });
            }
        }

        function checkUrl() {
            checkGoals(0)
        }

        function checkQuery() {
            checkGoals(1)
        }

        function checkEvent(event) {
            checkGoals(2, event)
        }

        function trackUser() {
            if (!Util.getCookie(cookieItems.adoric_user)) {
                var eCommerceGoal = {
                    id: currentUserId,
                    domainVisit: true
                };
                trackGoals({
                    goals: [eCommerceGoal]
                }, function (data) {
                    if (data.ids && data.ids[0]) {
                        Util.localStorageData(localStorageItems.adoric_uniq_day_id, data.ids[0]);
                        Util.setCookie(cookieItems.adoric_uniq_day_id, data.ids[0]);
                    }
                });
                Util.setCookie(cookieItems.adoric_user, '1', Util.geDayEnd());
            }
        }

        function trackECommerceGoal(event) {
            var eCommerceGoal = {
                id: currentUserId,
                dest: true,
                value: event.value || 0,
                name: event.name,
                eCommerce: true,
                combinations: getCombinations()
            };

            trackGoals({
                goals: [eCommerceGoal]
            });
        }

        return {
            checkUrl: checkUrl,
            checkQuery: checkQuery,
            checkEvent: checkEvent,
            trackECommerceGoal: trackECommerceGoal,
            trackUser: trackUser
        };
    })();

    /**
     * Lift testing modeule
     * @type {}
     */
    var LiftTest = (function () {
        var TEST_STATES = [, 'WITH_ADORIC', 'WITHOUT_ADORIC', 'SKIP_LIFT'];
        TEST_STATES[''] = 'GROUP_NOT_DEFINED';
        var GROUP_NOT_DEFINED = '';
        var SHOW_LIGHTBOXES_FLAG = true;
        var WITH_ADORIC = '1';
        var WITHOUT_ADORIC = '2';
        var SKIP_LIFT = '3';
        var random = Math.random() * 100;

        var _controlGroup = Util.localStorageData(localStorageItems.adoric_control_group);
        var _withAdoricFlag = JSON.parse(Util.localStorageData(localStorageItems.adoric_show_lightboxes));
        var _lift;

        function changeControlGroup(group) {
            _controlGroup = group;
            Util.localStorageData(localStorageItems.adoric_control_group, group);
        }

        function setWithAdoric(flag) {
            _withAdoricFlag = flag;
            Util.localStorageData(localStorageItems.adoric_show_lightboxes, flag);
        }

        function defineToGroup() {
            var weight = +_lift.weight;

            if (weight > 50) {
                //75: 0 |--------50skip--------|--25without--|--25with--| 100
                if (random < weight && random > (weight - (100 - weight))) {
                    //show LBs
                    changeControlGroup(WITH_ADORIC);
                    setWithAdoric(SHOW_LIGHTBOXES_FLAG)
                } else if (random > weight) {
                    //don't show LBs
                    changeControlGroup(WITHOUT_ADORIC);
                    setWithAdoric(!SHOW_LIGHTBOXES_FLAG)
                } else {
                    //show LBs
                    changeControlGroup(SKIP_LIFT);
                    setWithAdoric(SHOW_LIGHTBOXES_FLAG)
                }
            } else if (weight < 50) {
                //30: 0 |--30with--|--30without--|--------40skip--------| 100
                if (random < weight) {
                    //show LBs
                    changeControlGroup(WITH_ADORIC);
                    setWithAdoric(SHOW_LIGHTBOXES_FLAG)
                } else if (random > weight && (random < (weight * 2))) {
                    //don't show LBs
                    changeControlGroup(WITHOUT_ADORIC);
                    setWithAdoric(!SHOW_LIGHTBOXES_FLAG)
                } else {
                    //don't show LBs
                    changeControlGroup(SKIP_LIFT);
                    setWithAdoric(!SHOW_LIGHTBOXES_FLAG)
                }
            } else {
                // 50: 50|50
                if (random < weight) {
                    //show LBs
                    changeControlGroup(WITH_ADORIC);
                    setWithAdoric(SHOW_LIGHTBOXES_FLAG)
                } else {
                    //don't show LBs
                    changeControlGroup(WITHOUT_ADORIC);
                    setWithAdoric(!SHOW_LIGHTBOXES_FLAG)
                }
            }
        }

        function run(lift) {
            _lift = lift;

            if (_lift && Object.keys(_lift).length) {
                if (!~[WITH_ADORIC, WITHOUT_ADORIC, SKIP_LIFT].indexOf(_controlGroup)) {
                    defineToGroup()
                }
            } else if (_controlGroup !== GROUP_NOT_DEFINED) {
                changeControlGroup(GROUP_NOT_DEFINED);
            }

            return this;
        }

        function isControlGroup() {
            return _controlGroup !== SKIP_LIFT;
        }

        function isNeedShow() {
            return _controlGroup ? _withAdoricFlag == SHOW_LIGHTBOXES_FLAG : SHOW_LIGHTBOXES_FLAG
        }

        return {
            run: run,
            isControlGroup: isControlGroup,
            isNeedShow: isNeedShow
        }
    })();

    /**
     * polyfill. (some don't work with Prototype.js)
     * methods:
     * - filter
     * - @todo: some,
     */
    if (typeof Prototype === 'undefined') {
        Util.filter = function (arr, cb) {
            return arr.filter(cb);
        };
    } else {
        Array.prototype.filterPolyfill = function (fun) {
            if (this === void 0 || this === null) {
                throw new TypeError();
            }

            var t = Object(this);
            var len = t.length >>> 0;

            if (typeof fun !== 'function') {
                throw new TypeError();
            }

            var res = [];
            var thisArg = arguments.length >= 2 ? arguments[1] : void 0;

            for (var i = 0; i < len; i++) {
                if (i in t) {
                    var val = t[i];

                    if (fun.call(thisArg, val, i, t)) {
                        res.push(val);
                    }
                }
            }

            return res;
        };

        Util.filter = function (arr, cb) {
            return arr.filterPolyfill(cb);
        };
    }

    /**
     * tracking events to Google Analytics
     * @param - type GA
     */
    var AdoricTracking = {
        type: "GA",
        state: "loading",
        verbose: true,
        queue: []
    };

    AdoricTracking.send = function (c, a, l, v) {
        ga('send', 'event', c, a, l, v, {
            nonInteraction: true
        });
    }

    AdoricTracking.sendEvent = function (category, action, label, value) {
        if (AdoricTracking.state === "loading") {
            AdoricTracking.queue.push({
                category: category,
                action: action,
                label: label,
                value: value
            });
        } else {
            AdoricTracking.send(category, action, label, value);
        }
    };

    AdoricTracking.init = function (currentDomain) {
        if (window.ga && ga.create) {
            if (currentDomain.gaTracker) {
                try {
                    ga('create', currentDomain.gaTracker, 'auto');
                    AdoricTracking.state = "ready";
                } catch (e) {
                    AdoricTracking.state = "error";
                }
            } else {
                ga(function (tracker) {
                    try {
                        if (typeof (tracker) === "undefined") {
                            tracker = ga.getAll()[0];

                            if (tracker) {
                                ga('create', tracker.get("trackingId"), 'auto');
                            }
                        }
                        AdoricTracking.state = "ready";
                    } catch (e) {
                        AdoricTracking.state = "error";
                    }
                });
            }
        } else {
            AdoricTracking.state = "error";
            AdoricTracking.type = "NA";
        }
    };

    var scrollModule = (function () {
        // left: 37, up: 38, right: 39, down: 40,
        // spacebar: 32, pageup: 33, pagedown: 34, end: 35, home: 36
        var scrollKeys = {
                32: 1,
                33: 1,
                34: 1,
                35: 1,
                36: 1,
                37: 1,
                38: 1,
                39: 1,
                40: 1
            },
            oldWindowOnwheel = null,
            oldWindowOnmousewheel = null,
            oldWindowOntouchmove = null,
            oldDocumentOnkeydown = null;

        function preventDefaultForScrollKeys(e) {
            var _target = e.target || e.currentTarget || e.srcElement;

            if (scrollKeys[e.keyCode] && _target.nodeName !== 'INPUT') {
                preventDefault(e);
                return false;
            }
        }

        function disableScroll() {
            bindEvent(window, 'DOMMouseScroll', preventDefault, false);

            oldWindowOnwheel = window.onwheel;
            oldWindowOnmousewheel = window.onmousewheel || document.onmousewheel;
            oldWindowOntouchmove = window.ontouchmove;
            oldDocumentOnkeydown = document.onkeydown;

            window.onwheel = preventDefault; // modern standard
            window.onmousewheel = document.onmousewheel = preventDefault; // older browsers, IE
            window.ontouchmove = preventDefault; // mobile
            document.onkeydown = preventDefaultForScrollKeys;
        }

        function enableScroll() {
            unbindEvent(window, 'DOMMouseScroll', preventDefault, false);

            window.onmousewheel = document.onmousewheel = oldWindowOnmousewheel;
            window.onwheel = oldWindowOnwheel;
            window.ontouchmove = oldWindowOntouchmove;
            document.onkeydown = oldDocumentOnkeydown;
        }


        /**
         * callback on scrolled
         * from top to value (px or %)
         * @param value
         * @param enums
         * @param callback
         */
        function callbackOnScrollToPosition(value, enums, callback) {
            var scrolledPx = (window.pageYOffset || document.body.scrollTop || document.documentElement.scrollTop),
                body = document.body,
                pageHeight = Math.max(body.scrollHeight, body.offsetHeight, document.documentElement.clientHeight, document.documentElement.scrollHeight, document.documentElement.offsetHeight),
                windowHeight = window.innerHeight || document.documentElement.clientHeight;

            value = value || 0;
            enums = enums || 'pixel';

            if (enums == 'percent') {
                value = (value * (pageHeight - windowHeight)) / 100;
            }

            if (scrolledPx >= value) {
                callback();
            }
        }

        return {
            disableScroll: disableScroll,
            enableScroll: enableScroll,
            callbackOnScrollToPosition: callbackOnScrollToPosition
        }
    })();

    /**
     * Create new DOMElement or get existing
     * @param selector It's string with # (for get by id) . (for get by class) or tagName (for create new DOMElement)
     * Element('#foo', '.bar', 'div', 'div', document.createElement('div'));
     * @returns array of all elements
     */

    function Element() {
        //Force new
        if (!(this instanceof arguments.callee)) {
            var callee = arguments.callee,
                newClass = Object.create(callee.prototype);
            callee.apply(newClass, Element.arguments);
            return newClass;
        }

        var element,
            argIteration,
            elemIteration;

        this.elements = [];

        for (argIteration = 0; argIteration < arguments.length; argIteration++) {
            element = arguments[argIteration];
            if (typeof element === 'string') {
                if (element.indexOf('#') === 0) {
                    //Get element by id and push into array
                    element = element.replace('#', '');
                    element = document.getElementById(element);
                    this.elements.push(element);
                } else if (element.indexOf('.') === 0) {
                    //Get all classNames and push into array
                    element = element.replace('.', '');
                    element = document.getElementsByClassName(element);
                    for (elemIteration = 0; elemIteration < element.length; elemIteration++) {
                        this.elements.push(element[elemIteration]);
                    }
                } else if (element.indexOf('&') === 0) {
                    element = element.replace('&', '');
                    element = document.getElementsByTagName(element);
                    for (elemIteration = 0; elemIteration < element.length; elemIteration++) {
                        this.elements.push(element[elemIteration]);
                    }
                } else if (element !== '') {
                    //Create new element and push into array
                    element = document.createElement(element);
                    this.elements.push(element);
                }
            } else if (typeof element === 'object') {
                this.elements.push(element);
            }
        }

        return this;
    }

    Element.prototype = {
        /**
         * Get or set css rules for element
         * css('position');
         * css({
            position: 'absolute'
         });
         * css('position', 'absolute');
         */
        css: function (key, value) {

            function getStyle(element, key) {
                if (window.getComputedStyle) {
                    return window.getComputedStyle(element, null)[key];
                } else {
                    return element.style[key];
                }
            }

            function setStyle(element, key, value) {
                if (element && element.style) {
                    element.style[key] = value;
                }
            }

            var self = this,
                result = [],
                valueIterator,
                i;

            if (arguments.length === 1) {
                //If need get css-rule
                if (typeof key === 'string') {
                    if (self.elements.length === 1) {
                        result = getStyle(self.elements[0], key);
                    } else {
                        for (i = 0; i < self.elements.length; i++) {
                            result.push(getStyle(self.elements[i], key));
                        }
                    }

                    return result;
                } else if (typeof key === 'object') {
                    for (valueIterator in key) {
                        if (key.hasOwnProperty(valueIterator)) {
                            for (i = 0; i < self.elements.length; i++) {
                                setStyle(self.elements[i], valueIterator, key[valueIterator]);
                            }
                        }
                    }
                }
            } else if (arguments.length === 2) {
                //If need set css-rule
                if (typeof key === 'string' && typeof value === 'string') {
                    for (i = self.elements.length - 1; i >= 0; i--) {
                        setStyle(self.elements[i], key, value);
                    }
                }
            }

            return this;
        },
        /**
         * Append CSS class to object
         * @param className Name of class
         * addClass('test test2');
         */
        addClass: function (className) {
            var self = this,
                newClassName = '',
                existsClassName = '',
                i;

            for (i = self.elements.length - 1; i >= 0; i--) {
                existsClassName = self.elements[i].className;
                if (existsClassName === '') {
                    newClassName = className;
                } else {
                    newClassName = existsClassName.trim() + ' ' + className;
                }
                self.elements[i].className = newClassName;
            }

            return this;
        },

        /**
         * Find element like by jQuery
         * @param selector
         * Element().find('div');
         */
        find: function (selector) {
            var element,
                k;

            this.elements = [];

            for (var i = 0; i < arguments.length; i++) {
                element = arguments[i];
                if (typeof element === 'string') {
                    if ((element.indexOf('#') === 0) || (element.indexOf('.') === 0)) {
                        element = document.querySelectorAll(element);
                        for (k = 0; k < element.length; k++) {
                            this.elements.push(element[k]);
                        }
                    } else if (element !== '') {
                        if (/id="([\w-]+)"/i.test(element)) {
                            var id = /id="([\w-]+)"/i.exec(element)[1];

                            element = document.getElementById(id);
                            if (element) this.elements.push(element);
                        } else if (/class="([\w-]+)"/i.test(element)) {
                            var className = /class="([\w-]+)"/i.exec(element)[1];

                            element = document.getElementsByClassName(className);
                            for (k = 0; k < element.length; k++) {
                                if (element[k]) this.elements.push(element[k]);
                            }
                        } else if (/<(\w)/i.test(element)) {
                            var tag = /<(\w)/i.exec(element)[1];

                            element = document.getElementsByTagName(tag);
                            for (k = 0; k < element.length; k++) {
                                if (element[k]) this.elements.push(element[k]);
                            }
                        } else {
                            element = document.getElementsByTagName(element);
                            for (k = 0; k < element.length; k++) {
                                if (element[k]) this.elements.push(element[k]);
                            }
                        }
                    }
                }
            }

            return this;
        },

        /**
         * Remove className from elements
         * @param className className which need remove
         * removeClass('test test2');
         */
        removeClass: function (className) {
            var self = this,
                existsClassName,
                i, k;

            for (i = self.elements.length - 1; i >= 0; i--) {
                existsClassName = self.elements[i].className.split(' ');
                for (k = existsClassName.length - 1; k >= 0; k--) {
                    if (existsClassName[k] == className) {
                        existsClassName[k] = '';
                    }
                }
                self.elements[i].className = existsClassName.join(' ');
            }

            return this;
        },

        /**
         * Get or set attribute for elements
         * attribute('value');
         * attribute('value', 'someValue');
         * attribute({
            value: 'someValue'
         })
         */
        attribute: function (key, value) {
            var self = this,
                result = [];

            if (arguments.length === 1) {
                if (typeof key === 'string') {
                    if (self.elements.length === 1) {
                        result = self.elements[0].getAttribute(key);
                    } else {
                        for (var i = 0; i < self.elements.length; i++) {
                            result.push(self.elements[i].getAttribute(key));
                        }
                    }

                    return result;
                } else if (typeof key === 'object') {
                    for (var j = self.elements.length - 1; j >= 0; j--) {
                        for (var elem in key) {
                            if (key.hasOwnProperty(elem)) {
                                if (typeof key[elem] === 'string') {
                                    self.elements[j].setAttribute(elem, key[elem]);
                                } else if (typeof key[elem] === 'function') {
                                    self.elements[j][elem] = key[elem];
                                }
                            }
                        }
                    }
                }
            } else if (arguments.length === 2) {
                for (var k = self.elements.length - 1; k >= 0; k--) {
                    self.elements[k].setAttribute(key, value);
                }
            }

            return this;
        },

        /**
         * Set HTML for elements
         * Element('.foo').html('test foo');
         */
        html: function (html) {
            var self = this,
                result = [];

            if (typeof html !== 'undefined') {
                for (var i = self.elements.length - 1; i >= 0; i--) {
                    self.elements[i].innerHTML = html;
                }
            } else {
                if (self.elements.length === 1) {
                    return self.elements[0].innerHTML;
                } else {
                    for (var j = 0; j < self.elements.length; j++) {
                        result.push(self.elements[j].innerHTML);
                    }
                    return result;
                }
            }

            return this;
        },

        /**
         * Get width of elements
         * Element('.foo').width();
         */
        width: function () {
            var self = this,
                result = [];

            if (self.elements.length === 1) {
                return self.elements[0].offsetWidth;
            } else {
                for (var i = 0; i < self.elements.length; i++) {
                    result.push(self.elements[i].offsetWidth);
                }

                return result;
            }
        },

        /**
         * Get height of elements
         * Element('.foo').height();
         */
        height: function () {
            var self = this,
                result = [];

            if (self.elements.length === 1) {
                return self.elements[0].offsetHeight;
            } else {
                for (var i = self.elements.length - 1; i >= 0; i--) {
                    result.push(self.elements[i].offsetHeight);
                }

                return result;
            }
        },

        /**
         * Bind callback for event for elements
         * Element('.foo').on('click', function() {});
         */
        on: function (type, handler) {
            var self = this,
                events = [],
                element;

            for (var i = self.elements.length - 1; i >= 0; i--) {
                element = self.elements[i];
                events = type.split(' ');
                for (var k = events.length - 1; k >= 0; k--) {
                    Util.bindEvent(element, events[k], handler);
                }
            }

            return this;
        },

        /**
         * Execute callback when animation on elements will finished
         * Element('.foo').onAnimationEnd(function() {})
         */
        onAnimationEnd: function (callback) {
            this.on('animationend webkitAnimationEnd MSAnimationEnd oAnimationEnd', callback);
        },

        /**
         * Unbind callback for event for elements
         * Element('.foo').off('click', function() {});
         */
        off: function (type, handler) {
            var self = this,
                events = [],
                element;

            for (var i = self.elements.length - 1; i >= 0; i--) {
                element = self.elements[i];
                events = type.split(' ');
                for (var k = events.length - 1; k >= 0; k--) {
                    Util.unbindEvent(element, events[k], handler);
                }
            }

            return this;
        },

        filter: function (cb) {
            var newContext = Element();

            if (typeof cb === 'function') {
                if (typeof Prototype === 'undefined') {
                    newContext.elements = [].filter.call(this.elements, cb);
                } else {
                    Array.prototype.filterPolyfill = function (fun) {
                        if (this === void 0 || this === null) {
                            throw new TypeError();
                        }

                        var t = Object(this);
                        var len = t.length >>> 0;

                        if (typeof fun !== 'function') {
                            throw new TypeError();
                        }

                        var res = [];
                        var thisArg = arguments.length >= 2 ? arguments[1] : void 0;

                        for (var i = 0; i < len; i++) {
                            if (i in t) {
                                var val = t[i];

                                if (fun.call(thisArg, val, i, t)) {
                                    res.push(val);
                                }
                            }
                        }

                        return res;
                    };
                    newContext.elements = [].filterPolyfill.call(this.elements, cb);
                }

                return newContext;
            }
        },


        /**
         * Remove elements from DOM tree
         */
        remove: function () {
            var self = this;

            function useRemoveMethod() {
                if (self.elements[i].remove) {
                    try {
                        self.elements[i].remove();
                        return true;
                    } catch (error) {}
                }
                return false;
            }

            function useRemoveChildMethod() {
                if (self.elements[i].parentNode) {
                    try {
                        self.elements[i].parentNode.removeChild(self.elements[i]);
                        return true;
                    } catch (error) {}
                }
                return false;
            }

            for (var i = self.elements.length - 1; i >= 0; i--) {
                if (!useRemoveMethod() && !useRemoveChildMethod()) {
                    console.warn('_Adoric_ Remove element error, just hiding it');
                    this.css({
                        display: 'none'
                    });
                }
            }

            return this;
        },

        /**
         * Append elements to hea
         * Element('link').appendToHead();
         */
        appendToHead: function () {
            var self = this,
                head = document.getElementsByTagName('head')[0];

            for (var i = self.elements.length - 1; i >= 0; i--) {
                head.appendChild(self.elements[i]);
            }

            return this;
        },

        /**
         * Append elements to body
         * Element('div', 'div').appendToBody();
         */
        appendToBody: function () {
            var self = this,
                body = document.body;

            for (var i = self.elements.length - 1; i >= 0; i--) {
                body.appendChild(self.elements[i]);
            }

            return this;
        },

        /**
         * Append to element
         * Element('div', 'div').append([Element]);
         */
        append: function (element) {
            if (typeof element === 'object' && this.elements.length === 1) {
                this.elements[0].appendChild(element.getDOMElements());
            }

            return this;
        },

        /**
         * Get original DOMElements
         * Element('.foo').getDOMElements();
         */
        getDOMElements: function (index) {
            var self = this;

            if (typeof index !== 'undefined') {
                return self.elements[index];
            } else {
                if (self.elements.length === 1) {
                    return self.elements[0];
                } else {
                    return self.elements;
                }
            }
        }
    };

    /**
     * Generates original identifier for lightbox
     * @returns string
     */
    function genIdentifier() {
        window._lbCounter = window._lbCounter ? window._lbCounter + 1 : 1;
        return ADORIC_IDENTIFIER + window._lbCounter;
    }

    /**
     * Creating new Lightbox Object
     * @param options lightbox's options
     * @returns {Lightbox}
     * @constructor
     */

    function Lightbox(options) {
        //Force new
        if (!(this instanceof arguments.callee)) {
            var callee = arguments.callee,
                newClass = Object.create(callee.prototype);
            callee.apply(newClass, callee.arguments);
            return newClass;
        }

        var self = this;

        self.options = options;
        self.identifier = genIdentifier();
        self.sessionId = currentSessionId;
        self.loaded = false;
        self.showed = false;
        self.id = options.id || options._id;
        self.settings = options.settings;
        self.createHtml();

        if (self.settings.fontsLink) {
            var fontsLink = self.settings.fontsLink;
            var delimiterLink = '?family=';
            var delimiterFonts = '|';
            var linkPartsArray = fontsLink.split(delimiterLink);
            var fontsUrlPart = linkPartsArray[0];
            var fontsListArray = (linkPartsArray.length === 2) ? linkPartsArray[1].split(delimiterFonts) : false;

            adoric.trigger(this, OWN_EVENTS.fontsBeforeLoad, {
                lightbox: self,
                lightboxId: self.id,
                fontsLink: self.settings.fontsLink
            });

            function removeFromGoogleFontsLink(font) {
                var someRemoved = false;
                var leaveFontAlone;

                fontsListArray = fontsListArray
                    .filter(function (item) {
                        leaveFontAlone = (item.indexOf(font) === -1);
                        leaveFontAlone || (someRemoved = true);

                        return leaveFontAlone;
                    });
                fontsListArray.length || (fontsListArray = false);

                return someRemoved;
            }

            function checkUniqueFont(font, callback, identifier) {
                identifier || (identifier = font);
                // is some font left in array &&
                // is font was found (removed) from array &&
                // isn't font was already loaded
                if (fontsListArray && removeFromGoogleFontsLink(font) && !currentConfig.loadedFonts[identifier]) {
                    currentConfig.loadedFonts[identifier] = true;
                    callback();
                }
            }

            checkUniqueFont('Open+Sans+Hebrew+Condensed', function () {
                Util.loadExternalStyle('//fonts.googleapis.com/earlyaccess/opensanshebrewcondensed.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Open+Sans+Hebrew', function () {
                Util.loadExternalStyle(S3_URL + 'open-sans-hebrew-gf.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Spoiler', function () {
                Util.loadExternalStyle(S3_URL + 'spoiler-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Practica', function () {
                Util.loadExternalStyle(S3_URL + 'practica-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Bebas', function () {
                Util.loadExternalStyle(S3_URL + 'practica-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('FBtypopas', function () {
                Util.loadExternalStyle(S3_URL + 'sharon-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('FBapolo', function () {
                Util.loadExternalStyle(S3_URL + 'sharon-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Almoni', function () {
                Util.loadExternalStyle(S3_URL + 'almoni-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Stanga', function () {
                Util.loadExternalStyle(S3_URL + 'stanga-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Spoiler+Regular', function () {
                Util.loadExternalStyle(S3_URL + 'spoiler-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Spoiler+Light', function () {
                Util.loadExternalStyle(S3_URL + 'spoiler-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Spoiler+Black', function () {
                Util.loadExternalStyle(S3_URL + 'spoiler-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Spoiler+Bold', function () {
                Util.loadExternalStyle(S3_URL + 'spoiler-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Proxima+Nova+Soft+Bold', function () {
                Util.loadExternalStyle(S3_URL + 'proximanovasoft-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Proxima+Nova+Soft+Regular', function () {
                Util.loadExternalStyle(S3_URL + 'proximanovasoft-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Proxima+Nova+Soft+Medium', function () {
                Util.loadExternalStyle(S3_URL + 'proximanovasoft-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Proxima+Nova+Soft+Semibold', function () {
                Util.loadExternalStyle(S3_URL + 'proximanovasoft-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Noto+Sans+Hebrew', function () {
                Util.loadExternalStyle('//fonts.googleapis.com/earlyaccess/notosanshebrew.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('RotondaC+Bold', function () {
                Util.loadExternalStyle(S3_URL + 'rotonda-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('RotondaC+Regular', function () {
                Util.loadExternalStyle(S3_URL + 'rotonda-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Extaza+Regular', function () {
                Util.loadExternalStyle(S3_URL + 'extaza.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Extaza+Bold', function () {
                Util.loadExternalStyle(S3_URL + 'extaza.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Complet', function () {
                Util.loadExternalStyle(S3_URL + 'complet-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('September', function () {
                Util.loadExternalStyle(S3_URL + 'complet-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('888+Black', function () {
                Util.loadExternalStyle(S3_URL + 'casino-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('888+Bold', function () {
                Util.loadExternalStyle(S3_URL + 'casino-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('888+Regular', function () {
                Util.loadExternalStyle(S3_URL + 'casino-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('888+SemiBold', function () {
                Util.loadExternalStyle(S3_URL + 'casino-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('888+Thin', function () {
                Util.loadExternalStyle(S3_URL + 'casino-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            checkUniqueFont('Spacer', function () {
                Util.loadExternalStyle(S3_URL + 'spacer-fonts.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
            });
            if (currentUserId === BOUCLAIR_USER_ID || currentUserId === TEST_BETA_USER_ID) {
                checkUniqueFont('Moderat', function () {
                    Util.loadExternalStyle(S3_URL + 'Moderat.css', ADORIC_IDENTIFIER, Util.styleFilesHandler);
                });
            }
            //if google fonts remains
            if (fontsListArray) {
                fontsLink = [fontsUrlPart, fontsListArray.join(delimiterFonts)].join(delimiterLink);
                Util.loadExternalStyle(fontsLink, self.identifier, function (event) {
                    Util.styleFilesHandler.bind(this)(event);
                    self.loaded = true;
                    adoric.trigger(self, OWN_EVENTS.fontsAfterLoad, {
                        lightbox: self,
                        lightboxId: self.id,
                        response: this
                    });
                });
            } else {
                self.loaded = true;
            }
        } else {
            self.loaded = true;
        }

        return this;
    }

    Lightbox.prototype = {
        /**
         * @description timeout will works only for current session
         * @param callback
         * @param time
         * @return {number}
         */
        timeout: function timeout(callback, time) {
            var self = this;

            return setTimeout(function () {
                if (currentSessionId === self.sessionId) {
                    callback()
                }
            }, time);
        },
        getSettings: function getSettings(link) {
            var settings = this.settings;
            for (link = link.split('.'); settings !== undefined && link.length; settings = settings[link.shift()]);
            return settings;
        },
        createHtml: function createHtml() {
            var self = this;

            self.footer = Element('a')
                .addClass(self.identifier + ' ' + ADORIC_IDENTIFIER)
                .attribute({
                    target: '_blank',
                    href: 'https://adoric.com'
                })
                .css({
                    display: 'block',
                    position: 'fixed',
                    padding: '10px',
                    background: 'rgba(0, 0, 0, 0.9)',
                    zIndex: '5',
                    border: '0px',
                    borderRadius: '5px',
                    color: '#fff',
                    fontSize: '14px',
                    fontFamily: '"Open Sans", sans-serif',
                    bottom: '10px',
                    left: '10px',
                    textDecoration: 'none'
                })
                .html('Powered by Adoric');

            self.thankYouContent = Element('div')
                .addClass('closeThankYouMessage')
                .css({
                    position: 'fixed',
                    top: '0px',
                    left: '0px',
                    width: '100%',
                    height: '100%',
                    display: 'block',
                    background: 'rgba(0, 0, 0, 0.3)',
                    'padding': '0',
                    'text-align': 'center',
                    color: 'white',
                    'font-size': '26px',
                    opacity: '0',
                    '-webkit-transition': 'opacity 1s',
                    '-moz-transition': 'opacity 1s',
                    '-o-transition': 'opacity 1s',
                    transition: 'opacity 1s'
                });
            self.thankYouModal = Element('div')
                .css({
                    'zIndex': '9999999999',
                    'borderRadius': '4px',
                    'width': '90%',
                    'height': 'auto',
                    'max-width': '600px',
                    'min-height': '260px',
                    'position': 'fixed',
                    'top': '50%',
                    'right': '0',
                    'left': '0',
                    'margin-left': 'auto',
                    'margin-right': 'auto',
                    'textAlign': 'center',
                    'background': 'url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c3ZnIHdpZHRoPSIyNnB4IiBoZWlnaHQ9IjI2cHgiIHZpZXdCb3g9IjAgMCAyNiAyNiIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4gICAgICAgIDx0aXRsZT5Hcm91cDwvdGl0bGU+ICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPiAgICA8ZGVmcz48L2RlZnM+ICAgIDxnIGlkPSJQYWdlLTEiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPiAgICAgICAgPGcgaWQ9Ikdyb3VwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjAwMDAwMCwgMS4wMDAwMDApIiBmaWxsPSIjMzRBNDM5IiBmaWxsLXJ1bGU9Im5vbnplcm8iIHN0cm9rZT0iIzk3OTc5NyI+ICAgICAgICAgICAgPHBhdGggZD0iTTEyLDI0IEM1LjM4MjU0NTQ1LDI0IDAsMTguNjE3NDU0NSAwLDEyIEMwLDUuMzgyNTQ1NDUgNS4zODI1NDU0NSwwIDEyLDAgQzE4LjYxNzQ1NDUsMCAyNCw1LjM4MjU0NTQ1IDI0LDEyIEMyNCwxOC42MTc0NTQ1IDE4LjYxNzQ1NDUsMjQgMTIsMjQgWiBNMTIsMi4xODE4MTgxOCBDNi41ODY5MDkwOSwyLjE4MTgxODE4IDIuMTgxODE4MTgsNi41ODY5MDkwOSAyLjE4MTgxODE4LDEyIEMyLjE4MTgxODE4LDE3LjQxMzA5MDkgNi41ODY5MDkwOSwyMS44MTgxODE4IDEyLDIxLjgxODE4MTggQzE3LjQxMzA5MDksMjEuODE4MTgxOCAyMS44MTgxODE4LDE3LjQxMzA5MDkgMjEuODE4MTgxOCwxMiBDMjEuODE4MTgxOCw2LjU4NjkwOTA5IDE3LjQxMzA5MDksMi4xODE4MTgxOCAxMiwyLjE4MTgxODE4IFoiIGlkPSJTaGFwZSI+PC9wYXRoPiAgICAgICAgICAgIDxwYXRoIGQ9Ik05Ljc2NjQyNzEsMTYuODMyNzA3MiBDOS41NDQ1MTczMiwxNi44MzI3MDcyIDkuMzIyNjA3NTMsMTYuNzQ3NzU3NCA5LjE1MjcwNzg1LDE2LjU3OTU5MTMgTDUuNjg1MzY3NDUsMTMuMTEyMjUwOSBDNS4zNDczMDE3NiwxMi43NzQxODUzIDUuMzQ3MzAxNzYsMTIuMjI0NjExOCA1LjY4NTM2NzQ1LDExLjg4NjU0NjEgQzYuMDIzNDMzMTQsMTEuNTQ4NDgwNCA2LjU3MzAwNjU5LDExLjU0ODQ4MDQgNi45MTEwNzIyOCwxMS44ODY1NDYxIEw5Ljc2NDY5MzQzLDE0Ljc0MDE2NzMgTDE2LjA4NTY1NSw4LjQxOTIwNTcxIEMxNi40MjM3MjA3LDguMDgxMTQwMDIgMTYuOTczMjk0MSw4LjA4MTE0MDAyIDE3LjMxMTM1OTgsOC40MTkyMDU3MSBDMTcuNjQ5NDI1NSw4Ljc1NzI3MTQgMTcuNjQ5NDI1NSw5LjMwNjg0NDg1IDE3LjMxMTM1OTgsOS42NDQ5MTA1NCBMMTAuMzc2Njc5LDE2LjU3OTU5MTMgQzEwLjIxMDI0NjcsMTYuNzQ3NzU3NCA5Ljk4ODMzNjg5LDE2LjgzMjcwNzIgOS43NjY0MjcxLDE2LjgzMjcwNzIgWiIgaWQ9IlNoYXBlIj48L3BhdGg+ICAgICAgICA8L2c+ICAgIDwvZz48L3N2Zz4=) no-repeat center 40px / 58px auto #fff'
                });

            self.wrapper = Element('div').addClass(self.identifier + ' ' + ADORIC_IDENTIFIER);
            self.wrapperContent = null;
            self.background = Element('div').addClass(self.identifier + ' ' + ADORIC_IDENTIFIER);
            self.wrapper.html(self.options.html);
            if (self.getSettings('closeOnBackground.enabled')) {
                self.background.addClass(CLOSE_LIGHTBOX_CLASS);
            }
            if (self.getSettings('openEffect.enabled')) {
                self.wrapper.addClass('animated');
                self.wrapper.addClass(self.settings.openEffect.value);
                self.wrapper.onAnimationEnd(function onAnimationEnd() {
                    self.wrapper.removeClass('animated');
                    self.wrapper.removeClass(self.settings.openEffect.value);
                });
            }
        },

        /**
         * Init Lightbox
         */
        init: function () {
            this.preShow();
            this.initShow();

            if (AdoricTracking.state !== "error" && this.getSettings('GA.visitorsCountGA')) {
                AdoricTracking.sendEvent(this.options.campaignTitle ? 'Adoric - ' + this.options.campaignTitle : 'Adoric - ' + this.options.title, "Visitor", this.options.title);
            }

            return this;
        },

        /**
         * check availablity LB to show regarding events
         */
        checkAllEvents: function () {
            var cancelledSince = Conditions.checkCancelEvents(this.cancelEvents);
            var isAllowed;
            var waitingAllow;
            var allowedSince;

            if (this.conditions && this.conditions.length && this.conditions[0].length) {
                waitingAllow = true;
                allowedSince = Conditions.checkConditions(this.conditions)
            } else {
                waitingAllow = false;
                allowedSince = 0
            }
            if (cancelledSince > 0) {
                waitingAllow = true
            }
            isAllowed = !waitingAllow || (allowedSince > cancelledSince);

            currentConfig.debugMode && console.log('allowedSince', allowedSince);
            currentConfig.debugMode && console.log('cancelledSince', cancelledSince);
            currentConfig.debugMode && console.log('waitingAllow', waitingAllow);
            currentConfig.debugMode && console.log('isAllowed', isAllowed);

            return isAllowed;
        },

        checkSelectors: function () {
            var self = this;

            if (!self.settings.htmlConditions) return true;

            function parsePageResult(specificSelector) {
                return specificSelector.some(function (selector) {
                    if (document.querySelectorAll(selector.value)) {
                        if (selector.moreOptions) {
                            NodeList.prototype.some = Array.prototype.some;
                            if (selector.moreOptions.moreOptionsType == 'number') {
                                return document.querySelectorAll(selector.value).some(function (element) {
                                    var getElementValue = element.value || element.innerText.trim() || element.textContent.trim();
                                    var compareValue = parseFloat(selector.moreOptions.compareValue);

                                    getElementValue = parseFloat(getElementValue.replace(/^\D+/g, ''));

                                    if (selector.moreOptions.compare == '<>') {
                                        return (parseFloat(selector.moreOptions.compareValue[0]) <= getElementValue && parseFloat(selector.moreOptions.compareValue[1]) >= getElementValue) ||
                                            (parseFloat(selector.moreOptions.compareValue[0]) >= getElementValue && parseFloat(selector.moreOptions.compareValue[1]) <= getElementValue)
                                    } else {
                                        return compareChecker[selector.moreOptions.compare](getElementValue, compareValue)
                                    }
                                })
                            } else if (selector.moreOptions.moreOptionsType == 'text') {
                                return document.querySelectorAll(selector.value).some(function (element) {
                                    var getElementText = element.innerText.trim() || element.textContent.trim() || element.value;

                                    return getElementText == selector.moreOptions.compareTextValue
                                })
                            }
                        } else {
                            return document.querySelectorAll(selector.value).length;
                        }
                    } else {
                        return false;
                    }
                });
            }

            if (self.settings.htmlConditions.exceptSelector.length) {
                return !parsePageResult(self.settings.htmlConditions.exceptSelector)
            } else if (self.settings.htmlConditions.specificSelector.length) {
                return parsePageResult(self.settings.htmlConditions.specificSelector)
            } else {
                return true;
            }
        },

        checkGlobalConditions: function () {
            // false if need cancel
            // true if show
            if (!this.settings.globalConditions) {
                return true;
            }

            var self = this;
            var STORAGE_WINDOW = 1;
            var STORAGE_COOKIE = 2;
            var STORAGE_LOCAL = 3;
            var STORAGE_SESSION = 4;
            var NO_STORAGE_WINDOW = 5;
            var NO_STORAGE_COOKIE = 6;
            var NO_STORAGE_LOCAL = 7;
            var NO_STORAGE_SESSION = 8;
            var NUMBER = 1;
            var TEXT = 2;
            var BOOLEAN = 3;

            function getProperty(storage, conditionName) {
                if (typeof conditionName != 'string' || !storage) return false;

                conditionName = conditionName.replace(/\[(\w+)\]/g, '.$1').replace(/^\./, '');
                var conditionNameArr = conditionName.split('.');

                for (var i = 0, n = conditionNameArr.length; i < n; i++) {
                    var k = conditionNameArr[i];
                    if (typeof storage === 'string') {
                        try {
                            storage = JSON.parse(storage)
                        } catch (e) {}
                    }

                    if (k in storage) {
                        if (storage[k].length > 0 || typeof storage[k] !== 'string') {
                            storage = storage[k];
                        } else {
                            storage = !storage[k];
                        }
                    } else {
                        return;
                    }
                }
                return storage;
            }

            var compareChecker = {
                1: function (getElementValue, compareValue) {
                    return getElementValue > compareValue;
                },
                2: function (getElementValue, compareValue) {
                    return getElementValue < compareValue;
                },
                3: function (getElementValue, compareValue) {
                    return getElementValue == compareValue;
                },
                4: function (getElementValue, compareValue) {
                    return (getElementValue[0] <= compareValue) && (getElementValue[1] >= compareValue);
                }
            };

            function checkStorage(condition, property) {
                if (!property) return false;

                if (!condition.more) {
                    return true;
                } else {
                    if (condition.more.type === TEXT) {
                        return condition.more.value === property;
                    } else if (condition.more.type === NUMBER) {
                        return compareChecker[condition.more.compare](condition.more.value, property);
                    } else if (condition.more.type === BOOLEAN) {
                        var booleanValue = condition.more.value !== 'false';
                        return booleanValue === property
                    }

                    return false;
                }
            }

            function getCookieStorage(name){
                var firstKey = name.slice(0, name.search(/\W/));
                var obj = {};
                obj[firstKey] = Util.getCookie(firstKey);
                return obj;
            }

            function checkConditionShow(conditions) {
                return conditions.every(function conditionAND(condition) {
                    return condition.some(function conditionOR(condition) {
                        var property;

                        switch (condition.storage) {
                            case STORAGE_WINDOW:
                                property = getProperty(window, condition.name);

                                return checkStorage(condition, property);
                            case NO_STORAGE_WINDOW:
                                property = getProperty(window, condition.name);

                                return !checkStorage(condition, property);
                            case STORAGE_COOKIE:
                                property = getProperty(getCookieStorage(condition.name), condition.name);

                                return checkStorage(condition, property);
                            case NO_STORAGE_COOKIE:
                                property = getProperty(getCookieStorage(condition.name), condition.name);

                                return !checkStorage(condition, property);
                            case STORAGE_LOCAL:
                                property = getProperty(Util.localStorageData(), condition.name);

                                return checkStorage(condition, property);
                            case NO_STORAGE_LOCAL:
                                property = getProperty(Util.localStorageData(), condition.name);

                                return !checkStorage(condition, property);
                            case STORAGE_SESSION:
                                property = getProperty(Util.sessionStorageData(), condition.name);

                                return checkStorage(condition, property);
                            case NO_STORAGE_SESSION:
                                property = getProperty(Util.sessionStorageData(), condition.name);

                                return !checkStorage(condition, property);
                            default:
                                break;
                        }
                    });
                })
            }

            if (self.settings.globalConditions.show.length) {
                return checkConditionShow(self.settings.globalConditions.show);
            }

            return false;
        },

        checkUserBehaviorConditions: function () {
            var self = this;
            if (!self.settings.behaviorConditions) return true;

            function parseBehaviorCondition(behaviorConditions) {
                var userBehavior = JSON.parse(Util.localStorageData(localStorageItems.adoric_user_behavior));

                return behaviorConditions.some(function (param) {
                    if (param.act === 'seeing') {
                        var getIsShowing = Util.sessionStorageData(storagePrefixes.isShowing_ + param.campaignId);

                        if (!!getIsShowing) {
                            return JSON.parse(getIsShowing);
                        }
                    } else {
                        if (param.compare === '<>') {
                            return userBehavior[param.act] && compareChecker[param.compare](userBehavior[param.act][param.campaignId], param.qt[0], param.qt[1]);
                        } else {
                            if ((!userBehavior[param.act] || !userBehavior[param.act][param.campaignId]) && param.compare === '<') return true;
                            return userBehavior[param.act] && compareChecker[param.compare](userBehavior[param.act][param.campaignId], param.qt);
                        }
                    }
                });
            }

            if (self.settings.behaviorConditions.exceptBehavior.length) {
                return !parseBehaviorCondition(self.settings.behaviorConditions.exceptBehavior)
            } else if (self.settings.behaviorConditions.specificBehavior.length) {
                return parseBehaviorCondition(self.settings.behaviorConditions.specificBehavior)
            } else {
                return true;
            }
        },

        checkShowAtSameTime: function () {
            var showsAtSameTime = currentDomain.showsAtSameTime;
            var i = Util.sessionStorageData().length;
            var count = 0;

            while (i--) {
                var key = Util.sessionStorageData().key(i);

                if (/isShowing_/.test(key)) {
                    count++;
                }
            }

            return showsAtSameTime ? count < showsAtSameTime : true
        },

        /**
         * @param {String} returning
         * @param {String} newVisit
         * @param {String} buyer
         * @description adoric_visitors -> [date, ...]
         *              adoric_buyer_info -> {date: [count, value], ...}
         * @return {*}
         */
        checkVisitors: function (returning, newVisit, buyer) {
            var self = this;

            if (!self.settings.visitorTypes || !self.settings.visitorTypes.length) return true;

            function resultExpr(index, compareValue, time) {
                switch (index.expr) {
                    case 'equally':
                        return compareValue === time;
                    case 'less':
                        return compareValue < time;
                    case 'more':
                        return compareValue > time;
                    case 'between':
                        return parseInt(index.time[0]) <= compareValue && compareValue <= parseInt(index.time[1]);
                }
            }

            var dateNow = new Date();
            var adoricVisitors = JSON.parse(Util.localStorageData(localStorageItems.adoric_visitors));
            var cancelShow = (function () {
                return self.settings.visitorTypes.some(function (index) {
                    var time = parseInt(index.time);

                    switch (index.type) {
                        case newVisit:
                            if (adoricVisitors.length <= 1) return this;
                            break;
                        case returning:
                            var filteredVisitors = adoricVisitors.filter(function (value) {
                                return value >= dateNow.setDate(dateNow.getDate() - ((index.multiplier || 1) * index.frame));
                            });

                            return resultExpr(index, filteredVisitors.length - 1, time);
                        case buyer:
                            var buyerInfo = JSON.parse(Util.localStorageData(localStorageItems.adoric_buyer_info) || '{}');
                            var filteredCount = 0,
                                filteredValue = 0;
                            var totalValue = buyerInfo['tVal'];
                            var totalCount = buyerInfo['tCount'];
                            var compareValue;

                            delete buyerInfo['tVal'];
                            delete buyerInfo['tCount'];

                            Object.keys(buyerInfo).forEach(function (key) {
                                if (key > dateNow.setDate(dateNow.getDate() - ((index.multiplier || 1) * index.frame))) {
                                    filteredCount += buyerInfo[key][0];
                                    filteredValue += buyerInfo[key][1];
                                }
                            });

                            if (!parseInt(index.frame)) {
                                compareValue = (index.valType === 'times' ? totalCount : totalValue)
                            } else {
                                compareValue = (index.valType === 'times' ? filteredCount : filteredValue)
                            }

                            return resultExpr(index, compareValue, time);
                    }
                });
            })();

            if (cancelShow) {
                return this;
            }
        },

        /**
         * Init show LB
         * Parse settings and prepare triggers for show lightbox
         */
        initShow: function () {
            var self = this,
                freeShow = true,
                isInited = false;

            if (self.settings.openLocation.landingPage) {
                if (!Util.sessionStorageData(sessionStorageItems.isLanding)) {
                    Util.sessionStorageData(sessionStorageItems.isLanding, window.location.href);
                }
                if (Util.sessionStorageData(sessionStorageItems.isLanding) !== window.location.href) {
                    return this;
                }
            }

            if (self.getSettings('openLocation.reachingPage.enabled')) {
                if (parseInt(self.settings.openLocation.reachingPage.value, 10) !== Util.getCountReachingPage()) {
                    return this;
                }
            }

            if (this.settings.noShowOnMobile) {
                if (/Android|AppleWebKit|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) && screen.width < 800) {
                    console.info('_Adoric_info: your device: "', navigator.userAgent, '". View Smart Box disabled for mobiles.');
                    currentInitError = 'Show on mobile phone disabled';
                    return this;
                }
            }

            function onDocumentMouseOut(event) {
                event = event || window.event;

                var node = event.relatedTarget || event.toElement,
                    delay = self.getSettings('openMouseOutMaxTime.delay.enabled') ? (self.settings.openMouseOutMaxTime.delay.value * 1000) : 0;

                if (!node && event.clientY <= 1 && self.checkAllEvents()) {
                    var mouseOutTimer = self.timeout(function () {
                        self.show(SHOWED_BY_DOCUMENT_MOUSEOUT)
                    }, delay);

                    bindEvent(document, 'mouseenter', function () {
                        clearTimeout(mouseOutTimer);
                    }, false);
                }
            }

            var isNotShow = function () {
                var matches = self.settings.openMouseOutMaxTime.value.match(/^\s*([<|>]?=?)\s*(\d+)\s*-?\s*(\d*)\s*$/),
                    isNotShow = false,
                    spentTime = Date.now() - ADORIC_SCRIPT_LOAD_TIME;

                if (matches) {
                    var number = matches[2] * 1000;
                    var operation = matches[1];
                    var numberTwo = matches[3] * 1000;

                    if (self.settings.openMouseOutMaxTime.unit === 'min') {
                        number = number * 60;
                        numberTwo = numberTwo * 60;
                    }
                    switch (operation) {
                        case '<':
                            isNotShow = number < spentTime;
                            break;
                        case '<=':
                            isNotShow = number <= spentTime;
                            break;
                        case '=':
                            isNotShow = number == spentTime;
                            break;
                        case '>=':
                            isNotShow = number >= spentTime;
                            break;
                        case '>':
                            isNotShow = number > spentTime;
                            break;
                        default:
                            if (matches[3]) {
                                isNotShow = number > spentTime || numberTwo < spentTime;
                            } else {
                                isNotShow = number < spentTime;
                            }
                    }
                }

                return isNotShow;
            };

            function onDocumentImmediatelyScroll(isNeedCheckTime) {
                isNeedCheckTime = (isNeedCheckTime === true);

                var checkScrollSpeed = (function () {
                    var lastPosition,
                        newPosition,
                        timer,
                        delta,
                        delay = 50;

                    function clear() {
                        lastPosition = null;
                        delta = 0;
                    }

                    clear();

                    return function () {
                        newPosition = window.scrollY;

                        if (lastPosition !== null) {
                            delta = newPosition - lastPosition;
                        }
                        lastPosition = newPosition;

                        clearTimeout(timer);

                        timer = setTimeout(clear, delay);

                        return delta;
                    };
                })();

                window.addEventListener('scroll', function () {
                    var speed = checkScrollSpeed();
                    var isNotShowChecker = isNotShow();

                    if (speed < -100) {
                        if (isNeedCheckTime && !isNotShowChecker) {
                            self.show(SHOWED_BY_DOCUMENT_MOUSEOUT);
                        } else if (!isNeedCheckTime) {
                            self.show(SHOWED_BY_DOCUMENT_MOUSEOUT)
                        }
                    }
                });
            }

            function onScroll() {
                if (self.checkAllEvents()) {
                    scrollModule.callbackOnScrollToPosition(self.settings.openScrollTop.value, self.settings.openScrollTop.unitsValue, function () {
                        window.removeEventListener('scroll', onScroll);
                        self.show(SHOWED_BY_SCROLL_TOP);
                    });
                }
            }

            if (self.getSettings('clickToOpen.enabled')) {
                var mouseEvent = self.settings.clickToOpen.type || MOUSE_EVENT.click;

                if ('ontouchstart' in window && mouseEvent === MOUSE_EVENT.click) { // check the display is a touch or not
                    mouseEvent = 'touchstart'
                }

                function delegate(element, mouseEvent, selector, handler) {
                    bindEvent(element, mouseEvent, function (event) {
                        var target = event.target;

                        while (target && target !== this) {
                            if (target.matches(selector)) {
                                handler.call(target, event);
                            }
                            target = target.parentNode;
                        }
                    });
                }

                delegate(document, mouseEvent, self.settings.clickToOpen.value, function () {
                    self.show({
                        reason: SHOWED_BY_CLICK_LINK,
                        forced: true
                    });
                });

                isInited = true;
                currentInitedCount += 1;

                return this;
            }

            if (self.settings.eventEmitterOptions) {
                function eachEventSetting(settings, callback) {
                    settings && settings.filter(filterEnabled).forEach(callback);
                }

                function showOnEvent() {
                    self.show({
                        reason: SHOWED_BY_EVENT,
                        forced: true
                    });
                }

                function getCheckEventFunction(eventName, callback) {
                    function checkEventFunction() {
                        var readedEventBy = Util.localStorageData(storagePrefixes.readed_event_ + eventName);

                        readedEventBy = readedEventBy ? readedEventBy.split(',') : [];
                        if (readedEventBy.indexOf(self.id) === -1) {
                            readedEventBy.push(self.id);
                            Util.localStorageData(storagePrefixes.readed_event_ + eventName, readedEventBy.join());
                            callback();
                        }
                    }

                    if (Util.trackedEvents()[eventName] && window.performance.timing.domLoading < Util.trackedEvents()[eventName][0]) {
                        checkEventFunction();
                    }

                    return checkEventFunction;
                }

                eachEventSetting(this.settings.eventEmitterOptions.showOnEvents, function (item) {
                    var checkEventFunction = getCheckEventFunction(item.value, showOnEvent);

                    adoric.on(item.value, checkEventFunction);
                    freeShow = false;
                });
                if (this.settings.disabledEventsConditions) {
                    self.conditions = [
                        []
                    ];
                } else {
                    self.conditions = Util
                        .actualizeEventSettings(this.settings.eventEmitterOptions.allowShowOnEvents)
                        .concat(Conditions[self.settings.betweenEventsConditions] || Conditions.OR, Util.actualizeEventSettings(this.settings.allowShowHardcoded));
                }

                //hot fix start
                if (!self.conditions[0].length) {
                    self.conditions.shift();
                } else if (!self.conditions[self.conditions.length - 1].length) {
                    self.conditions.pop();
                }
                self.cancelEvents = this.settings.eventEmitterOptions.cancelShowOnEvents;
                //hot fix end
                //conditions ready to use!
            }

            if (self.getSettings('urlConditions.show.length') || self.getSettings('urlConditions.exclude.length')) {
                var getURLConditions = JSON.parse(Util.localStorageData(localStorageItems.adoric_url_conditions));
                var getQueryConditions = JSON.parse(Util.localStorageData(localStorageItems.adoric_query_conditions));
                var count = 0;
                var boolArr = [];
                var bool = [];

                /**
                 * 0 - startsWith
                 * 1 - endsWith
                 * 2 - contains
                 * 3 - match
                 * @type {{0: Function, 1: Function, 2: Function, 3: Function}}
                 */
                var rulesChecker = {
                    '0': function (userConditions, url) {
                        return Object.keys(userConditions).map(function (userCondition) {
                            if (userCondition.startsWith(url)) {
                                return userCondition;
                            }
                        })
                    },
                    '1': function (userConditions, url) {
                        return Object.keys(userConditions).map(function (userConditions) {
                            if (userConditions.endsWith(url)) {
                                return userConditions;
                            }
                        })
                    },
                    '2': function (userConditions, url) {
                        return Object.keys(userConditions).map(function (userCondition) {
                            if (~userCondition.indexOf(url)) {
                                return userCondition;
                            }
                        })
                    },
                    '3': function (userConditions, url) {
                        return Object.keys(userConditions).map(function (userCondition) {
                            if (userCondition == url) {
                                return userCondition;
                            }
                        })
                    }
                };

                /**
                 * 0 - compare OR
                 * 1 - compare AND
                 * @type {{0: Function, 1: Function}}
                 */
                var compare = {
                    '0': function (prev, current) {
                        return prev || current
                    },
                    '1': function (prev, current) {
                        return prev && current
                    }
                };

                function checkConditions(conditions) {
                    conditions.forEach(function (condition) {
                        if (condition[0] == CONDITIONS_TYPE_URL) {
                            rulesChecker[condition[1]](getURLConditions, condition[2]).forEach(function (item) {
                                count += item ? getURLConditions[item] : 0;
                            });
                            boolArr.push(compareChecker[condition[3]](count, condition[4]));
                        } else if (condition[0] == CONDITIONS_TYPE_QUERY) {
                            rulesChecker[condition[1]](getQueryConditions, condition[2]).forEach(function (item) {
                                count += item ? getQueryConditions[item] : 0;
                            });
                            boolArr.push(compareChecker[condition[3]](count, condition[4]));
                        } else {
                            bool.push(condition);
                        }
                    });

                    return boolArr.reduce(function (prev, current, i) {
                        return compare[bool[i - 1] ? bool[i - 1] : 0](prev, current);
                    });
                }

                if (self.settings.urlConditions.show.length) {
                    if (!checkConditions(self.settings.urlConditions.show)) {
                        return this;
                    }
                }
                if (self.settings.urlConditions.exclude.length) {
                    if (checkConditions(self.settings.urlConditions.exclude)) {
                        return this;
                    }
                }
            }

            if (!self.settings.referrerSettings || self.settings.referrerSettings.allTrafficSources === false) {
                var referrerURL = Util.sessionStorageData(sessionStorageItems.adoric_referrer_url) || '',
                    query = Util.queryString(referrerURL),
                    utm_medium = query['utm_medium'],
                    definedSpecificSourceSettings = self.getSettings('referrerSettings.specificSource.length'),
                    definedSpecificSourceExceptSettings = self.getSettings('referrerSettings.exceptSpecificSource.length'),
                    definedReferrerUrlSettings = self.getSettings('referrerSettings.referrerURL.length'),
                    definedReferrerParamSettings = self.getSettings('referrerSettings.referrerParam.length'),
                    definedReferrerUrlExceptSettings = self.getSettings('referrerSettings.exceptReferrerUrl.length'),
                    definedReferrerParamExceptSettings = self.getSettings('referrerSettings.exceptReferrerParam.length'),
                    disallowShowByReferrerSettings = definedReferrerUrlSettings || definedReferrerParamSettings,
                    disallowShowByExceptReferrerSettings = false;

                /**
                 * 0 - startsWidth
                 * 1 - endsWidth
                 * 2 - contains
                 * 3 - match
                 * @param {string}
                 * @type {{0: Function, 1: Function, 2: Function, 3: Function}}
                 */
                var rulesCheckerRef = {
                    '0': function (referrer, value) {
                        return referrer && referrer.startsWith(value)
                    },
                    '1': function (referrer, value) {
                        return referrer && referrer.endsWith(value)
                    },
                    '2': function (referrer, value) {
                        return referrer && ~referrer.indexOf(value)
                    },
                    '3': function (referrer, value) {
                        return referrer && (referrer === value)
                    }
                };

                function checkSpecificSource(source) {
                    var show_referrer_ = Util.sessionStorageData(storagePrefixes.show_referrer_ + self.id);
                    disallowShowByReferrerSettings = true;

                    function saveCheckReferrer() {
                        Util.sessionStorageData(storagePrefixes.show_referrer_ + self.id, true);
                        disallowShowByReferrerSettings = false;
                    }

                    if (show_referrer_ === 'true') {
                        saveCheckReferrer();
                        return;
                    }

                    switch (source) {
                        case 'direct':
                            if (!referrerURL) {
                                saveCheckReferrer();
                            }
                            break;
                        case 'organic':
                            if (SEARCH_NAMES_SYSTEMS_REG_EXP.test(utm_medium) || SEARCH_SYSTEMS_REG_EXP.test(referrerURL)) {
                                saveCheckReferrer();
                            }
                            break;
                        case 'paid':
                            if (PAID_TYPE_REG_EXP.test(utm_medium)) {
                                saveCheckReferrer();
                            }
                            break;
                        case 'social':
                            if (SOCIAL_NAMES_NETWORKS_REG_EXP.test(utm_medium) || SOCIAL_NETWORKS_REG_EXP.test(referrerURL)) {
                                saveCheckReferrer();
                            }
                            break;
                        case 'email':
                            if (utm_medium && ~utm_medium.indexOf('email')) {
                                saveCheckReferrer();
                            }
                            break;
                        case 'referral':
                            if (referrerURL || utm_medium) {
                                saveCheckReferrer();
                            }
                            break;
                    }
                }

                function checkExceptSource(source) {
                    var show_referrer_ = Util.sessionStorageData(storagePrefixes.except_referrer_ + self.id);
                    disallowShowByExceptReferrerSettings = false;

                    function saveCheckExcReferrer() {
                        Util.sessionStorageData(storagePrefixes.except_referrer_ + self.id, true);
                        disallowShowByExceptReferrerSettings = true;
                    }

                    if (show_referrer_ === 'true') {
                        saveCheckExcReferrer();
                        return;
                    }

                    switch (source) {
                        case 'direct':
                            if (!referrerURL) {
                                saveCheckExcReferrer();
                            }
                            break;
                        case 'organic':
                            if (SEARCH_NAMES_SYSTEMS_REG_EXP.test(utm_medium) || SEARCH_SYSTEMS_REG_EXP.test(referrerURL)) {
                                saveCheckExcReferrer();
                            }
                            break;
                        case 'paid':
                            if (PAID_TYPE_REG_EXP.test(utm_medium)) {
                                saveCheckExcReferrer();
                            }
                            break;
                        case 'social':
                            if (SOCIAL_NAMES_NETWORKS_REG_EXP.test(utm_medium) || SOCIAL_NETWORKS_REG_EXP.test(referrerURL)) {
                                saveCheckExcReferrer();
                            }
                            break;
                        case 'email':
                            if (utm_medium && ~utm_medium.indexOf('email')) {
                                saveCheckExcReferrer();
                            }
                            break;
                        case 'referral':
                            if (referrerURL) {
                                saveCheckExcReferrer();
                            }
                            break;
                    }
                }

                if (definedSpecificSourceSettings) {
                    self.settings.referrerSettings.specificSource.forEach(function (source) {
                        checkSpecificSource(source);
                    })
                }

                if (definedSpecificSourceExceptSettings) {
                    self.settings.referrerSettings.exceptSpecificSource.forEach(function (source) {
                        checkExceptSource(source);
                    })
                }

                if (definedReferrerUrlSettings && Util.sessionStorageData(storagePrefixes.show_referrer_ + self.id) !== 'true' && Util.sessionStorageData(storagePrefixes.except_referrer_ + self.id) !== 'true') {
                    var enabledItems = self.settings.referrerURL || self.settings.referrerSettings.referrerURL.filter(filterEnabled);

                    function isOnReferrer(item) {
                        return rulesCheckerRef[item.rule](referrerURL, item.value)
                    }

                    if (enabledItems.length && enabledItems.some(isOnReferrer)) {
                        Util.sessionStorageData(storagePrefixes.show_referrer_ + self.id, true);
                    }

                    disallowShowByReferrerSettings = enabledItems.length && !enabledItems.some(isOnReferrer);
                }
                if (definedReferrerParamSettings && Util.sessionStorageData(storagePrefixes.show_referrer_ + self.id) !== 'true' && Util.sessionStorageData(storagePrefixes.except_referrer_ + self.id) !== 'true') {
                    var search = referrerURL.slice(referrerURL.indexOf('?') + 1),
                        keys = {},
                        enabledParam = self.settings.referrerSettings.referrerParam.filter(filterEnabled);

                    search.split('&').forEach(function (item) {
                        item = item.split('=');
                        keys[item[0]] = item[1];
                    });

                    function isOnReferrerParam(item) {
                        var result;

                        for (var i in keys) {
                            result = rulesCheckerRef[item.rule](keys[i], item.value);
                        }

                        return result;
                    }

                    if (enabledParam.length && enabledParam.some(isOnReferrerParam)) {
                        Util.sessionStorageData(storagePrefixes.show_referrer_ + self.id, true);
                    }

                    disallowShowByReferrerSettings = disallowShowByReferrerSettings && (enabledParam.length && !enabledParam.some(isOnReferrerParam));
                }
                if (definedReferrerUrlExceptSettings) {
                    var enabledItemsExcept = self.settings.referrerSettings.exceptReferrerUrl.filter(filterEnabled),
                        exceptReferrerOption = Util.sessionStorageData(storagePrefixes.except_referrer_ + self.id);

                    function isOnReferrerExcept(item) {
                        return rulesCheckerRef[item.rule](referrerURL, item.value)
                    }

                    if (enabledItemsExcept.length && enabledItemsExcept.some(isOnReferrerExcept)) {
                        Util.sessionStorageData(storagePrefixes.except_referrer_ + self.id, true);
                    }

                    disallowShowByExceptReferrerSettings = (enabledItemsExcept.length && enabledItemsExcept.some(isOnReferrerExcept) || exceptReferrerOption == 'true');
                }
                if (definedReferrerParamExceptSettings) {
                    var searchExcept = referrerURL.slice(referrerURL.indexOf('?') + 1),
                        keysExcept = {},
                        enabledParamExcept = self.settings.referrerSettings.exceptReferrerParam.filter(filterEnabled),
                        exceptReferrerOptionParam = Util.sessionStorageData(storagePrefixes.except_referrer_ + self.id);

                    searchExcept.split('&').forEach(function (item) {
                        item = item.split('=');
                        keysExcept[item[0]] = item[1];
                    });

                    function isOnReferrerParamExcept(item) {
                        var result;

                        for (var i in keysExcept) {
                            result = rulesCheckerRef[item.rule](keysExcept[i], item.value);
                        }

                        return result;
                    }

                    if (enabledParamExcept.length && enabledParamExcept.some(isOnReferrerParamExcept)) {
                        Util.sessionStorageData(storagePrefixes.except_referrer_ + self.id, true);
                    }

                    disallowShowByExceptReferrerSettings = (enabledParamExcept.length && enabledParamExcept.some(isOnReferrerParamExcept) || exceptReferrerOptionParam == 'true');
                }

                if (disallowShowByReferrerSettings || disallowShowByExceptReferrerSettings) {
                    return this;
                }
            }
            if (this.getSettings('showsPerSession.enabled') && this.getShowLBPerSession() >= this.settings.showsPerSession.value) {
                currentInitError = 'smartbox\'s shows per session limit reached';
                return this;
            }

            if (this.settings.repeatShow.enabled && this.getLastShowTime() + this.settings.repeatShow.value * 24 * 60 * 60 * 1000 > new Date().getTime()) {
                currentInitError = 'User already saw LB of this campaign';
                return this;
            }

            if (this.settings.notShowClicked) {
                if (this.isAlreadyClicked()) {
                    currentInitError = 'Show on mobile phone disabled';
                    return this;
                }
            }

            if ((this.settings.notShowClosed) && (this.hasBeenClosed())) {
                currentInitError = 'User has already closed this LB';
                return this;
            }
            if (self.settings.openTime.enabled) {
                var counterLocation = self.settings.openTime.type,
                    MS_UPDATE_INTERVAL = 125;

                function isNeedShow() {
                    return !self.settings.countOnly;
                }

                function isNeedCount() {
                    return (
                        (counterLocation === 'onePage' && isNeedShow()) ||
                        (counterLocation === 'specificPages' && isNeedShow()) ||
                        (counterLocation === 'counterWithSpecific') ||
                        (counterLocation === 'counterWithoutSpecific' && Util.checkIsUrlInSettings(self.settings.counter, window.location.href))
                    );
                }

                function lastSpentTime(val) {
                    return +Util.sessionStorageData(storagePrefixes.lastSpentTime_ + self.id, val);
                }

                function allSpentTime(val) {
                    return +Util.sessionStorageData(storagePrefixes.allSpentTime_ + self.id, val);
                }
                if (isNeedShow()) {
                    isInited = true;
                    currentInitedCount += 1;
                }

                if (Date.now() - ADORIC_SCRIPT_LOAD_TIME > self.settings.openTime.value * 1000) {
                    self.show(SHOWED_BY_TIMER);
                    return false;
                }
                if (isNeedCount()) {
                    allSpentTime(counterLocation !== 'onePage' ? (allSpentTime() + lastSpentTime()) : 0);
                    lastSpentTime(Date.now() - ADORIC_SCRIPT_LOAD_TIME);
                }

                self.timeout(function checkSpentTime() {
                    if (Util.isTabFocused() && isNeedCount()) {
                        lastSpentTime(lastSpentTime() + MS_UPDATE_INTERVAL);
                    }
                    if (isNeedShow() && (allSpentTime() + lastSpentTime() >= self.settings.openTime.value * 1000)) {
                        if (
                            self.getSettings('timeAfterCounter.enabled') &&
                            Date.now() - ADORIC_SCRIPT_LOAD_TIME <= self.settings.timeAfterCounter.value * 1000
                        ) {
                            self.timeout(checkSpentTime, MS_UPDATE_INTERVAL - 1)
                        } else {
                            self.show(SHOWED_BY_TIMER);
                            allSpentTime(0);
                            lastSpentTime(0);
                        }
                    } else {
                        self.timeout(checkSpentTime, MS_UPDATE_INTERVAL - 1)
                    }
                }, MS_UPDATE_INTERVAL - 1);
            } else if (self.settings.countOnly) {
                currentInitError = 'SB loaded by count page';
                return this;
            } else if (self.settings.openScrollTop.enabled) {
                bindEvent(window, 'scroll', onScroll);
            } else if (self.getSettings('openMouseOut.enabled') && !self.settings.openMouseOutMaxTime.enabled) {
                if (DEVICE_TYPE === SB_TYPE_DESKTOP) {
                    bindEvent(document, 'mouseout', onDocumentMouseOut);
                } else {
                    bindEvent(window, 'scroll', onDocumentImmediatelyScroll);
                }
            } else if (self.getSettings('openMouseOutMaxTime.enabled')) {
                unbindEvent(document, 'mouseout', onDocumentMouseOut);
                unbindEvent(window, 'scroll', onDocumentImmediatelyScroll);

                if (DEVICE_TYPE === SB_TYPE_DESKTOP) {
                    bindEvent.call(document, document, 'mouseout', function (e) {
                        if (e.clientY <= 1) {
                            var isNotShowChecker = isNotShow();

                            if (!isNotShowChecker) {
                                var delay = (self.getSettings('openMouseOutMaxTime.delay.enabled')) ? (self.settings.openMouseOutMaxTime.delay.value * 1000) : 0,
                                    mouseOutTimer = self.timeout(function () {
                                        self.show(SHOWED_BY_DOCUMENT_MOUSEOUT);
                                    }, delay);

                                bindEvent.call(document, document, 'mouseenter', function () {
                                    clearTimeout(mouseOutTimer);
                                }, false);

                            }
                        }
                    })
                } else {
                    bindEvent(window, 'scroll', onDocumentImmediatelyScroll(true));
                }
            } else if (this.getSettings('closeWindow.enabled')) {
                var logOutFlag = true;

                function updateLogOutFlag() {
                    logOutFlag = false;
                    self.timeout(function () {
                        logOutFlag = true;
                    }, 2000);
                }

                self.preShow(SHOWED_BY_CLOSE_WINDOW);
                Element().find('a').on('click', updateLogOutFlag);
                Element().find('input').on("click", updateLogOutFlag);
                Element().find('form').on("submit", updateLogOutFlag);
                Element().find('button').on('click', updateLogOutFlag);
                Element(document).on("keydown", function (e) {
                    if (e.keyCode == 116) {
                        updateLogOutFlag();
                    }
                });

                bindEvent.call(window, window, 'beforeunload', function (e) {
                    if (logOutFlag && self.checkAllEvents()) {
                        var spentTime = Date.now() - ADORIC_SCRIPT_LOAD_TIME,
                            timeLimit = self.settings.closeWindowMinTime;
                        var isNotShow = false;

                        if (timeLimit && timeLimit.enabled) {
                            var matches = timeLimit.value.match(/^\s*([<|>]?=?)\s*(\d+)\s*-?\s*(\d*)\s*$/);
                            if (matches) {
                                var number = matches[2] * 1000;
                                var operation = matches[1];
                                var numberTwo = matches[3] * 1000;

                                switch (operation) {
                                    case '<':
                                        isNotShow = number < spentTime;
                                        break;
                                    case '<=':
                                        isNotShow = number <= spentTime;
                                        break;
                                    case '=':
                                        isNotShow = number == spentTime;
                                        break;
                                    case '>=':
                                        isNotShow = number >= spentTime;
                                        break;
                                    case '>':
                                        isNotShow = number > spentTime;
                                        break;
                                    default:
                                        if (matches[3]) {
                                            isNotShow = number > spentTime || numberTwo < spentTime;
                                        } else {
                                            isNotShow = number > spentTime;
                                        }
                                }
                            }
                        }
                        if (isNotShow) {
                            return isNotShow;
                        }
                        var confirmationMessage = ' ';

                        self.postShow(SHOWED_BY_CLOSE_WINDOW);
                        currentConfig.isVisible && (e.returnValue = confirmationMessage);
                        return confirmationMessage;
                    }
                });
            } else if (freeShow) {
                self.show(SHOWED_BY_DEFAULT);
            }
            isInited || (currentInitedCount += 1);
        },

        showFooter: function () {
            var self = this;

            self.footer.css({
                zIndex: 900000000001
            });
            self.footer.appendToBody();

            return this;
        },

        showThankYou: function (form) {
            var self = this,
                message = form.getAttribute('data-thankyou-message') || false,
                autoCloseTimeout = false;

            if (message) {
                var thankYouMessage = Element('div')
                    .css({
                        'font-family': 'Arial, Helvetica, Sans-Serif',
                        'font-size': '25px',
                        'color': '#444',
                        'line-height': '1.26',
                        'max-width': '330px',
                        'margin-right': 'auto',
                        'margin-left': 'auto',
                        'margin-top': '125px',
                        'margin-bottom': '40px',
                        'letter-spacing': '0.4px',
                        'word-break': 'break-all',
                        'text-align': 'center'
                    })
                    .addClass(self.identifier + 'thankYouMessage' + ' ' + ADORIC_IDENTIFIER)
                    .html(message);
                var closeThankYouMessage = Element('span')
                    .css({
                        'position': 'absolute',
                        'top': '20px',
                        'right': '20px',
                        'margin': '0 0',
                        'cursor': 'pointer',
                        'display': 'block',
                        'width': '10px',
                        'height': '10px',
                        'background-image': 'url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAA2CAMAAAD9LTlFAAAAOVBMVEUAAACrq6tmZmarq6tmZmarq6tmZmZmZmarq6urq6tmZmarq6tmZmZmZmarq6urq6urq6urq6tmZmYgCkOKAAAAEXRSTlMA+flOTlRUSUnu7ufnoJ2mSOUT86sAAAB+SURBVDjL7c43AoAwDENRpVBSKfc/LEySyZ4Nb36LPo4UYG5JHelywYi7CoJ7zYjbQZPQKDSJjCKjyCha567W2aKeKc1IY3NBL+enuXT8N+NajvZdc0O+fTTi74roXzPiN9AkNApNIqPIKDKK1rmrdbaoZ0oz8thc0eq3ubYHFR8IVndtiS8AAAAASUVORK5CYII=)',
                        'background-repeat': 'no-repeat',
                        'background-position': '0 0',
                        'background-size': '10px auto',
                    }).addClass(self.identifier + 'closeButton');

                self.thankYouModal
                    .append(thankYouMessage)
                    .append(closeThankYouMessage)
                    .appendToBody()
                    .css({
                        'margin-top': (self.thankYouModal.height() / -2) + 'px'
                    });

                self.thankYouContent
                    .appendToBody()
                    //.append(closeButton)
                    .css({
                        zIndex: 99999999,
                        opacity: 1
                    });

                Element('.closeThankYouMessage').on('click', function () {
                    self.hideThankYou.apply(self);
                });

                autoCloseTimeout = setTimeout(self.hideThankYou.bind(self), 5 * 1000);

                Element('.' + self.identifier + 'closeButton').on('click', function () {
                    self.hideThankYou.apply(self);
                    if (autoCloseTimeout) {
                        clearTimeout(autoCloseTimeout);
                    }
                });
            } else {
                self.bindRedirectAction();
            }

            return this;
        },

        hideThankYou: function () {
            var self = this;

            self.thankYouContent.css({
                opacity: 0
            });
            self.thankYouModal.css({
                opacity: 0
            });
            self.timeout(self.thankYouContent.remove.bind(self.thankYouContent), 1000);
            self.bindRedirectAction();

            return this;
        },
        /**
         * Bind redirect action to submitted form
         */
        bindRedirectAction: function () {
            var url = this.submitedForm.getAttribute('data-redirect-link'),
                inNewTab = this.submitedForm.getAttribute('data-redirect-newtab');

            if (!url) {
                return this;
            }

            if (inNewTab) {
                var newTab = window.open(url, '_blank');
                newTab && newTab.focus && newTab.focus();
            } else {
                window.location = url;
            }

            return this;
        },

        /**
         * Bind redirect action to submitted form
         */
        bindLoadFileAction: function () {
            /*fix on firefox click()*/
            HTMLElement.prototype.click = function () {
                var evt = this.ownerDocument.createEvent('MouseEvents');
                evt.initMouseEvent('click', true, true, this.ownerDocument.defaultView, 1, 0, 0, 0, 0, false, false, false, false, 0, null);
                this.dispatchEvent(evt);
            };
            /*end*/
            var fileUrl = this.submitedForm.getAttribute('data-upload-file'),
                fileName = this.submitedForm.getAttribute('data-file-name');

            if (fileUrl) {
                Element('a')
                    .attribute({
                        download: fileName || 'download',
                        href: fileUrl
                    }).css({
                        color: 'white'
                    }).getDOMElements().click();
            }

            return this;
        },

        /**
         * Bind close action to elements
         */
        bindCloseAction: function () {
            var self = this,
                element = new Element();

            element.elements = document.querySelectorAll('.' + self.identifier + '.' + CLOSE_LIGHTBOX_CLASS + ', .' + self.identifier + ' .' + CLOSE_LIGHTBOX_CLASS);
            element.filter(function (element) {
                    return !element.querySelector('a')
                })
                .on('click', function (event) {
                    event = event || window.event;
                    event.preventDefault();
                    self.close(CLOSED_BY_CLOSE_ELEMENT)
                        .saveUserBehaviorCloseLB();
                    return false;
                });

            return this;
        },

        bindLinksToSBs: function () {
            var self = this,
                element = new Element();

            element.elements = document.querySelectorAll('.' + self.identifier + ' .inner-element');
            element.filter(function (element) {
                    var isNeedBindSb = element.getAttribute('data-show-id-smartbox') &&
                        element.tagName.toLowerCase() !== 'form';

                    return isNeedBindSb;
                })
                .on('click', function (event) {
                    event = event || window.event;
                    event.preventDefault();

                    if (this.parentNode.className && !~this.parentNode.className.split(' ').indexOf('adoric_forbidConversionTarget')) {
                        self.increaseClick({
                            target: this,
                            reason: CLICKED_BY_SUBMIT_FORM,
                            eventName: this.getAttribute('data-event-name'),
                            eventValue: this.getAttribute('data-event-value')
                        });
                    }

                    var campaignId = this.getAttribute('data-show-id-campaign');
                    var versionId = this.getAttribute('data-show-id-smartbox');

                    self.showOtherVersion(campaignId, versionId);
                    self.close();

                    return false;
                });

            return this;
        },

        bindTimerCallback: function () {
            var self = this,
                element = new Element(),
                CALLBACK_SHOW_OTHER_VERSION = 'anotherLightbox',
                CALLBACK_URL = 'url',
                CALLBACK_CLOSE_LIGHTBOX = 'closeLightbox';

            element.elements = document.querySelectorAll('.' + self.identifier + ' .element-timer');

            element.on('timerEnd', function () {
                var timerId = this.getAttribute('id');
                var callbackData = window['timerInstance_' + timerId].callbackData || {};

                switch (this.getAttribute('data-timer-cb')) {
                    case CALLBACK_SHOW_OTHER_VERSION:
                        var campaignId = callbackData['timerCallbackCampaign'],
                            versionId = callbackData['timerCallbackVersion'];

                        (campaignId && versionId) && self.showOtherVersion(campaignId, versionId);

                        break;
                    case CALLBACK_URL:
                        var redirectUrl = callbackData['timerCallbackUrl'];
                        var openBlank = callbackData['timerCallbackUrlBlank'];

                        if (openBlank && openBlank !== 'false') {
                            window.open(redirectUrl);
                        } else {
                            window.location.href = redirectUrl;
                        }

                        break;
                    case CALLBACK_CLOSE_LIGHTBOX:
                        self.close(CLOSED_BY_TIMER);

                        break;
                    default:
                        break;
                }
            });

            return this;
        },

        bindSmartLink: function () {
            var self = this,
                element = new Element();

            element.elements = document.querySelectorAll('.' + self.identifier + ' .inner-element');
            element.filter(function (element) {
                    return element.getAttribute('data-smart-link');
                })
                .on('click', function (event) {
                    event = event || window.event;
                    var dataSmartLink = this.getAttribute('data-smart-link'),
                        oldHref = this.parentNode.getAttribute('href'),
                        newHref;

                    if (dataSmartLink && dataSmartLink !== '' && window[dataSmartLink] && oldHref) {
                        event.preventDefault();

                        var jsonParam = window[dataSmartLink],
                            str = Object.keys(jsonParam).map(function (key) {
                                return encodeURIComponent(key) + '=' + encodeURIComponent(jsonParam[key]);
                            }).join('&');

                        if (oldHref.indexOf('?') !== -1) {
                            newHref = oldHref + '&' + str;
                        } else {
                            newHref = oldHref + '?' + str;
                        }

                        if (this.parentNode.getAttribute('target') == '_blank') {
                            window.open(newHref)
                        } else {
                            window.location.href = newHref;
                        }
                        self.close();

                        return false;
                    }
                });

            return this;
        },

        bindClicksToDynamicLinks: function () {
            var self = this,
                element = new Element();

            element.elements = document.querySelectorAll('.' + self.identifier + ' .element-embed[trackDynamicLinks="true"]');
            element.on('click', function onEmbedElementClick(event) {
                event = event || window.event;
                var iteratedElement = event.target;

                do {
                    if (iteratedElement === this) break;
                    if (iteratedElement.href) {
                        self.increaseClick({
                            target: iteratedElement,
                            reason: CLICKED_BY_DYNAMIC_LINK,
                            eventName: this.firstChild.getAttribute('data-event-name'),
                            eventValue: this.firstChild.getAttribute('data-event-value')
                        });
                        self.close();
                        break;
                    }
                } while (iteratedElement = (iteratedElement.parentNode || iteratedElement.parentElement));
            });

            return this;
        },

        bindClickToConversionTarget: function () {
            var self = this,
                element = new Element();

            element.elements = document.querySelectorAll('.' + self.identifier + ' .adoric_conversionTarget');
            element.on('click', function (event) {
                event = event || window.event;
                event.preventDefault();

                self.increaseClick({
                    target: this,
                    reason: CLICKED_TO_CONVERSION_TARGET,
                    eventName: this.getAttribute('data-event-name') ||
                        (this.firstChild.getAttribute && this.firstChild.getAttribute('data-event-name')) ||
                        "Conversion",
                    eventValue: this.getAttribute('data-event-value') ||
                        (this.firstChild.getAttribute && this.firstChild.getAttribute('data-event-value')) ||
                        0
                });
                return false;
            });

            return this;
        },

        bindEscKeyPress: function () {
            var self = this;

            function escKeyPress(event) {
                event = event || window.event;
                if (event.keyCode === 27) {
                    self.close()
                }
            }

            if (self.settings.closeOnEscButton) {
                addEventListener('keydown', escKeyPress);
            }

            return this;
        },

        showOtherVersion: function (campaignId, versionId) {
            Util.ajax(VERSION_API_URL, GET_METHOD, {
                campaignId: campaignId,
                versionId: versionId
            }, function (response) {
                if (response.version && response.version.html) {
                    response.version.campaignId = campaignId;
                    response.version.html = response.version.html
                        .replace(/data-onclick/g, "onclick")
                        .replace(/data-onsubmit/g, "onsubmit");

                    adoric.showOtherVersion(response.version);
                } else {
                    throw Error('version is null/undefined/deleted, versionId: ' + versionId)
                }
            });
        },

        bindIncreaseClickAction: function () {
            // sorry
            function isLinkEmbed(aElement) {
                return !(aElement.parentNode.className.indexOf('element') !== -1 ||
                    aElement.parentNode.className.indexOf('adoric_element') !== -1);
            }

            var self = this,
                links = document.querySelectorAll('.' + self.identifier + ' a');

            this.dynamicLinks = Util.assign(this.dynamicLinks, (adoric.dynamicLinks || {}));
            for (var i = links.length - 1; i >= 0; i--) {
                for (var key in this.dynamicLinks) {
                    var url = this.dynamicLinks[key];

                    if (links[i].getAttribute('data-track') == key) {
                        links[i].href = url
                    }
                }
                bindEvent(links[i], 'click', function () {
                    adoric.trigger(this, OWN_EVENTS.linkBeforeClick, {
                        lightbox: self,
                        lightboxId: self.id,
                        track: this.getAttribute('data-track'),
                        target: this,
                        reason: CLICKED_LINK_REDIRECT,
                        userId: currentUserId,
                        planType: currentPlanType,
                        planId: currentPlanId,
                        domainId: currentDomain._id
                    });
                    if (this.className.split(' ').indexOf('not_conversion') === -1) {
                        self.increaseClick({
                            target: this,
                            track: this.getAttribute('data-track'),
                            reason: CLICKED_LINK_REDIRECT,
                            eventName: this.firstChild.getAttribute('data-event-name'),
                            eventValue: this.firstChild.getAttribute('data-event-value')
                        });
                    }
                    if (!isLinkEmbed(this)) {
                        self.close(CLOSED_BY_CLICK_LINK_REDIRECT);
                    }
                    adoric.trigger(this, OWN_EVENTS.linkAfterClick, {
                        lightbox: self,
                        lightboxId: self.id,
                        track: this.getAttribute('data-track'),
                        target: this,
                        reason: CLICKED_LINK_REDIRECT,
                        userId: currentUserId,
                        planType: currentPlanType,
                        planId: currentPlanId,
                        domainId: currentDomain._id
                    });
                });
            }

            return this;
        },

        bindAutoClose: function () {
            var self = this;

            function onScroll() {
                scrollModule.callbackOnScrollToPosition(self.settings.closeScrollTop.value, self.settings.closeScrollTop.enum, function () {
                    window.removeEventListener('scroll', onScroll);
                    self.close(CLOSED_BY_SCROLL_TOP);
                })
            }

            if (self.settings.closeTime.enabled) {
                self.timeout(function () {
                    self.close(CLOSED_BY_AUTOCLOSE_TIMER);
                }, self.settings.closeTime.value * 1000);
            }
            if (self.settings.closeScrollTop.enabled) {
                bindEvent(window, 'scroll', onScroll);
            }

            return this;
        },

        bindAjaxForm: function () {
            var self = this,
                forms = document.querySelectorAll('.' + self.identifier + ' form.inner-element');

            function increaseFormClick(form) {
                var campaignId = form.getAttribute('data-show-id-campaign');
                var versionId = form.getAttribute('data-show-id-smartbox');

                self.increaseClick({
                    target: form,
                    reason: CLICKED_BY_SUBMIT_FORM,
                    eventName: form.getAttribute('data-event-name'),
                    eventValue: form.getAttribute('data-event-value')
                });
                if (versionId) {
                    self.showOtherVersion(campaignId, versionId);
                }
            }

            Array.prototype.forEach.call(forms, function (node) {
                Element(node).on('submit', function (event) {
                    event.preventDefault();
                    event.stopPropagation();

                    var $node = Element(node);
                    var action = $node.attribute('action');
                    var enctype = $node.attribute('enctype');
                    var method = $node.attribute('method');
                    var requiredFields = node.querySelectorAll("[required='true']:not(.element-input-submit)");
                    var submitButton = node.querySelector('INPUT[type="submit"]');
                    var form = this;
                    var formData;

                    var isNeedSubmit = Array.prototype.every.call(requiredFields, function (field) {
                        if (field.type === "checkbox") {
                            return field.checked
                        } else {
                            return field.value.length >= 1
                        }
                    });

                    if (!isNeedSubmit) {
                        return false;
                    }

                    self.submitedForm = node;

                    adoric.trigger(self, OWN_EVENTS.formBeforeSubmit, {
                        lightbox: self,
                        lightboxId: self.id,
                        target: form,
                        event: event
                    });

                    submitButton.setAttribute('disabled', true);

                    // form submited without error
                    function formIsSubmited() {
                        increaseFormClick(form);
                        self.showThankYou(node);
                        self.bindLoadFileAction();

                        self.close(CLOSED_BY_SUBMIT_FORM);
                    }

                    if (Element(node).attribute('data-adoric-webhooks') === 'true') {
                        // send webhooks integration

                        //serialize form
                        formData = Util.serializeListForm(node);

                        // add session params
                        if (formData.subscribe.adoricSessionParams) {
                            var adoricSessionParams = JSON.parse(formData.subscribe.adoricSessionParams);

                            if (adoricSessionParams.campaignName) {
                                formData.subscribe[adoricSessionParams.campaignName] = self.options.campaignTitle;
                            }

                            if (adoricSessionParams.variationName) {
                                formData.subscribe[adoricSessionParams.variationName] = self.options.title;
                            }

                            if (adoricSessionParams.referrerPage) {
                                formData.subscribe[adoricSessionParams.referrerPage] = formData.referrer;
                            }

                            if (adoricSessionParams.currentPage) {
                                formData.subscribe[adoricSessionParams.currentPage] = window.location.href;
                            }

                            if (adoricSessionParams.countryCode) {
                                formData.subscribe[adoricSessionParams.countryCode] = formData.country;
                            }
                        }

                        // clear subscribe object, save only actual webhook data
                        delete formData.subscribe.adoricSessionParams

                        // webhook endpoint
                        formData.action = action;
                        formData.enctype = enctype;
                        formData.method = method;
                        // set data for notifications
                        formData.campaignData = {
                            options: {
                                id: self.options.id,
                                userId: self.options.userId,
                                accountId: self.options.userId,
                                campaignTitle: self.options.campaignTitle,
                                title: self.options.title,
                                type: DEVICE_TYPE
                            }
                        };

                        // send to api
                        Util.ajax(WEBHOOK_ACTION, POST_METHOD, formData, function (response) {
                            var message = Element(node).attribute('data-response-message');
                            var errorPadding = 10;

                            // if no need close form without response
                            if (message) {
                                if (response.error) {
                                    if (Element(form).find('.adoric-error-message').elements.length === 0) {
                                        var errorElement = Element('div')
                                            .html(message)
                                            .addClass('adoric-error-message')
                                            .css({
                                                position: 'absolute',
                                                color: 'red',
                                                width: '100%',
                                                textAlign: 'center',
                                                top: parseInt(submitButton.style.top, 10) + parseInt(submitButton.style.height, 10) + errorPadding + 'px'
                                            });

                                        Element(form).append(errorElement);
                                    }

                                    submitButton.removeAttribute('disabled');

                                    return;
                                } else {
                                    formIsSubmited();
                                }
                            } else {
                                formIsSubmited();
                            }
                        });
                    } else {
                        formData = action.indexOf(MAILCHIMP_SUBSCRIBE_ACTION) !== -1 ?
                            Util.serializeForm(node) :
                            Util.serializeListForm(node);

                        // set data for notifications
                        formData.campaignData = {
                            options: {
                                id: self.options.id,
                                userId: self.options.userId,
                                accountId: self.options.userId,
                                campaignTitle: self.options.campaignTitle,
                                title: self.options.title,
                                type: DEVICE_TYPE
                            }
                        };

                        if (typeof action === 'string') {
                            // waiting new mail service

                            action = action
                                .replace(
                                    'api.beta.adoric-om.com',
                                    'beta.adoric.com'
                                );
                            action = action
                                .replace(
                                    'api.adoric-om.com',
                                    'adoric.com'
                                );
                            action = action
                                .replace(
                                    'api.adoric-ads.com',
                                    'adoric.com'
                                );
                        }

                        Util.ajax(action, POST_METHOD, formData, function () {
                            formIsSubmited();
                        });
                    }

                    adoric.trigger(self, OWN_EVENTS.formAfterSubmit, {
                        lightbox: self,
                        lightboxId: self.id,
                        target: form,
                        formType: 'default'
                    });

                    return false;
                });
            });

            return this;
        },

        pushDocument: function () {
            var _domBody = Element(document.getElementsByTagName('BODY')[0]);
            var position = parseInt(this.settings.position, 10);
            var positionOffset = this.settings.positionOffset || {};
            var dist = 0;
            var wrapperHeight = parseInt(this.wrapper.height(), 10)

            if (this.settings.openEffect.enabled) {
                _domBody.css({
                    '-webkit-transition': '1s all 0s',
                    '-o-transition': '1s all 0s',
                    'transition': '1s all 0s',
                });
            }

            if (position === LB_POSITION_TOP_CENTER) {
                dist = parseInt(positionOffset.down || 0) + wrapperHeight;
                _domBody.css({
                    'margin-top': dist + 'px'
                });
            } else if (position === LB_POSITION_BOTTOM_CENTER) {
                dist = -1 * (parseInt(positionOffset.up || 0) + wrapperHeight);
                _domBody.css({
                    'margin-bottom': (-1 * dist) + 'px'
                });
            } else {
                return this;
            }
        },

        retrieveDocument: function(allShownLB) {
            var _domBody = Element(document.getElementsByTagName('BODY')[0]);
            var lbPosition = parseInt(this.options.settings.position, 10);

            if (lbPosition === LB_POSITION_TOP_CENTER) {
                _domBody.css({
                    'margin-top': '0px'
                });
            } else if (lbPosition === LB_POSITION_BOTTOM_CENTER) {
                _domBody.css({
                    'margin-bottom': '0px',
                });
            }

            if(allShownLB.length === 0){
                _domBody.onAnimationEnd(function() {
                    _domBody.css({
                        '-webkit-transition': '',
                        '-o-transition': '',
                        'transition': '',
                        'margin-bottom': '',
                        'margin-top': ''
                    });
                });
            }
        },

        /**
         * Set position for lightbox relative to settings
         * @param value
         * @param offset
         * @returns {Lightbox}
         */
        setPosition: function (value, offset) {
            var self = this;

            offset = offset || {};
            switch (value) {
                case 1:
                    this.wrapper.css({
                        left: (offset.right || 0) + 'px',
                        top: (offset.down || 0) + 'px'
                    });
                    break;
                case 2:
                    this.wrapper.css({
                        left: (((Util.getScreenSize().width / 2) - (this.wrapper.width() / 2)) - parseInt(offset.left || 0) + parseInt(offset.right || 0)) + 'px',
                        top: (offset.down || 0) + 'px'
                    });
                    if (self.settings.positionPush) {
                        if (this.settings.background.enabled || this.settings.closeOnBackground.enabled) {
                            this.background.css({
                                height: (parseInt(this.wrapper.css('height')) + parseInt(offset.down || 0)) + 'px'
                            });
                        }
                        this.footer.css({
                            top: ((parseInt(this.wrapper.css('height')) + parseInt(offset.down || 0)) - 52) + 'px',
                            bottom: 'auto'
                        });
                        if (!self.settings.positionSticky) {
                            if (this.settings.background.enabled || this.settings.closeOnBackground.enabled) {
                                this.background.css({
                                    position: 'absolute'
                                });
                            }
                            this.footer.css({
                                position: 'absolute'
                            });
                            this.wrapper.css({
                                position: 'absolute'
                            })
                        }
                        self.pushDocument();
                    }
                    break;
                case 3:
                    this.wrapper.css({
                        right: (offset.left || 0) + 'px',
                        top: (offset.down || 0) + 'px'
                    });
                    break;
                case 4:
                    this.wrapper.css({
                        marginTop: '-' + this.wrapper.height() / 2 + 'px',
                        top: '50%',
                        left: (offset.right || 0) + 'px'
                    });
                    break;
                case 5:
                    this.wrapper.css({
                        marginTop: '-' + this.wrapper.height() / 2 + 'px',
                        marginLeft: '-' + this.wrapper.width() / 2 + 'px',
                        left: '50%',
                        top: '50%'
                    });
                    break;
                case 6:
                    this.wrapper.css({
                        marginTop: '-' + this.wrapper.height() / 2 + 'px',
                        top: '50%',
                        right: (offset.left || 0) + 'px'
                    });
                    break;
                case 7:
                    this.wrapper.css({
                        bottom: (offset.up || 0) + 'px',
                        left: (offset.right || 0) + 'px'
                    });
                    break;
                case 8:
                    this.wrapper.css({
                        left: (((Util.getScreenSize().width / 2) - (this.wrapper.width() / 2)) - parseInt(offset.left || 0) + parseInt(offset.right || 0)) + 'px',
                        bottom: (offset.up || 0) + 'px'
                    });
                    if (self.settings.positionPush) {
                        if (this.settings.background.enabled || this.settings.closeOnBackground.enabled) {
                            this.background.css({
                                height: (parseInt(this.wrapper.css('height')) + parseInt(offset.up || 0)) + 'px',
                                bottom: 0,
                                top: 'auto'
                            });
                        }
                        this.footer.css({
                            top: 'auto',
                            bottom: '10px'
                        });
                        if (!self.settings.positionSticky) {
                            var body = document.body;
                            var _pageHeight = Math.max(body.scrollHeight, body.offsetHeight, document.documentElement.clientHeight, document.documentElement.scrollHeight, document.documentElement.offsetHeight);

                            if (this.settings.background.enabled || this.settings.closeOnBackground.enabled) {
                                this.background.css({
                                    position: 'absolute',
                                    bottom: 'auto',
                                    top: _pageHeight + 'px'
                                });
                            }
                            this.footer.css({
                                position: 'absolute',
                                top: (_pageHeight + (parseInt(this.wrapper.css('height')) + parseInt(offset.up || 0)) - 52) + 'px',
                                bottom: 'auto'
                            });
                            this.wrapper.css({
                                position: 'absolute',
                                top: _pageHeight + 'px',
                                bottom: 'auto',
                            });
                        }
                        self.pushDocument();
                    }
                    break;
                case 9:
                    this.wrapper.css({
                        bottom: (offset.up || 0) + 'px',
                        right: (offset.left || 0) + 'px'
                    });
                    break;
            }

            return this;
        },

        saveShowLBPerSession: function () {
            var count;

            if (this.show && currentConfig.isVisible) {
                count = this.getShowLBPerSession() + 1;

                Util.localStorageData(storagePrefixes.countShowsLB_ + this.options.campaignId, count);
            }

            return this;
        },

        setIsShowing: function () {
            Util.sessionStorageData(storagePrefixes.isShowing_ + this.options.campaignId, true);
            // set adoric_popup=true to cookie (for Kametera)
            Util.setCookie(cookieItems.adoric_popup, true);

            return this;
        },

        saveBehaviorConditionShowLB: function () {
            var id = this.options.campaignId;
            var parse;
            var count;
            var show;

            if (this.show && currentConfig.isVisible) {
                count = this.getBehaviorConditionShowLB() + 1;
                parse = JSON.parse(Util.localStorageData(localStorageItems.adoric_user_behavior));
                show = parse.show || {};

                if (Object.keys(show).length === 0) {
                    show[id] = count;
                    parse = {
                        show: show
                    };
                } else {
                    parse.show[id] = count;
                }

                Util.localStorageData(localStorageItems.adoric_user_behavior, JSON.stringify(parse));
            }

            return this;
        },

        getBehaviorConditionShowLB: function () {
            var parse = JSON.parse(Util.localStorageData(localStorageItems.adoric_user_behavior));

            return parse && parse.show[this.options.campaignId] || 0;
        },

        getShowLBPerSession: function () {
            return +Util.localStorageData(storagePrefixes.countShowsLB_ + this.options.campaignId);
        },

        getShowCombination: function () {
            var days = 90;
            var combination = JSON.parse(Util.localStorageData(storagePrefixes.adoric_lb_combination) || '[]');

            function lessThan(value) {
                var date = new Date();
                var monthAgo = date.setDate(date.getDate() - days);

                return value >= monthAgo;
            }

            combination.filter(function (item) {
                return lessThan(item[1]);
            });

            return combination;
        },
        /**
         * Get last time when LB was open
         * @return {Integer} Returns miliseconds
         */
        getLastShowTime: function () {
            return +Util.localStorageData(storagePrefixes.showTime_ + this.options.campaignId);
        },

        /**
         * Save time when LB was open on domain
         */
        saveShowTime: function () {
            // show
            var time = Date.now();

            Util.localStorageData(storagePrefixes.showTime_ + this.options.campaignId, time);
            Util.localStorageData(storagePrefixes.showVersionTime_ + (this.options.id || this.options._id), time);

            // combination
            var combination = this.getShowCombination();

            combination.push([this.options.id, time]);

            Util.localStorageData(storagePrefixes.adoric_lb_combination, JSON.stringify(combination));

            /*let array = ['yay', 'yay', 'yay', 'opps', 'yay', 'yay', 'opps', 'opps', 'opps'];

            let modifiedArray = array.reduce((acc, curr) => {
                if (!acc.length) {
                    acc.push([curr, 1]);
                } else {
                    let lastPushedArray = acc[acc.length-1];
                    if (lastPushedArray[0] === curr) {
                        acc[acc.length-1][1]++;
                    } else {
                        acc.push([curr, 1]);
                    }
                }
                return acc;
            }, []);

            console.log(modifiedArray);*/

            return this;
        },

        /**
         * Save click LB to browser, if LB mustn't show again
         */
        saveClickToBrowser: function () {
            var count = this.getBehaviorConditionClickLB() + 1;
            var id = this.options.campaignId;
            var userBehavior = JSON.parse(Util.localStorageData(localStorageItems.adoric_user_behavior));

            !userBehavior.click ? userBehavior.click = {} : userBehavior.click;
            userBehavior.click[id] = count;
            Util.localStorageData(localStorageItems.adoric_user_behavior, JSON.stringify(userBehavior));
            Util.localStorageData(storagePrefixes.clicked_ + id, true);

            return this;
        },

        getBehaviorConditionClickLB: function () {
            var parse = JSON.parse(Util.localStorageData(localStorageItems.adoric_user_behavior));

            return parse.click && parse.click[this.options.campaignId] || 0;
        },

        saveUserBehaviorCloseLB: function () {
            var count = this.getBehaviorConditionCloseLB() + 1;
            var userBehavior = JSON.parse(Util.localStorageData(localStorageItems.adoric_user_behavior));

            !userBehavior.close ? userBehavior.close = {} : userBehavior.close;
            userBehavior.close[this.options.campaignId] = count;
            Util.localStorageData(localStorageItems.adoric_user_behavior, JSON.stringify(userBehavior));

            return this;
        },

        getBehaviorConditionCloseLB: function () {
            var parse = JSON.parse(Util.localStorageData(localStorageItems.adoric_user_behavior));

            return parse.close && parse.close[this.options.campaignId] || 0;
        },


        /**
         * Get click status LB
         * @return {Integer} Returns miliseconds
         */
        isAlreadyClicked: function () {
            return Util.localStorageData(storagePrefixes.clicked_ + this.options.campaignId);
        },

        /**
         * Get click status LB
         * @return {Integer} Returns miliseconds
         */
        hasBeenClosed: function () {
            return Util.localStorageData(storagePrefixes.closed_ + this.options.campaignId);
        },

        /**
         * Parse and replace dynamic variables
         * @returns {Lightbox}
         */
        replaceVariables: function () {
            var urlParams = Util.parseQueryURL(window.location.href.replace(/^[^\?]+\??/, '')),
                elementsWithVariable = Element()
                .find('.element-text')
                .find('.inner-element[data-dynamic-variables="true"]')
                .elements,
                variables,
                tempVal,
                newKey,
                textElements,
                regexpVal,
                textToParse,
                matches;

            if (elementsWithVariable.length) {
                function getReplaceValue(value) {
                    switch (value) {
                        case '{{Referrer domain}}':
                            var referrer = Util.sessionStorageData(sessionStorageItems.adoric_referrer_url) || "";

                            return referrer.replace('http://', '').replace('https://', '').split(/[/?#]/)[0];
                        case '{{Country}}':
                            return JSON.parse(Util.sessionStorageData(sessionStorageItems.adoric_ip_info) || "{}").country || "";
                        case '{{Region}}':
                            return JSON.parse(Util.sessionStorageData(sessionStorageItems.adoric_ip_info) || "{}").region || "";
                        case '{{City}}':
                            return JSON.parse(Util.sessionStorageData(sessionStorageItems.adoric_ip_info) || "{}").city || "";
                        case '{{Device type}}':
                            return (SCREEN_WIDTH > 800) && 'Desktop' || (SCREEN_WIDTH < 600) && 'Mobile' || 'Tablet';
                        case '{{Operating system}}':
                            return Util.getOSName().osFullName;
                        case '{{Browser name}}':
                            return Util.getBrowserName();
                        default:
                            return "";
                    }
                }

                Array.prototype.forEach.call(elementsWithVariable, function (txtElem) {
                    textToParse = Element(txtElem).html();
                    matches = textToParse.match(new RegExp('{\{(.+?)\}\}', 'ig'));

                    matches && matches.length && matches.forEach(function (match) {
                        textToParse = textToParse.replace(new RegExp(match, 'ig'), getReplaceValue(match));
                        Element(txtElem).html(textToParse);
                    });
                });
            }

            if (window.location.href.indexOf('adoric_var_') === -1) return this;

            //params from url
            for (var paramKey in urlParams) {
                tempVal = urlParams[paramKey];
                delete urlParams[paramKey];
                if (paramKey.indexOf('adoric_var_') >= 0) {
                    newKey = paramKey.replace('adoric_var_', '');
                    urlParams[newKey] = tempVal;
                }
            }
            adoric.dynamicVars = Util.assign(urlParams, adoric.dynamicVars);
            if (adoric.dynamicVars) {
                textElements = Element().find('.element-text').find('.inner-element').elements;
                variables = adoric.dynamicVars;
                Array.prototype.forEach.call(textElements, function (txtElem) {
                    for (var key in variables) {
                        textToParse = Element(txtElem).html();
                        regexpVal = new RegExp('%%' + key + '%%', 'ig');
                        if (regexpVal.test(textToParse)) {
                            Element(txtElem).html(textToParse.replace(regexpVal, variables[key]));
                        }
                    }
                });
            }
            return this;
        },

        preShow: function (options) {
            var scale = parseFloat(this.getSettings('scaleMobile.value')) / 100;
            var body = document.body;
            var pageHeight = Math.max(body.scrollHeight, body.offsetHeight, document.documentElement.clientHeight, document.documentElement.scrollHeight, document.documentElement.offsetHeight);

            if (this.settings.background.enabled || this.settings.closeOnBackground.enabled) {
                this.background.css({
                    position: 'fixed',
                    width: '100%',
                    height: (this.settings.disabledOverflowCheckbox ? pageHeight + 'px' : '100%'),
                    left: 0,
                    top: 0,
                    zIndex: 900000000000,
                    background: this.settings.background.value || 'transparent',
                    '-webkit-transition': 'opacity 1s',
                    '-moz-transition': 'opacity 1s',
                    '-o-transition': 'opacity 1s',
                    transition: 'opacity 1s'
                });

                this.background.appendToBody();
            }
            this.wrapper.css({
                borderRadius: this.settings.background.borderRadius || 'none',
                position: 'fixed',
                outline: 'none',
                overflow: this.settings.disabledOverflowCheckbox ? overflow = 'none' : overflow = 'hidden',
                zIndex: 900000000001,
                transform: this.getSettings('scaleMobile.enabled') ? 'scale(' + scale + ')' : 'none'
            });
            this.wrapper.appendToBody();
            this.wrapperContent = Element('#editorContainer').css({
                outline: 'none'
            });

            if (showAdoricBranding || (currentPlanLimits && Object.keys(currentPlanLimits).length && !currentPlanLimits.branding)) {
                this.showFooter();
            }
            Element('.' + this.identifier).css({
                display: 'none'
            });

            this.preShowed = true;

            return this;
        },

        postShow: function (options) {
            var self = this;
            var reason = (typeof options === 'object') ? options.reason : options;
            var forced = (typeof options === 'object') ? options.forced : false;
            var showsPerSession = +Util.sessionStorageData(sessionStorageItems.showed);
            var position = +this.settings.position;
            var positionOffset = this.settings.positionOffset || {};

            function isNeedCancelShow() {
                return (self.showed ||
                    self.isShowing ||
                    (currentDomain.showsPerSession && showsPerSession >= currentDomain.showsPerSession &&
                        (!currentDomain.ignoreLimitShow || currentDomain.ignoreLimitShow.indexOf(self.options.campaignId) === -1)) ||
                    !self.checkAllEvents() ||
                    !self.checkSelectors() ||
                    !self.checkUserBehaviorConditions() ||
                    !self.checkShowAtSameTime() ||
                    !self.checkVisitors('returning', 'new', 'buyer') ||
                    !self.checkGlobalConditions()
                );
            }

            //canceling showing lb
            if (!forced && isNeedCancelShow()) {
                return this;
            }

            if (!(currentLift && currentLift.excludedLbs &&
                    currentLift.excludedLbs.length &&
                    ~currentLift.excludedLbs.indexOf(this.options.campaignId)) && currentConfig.trackUser) {

                if (!Util.localStorageData(localStorageItems.adoric_saw_lightbox)) {
                    Util.localStorageData(localStorageItems.adoric_saw_lightbox, true);
                    Util.ajax(UPDATE_USER_API_URL, GET_METHOD, {
                        id: Util.localStorageData(localStorageItems.adoric_uniq_day_id) ||
                            Util.getCookie(cookieItems.adoric_uniq_day_id)
                    })
                }

                if (!LiftTest.isNeedShow()) {
                    return this;
                }
            }

            this.isShowing = true;
            this.showed = true;
            this.isClosed = false;

            adoric.trigger(this, OWN_EVENTS.lbBeforeShow, {
                lightbox: this,
                lightboxId: this.id,
                reason: reason,
                userId: currentUserId,
                planType: currentPlanType,
                planId: currentPlanId,
                domainId: currentDomain._id,
                isVisible: currentConfig.isVisible
            });

            if (!currentDomain.ignoreLimitShow || currentDomain.ignoreLimitShow.indexOf(this.options.campaignId) === -1 && currentConfig.isVisible) {
                if (Util.sessionStorageData(sessionStorageItems.showed)) {
                    Util.sessionStorageData(sessionStorageItems.showed, showsPerSession + 1);
                } else {
                    Util.sessionStorageData(sessionStorageItems.showed, 1)
                }
            }
            currentConfig.isVisible && this.increaseShow();

            this.saveShowTime()
                .bindEscKeyPress()
                .bindCloseAction()
                .bindAutoClose()
                .bindLinksToSBs()
                .bindTimerCallback()
                .bindSmartLink()
                .bindClicksToDynamicLinks()
                .bindClickToConversionTarget()
                .replaceVariables()
                .saveShowLBPerSession()
                .saveBehaviorConditionShowLB()
                .setIsShowing()
                .bindAjaxForm();
            // if need to disable scroll after show
            if (this.settings.disableScrollOnOpen) {
                scrollModule.disableScroll();
            }
            // for LB showed by click on link
            if (!this.settings.notShowClicked || (this.settings.notShowClicked && !this.isAlreadyClicked())) {
                this.bindIncreaseClickAction()
            }
            //"eval" js in script tags
            Array.prototype.forEach.call(this.wrapper.getDOMElements().querySelectorAll('script'), Util.runScript);
            if (currentConfig.isVisible) {
                Element('.' + this.identifier).css({
                    display: 'block'
                });
            }
            /**
             *delete old animated options and redirect position options
             */
            if (this.settings.animated && this.settings.animated.positionAnimated) {
                this.setPosition(5);
            }
            /**
             * and
             */
            this.setPosition(position, positionOffset);
            adoric.trigger(this, OWN_EVENTS.lbAfterShow, {
                lightbox: this,
                lightboxId: this.id,
                reason: reason,
                userId: currentUserId,
                planType: currentPlanType,
                planId: currentPlanId,
                domainId: currentDomain._id,
                isVisible: currentConfig.isVisible
            });

            return this;
        },

        /**
         * Show lightbox in document
         */
        show: function (options) {
            if (this.isShowing) {
                return this;
            }
            if (this.isClosed) {
                this.createHtml();
            }
            if (!this.preShowed) {
                this.preShow(options);
            }

            this.postShow(options);

            return this;
        },

        /**
         * Close lightbox and destroy or our dependencies
         */
        close: function (reason) {
            var self = this;

            if (this.isClosed) {
                return this;
            }

            function removeThisSB() {
                Element('.' + self.identifier).remove();
                self.isClosed = true;
                self.preShowed = false;
                self.isShowing = false;
                self.wrapper = null;

                if (self.options.settings.positionPush) {
                    var allShownLB = adoric.lightboxes.filter(function(lb){
                        return lb.isShowing && lb.options.settings.positionPush;
                    })

                    self.retrieveDocument(allShownLB);
                }
            }

            adoric.trigger(this, OWN_EVENTS.lbBeforeClose, {
                lightbox: self,
                lightboxId: self.id,
                reason: reason,
                userId: currentUserId,
                planType: currentPlanType,
                planId: currentPlanId,
                domainId: currentDomain._id,
                isVisible: currentConfig.isVisible
            });
            self.background.css({
                opacity: '0'
            });
            if (self.settings.closeEffect.enabled && self.showed) {
                if (self.settings.openEffect.enabled) {
                    self.wrapper.removeClass(self.settings.openEffect.value);
                }
                self.wrapper.addClass('animated');
                self.wrapper.addClass(self.settings.closeEffect.value);
                self.wrapper.onAnimationEnd(removeThisSB);
            } else {
                removeThisSB();
            }

            adoric.trigger(this, OWN_EVENTS.lbAfterClose, {
                lightbox: self,
                lightboxId: self.id,
                reason: reason,
                userId: currentUserId,
                planType: currentPlanType,
                planId: currentPlanId,
                domainId: currentDomain._id,
                isVisible: currentConfig.isVisible
            });

            if (~[CLOSED_BY_CLICK_LINK_REDIRECT, CLOSED_BY_SUBMIT_FORM, CLOSED_BY_CLOSE_ELEMENT].indexOf(reason)) {
                Util.localStorageData(storagePrefixes.closed_ + self.options.campaignId, true);
            }

            /* if scrolling page was disabled */
            if (this.settings.disableScrollOnOpen) {
                scrollModule.enableScroll();
            }

            if (AdoricTracking.state !== "error" && this.getSettings('GA.closeLightboxGA')) {
                AdoricTracking.sendEvent(this.options.campaignTitle ? 'Adoric - ' + this.options.campaignTitle : 'Adoric - ' + this.options.title, "Close", this.options.title);
            }

            Util.sessionStorageData().removeItem(storagePrefixes.isShowing_ + self.options.campaignId);

            return this;
        },

        /**
         * Triggers when user clicks on Subscribe button, etc...
         * @return {[type]} [description]
         */
        increaseClick: function (data) {
            var self = this;

            if (this.isClicked) {
                return this;
            }
            this.isClicked = true;

            function afterClick() {
                adoric.trigger(this, OWN_EVENTS.lbAfterCLick, {
                    lightbox: self,
                    lightboxId: self.id,
                    track: data.track,
                    target: data.target,
                    reason: data.reason,
                    userId: currentUserId,
                    planType: currentPlanType,
                    planId: currentPlanId,
                    domainId: currentDomain._id
                });
            }
            adoric.trigger(this, OWN_EVENTS.lbBeforeClick, {
                lightbox: this,
                lightboxId: this.id,
                track: data.track,
                target: data.target,
                reason: data.reason,
                userId: currentUserId,
                planType: currentPlanType,
                planId: currentPlanId,
                domainId: currentDomain._id
            });
            if (!self.statistic) {
                return this;
            }

            self.saveClickToBrowser();

            Util.ajax(LIGHTBOX_INCREASE_CLICK_API_URL, GET_METHOD, {
                lightboxId: self.id,
                statisticId: self.statistic._id,
                campaignId: self.options.campaignId || self.options.parent || self.id,
                eventName: data.eventName,
                eventValue: data.eventValue,
                clientId: CLIENT_ID,
                domainId: currentDomain._id,
                robotStatisticId: self.options.robotStatisticId || null,
            }, afterClick.bind(self));

            if (AdoricTracking.state !== "error" && this.getSettings('GA.clicksOnLightboxGA')) {
                AdoricTracking.sendEvent(this.options.campaignTitle ? 'Adoric - ' + this.options.campaignTitle : 'Adoric - ' + this.options.title, "Click", this.options.title);
            }

            return this;
        },

        /**
         * Triggers when LB is showed
         */
        increaseShow: function () {
            var self = this,
                newPeople = '';

            if (!Util.localStorageData(storagePrefixes.showTime_ + self.options.campaignId)) {
                newPeople = true
            }

            Util.ajax(LIGHTBOX_INCREASE_SHOW_API_URL, GET_METHOD, {
                lightboxId: self.id,
                campaignId: self.options.campaignId || self.options.parent || self.id,
                domainId: currentDomain._id,
                planId: currentPlanId,
                planType: currentPlanType,
                userId: currentUserId,
                newPeople: newPeople,
                clientId: CLIENT_ID,
                robotStatisticId: self.options.robotStatisticId || null,
                robotId: self.options.robotId || null
            }, function (response) {
                if (response.statistic) {
                    self.statistic = response.statistic;
                    if (AdoricTracking.state !== "error" && self.settings.GA && self.settings.GA.lightboxImpressionsGA) {
                        AdoricTracking.sendEvent(self.options.campaignTitle ? 'Adoric - ' + self.options.campaignTitle : 'Adoric - ' + self.options.title, "Impression", self.options.title);
                    }
                } else {
                    console.info('increse show:', response);
                }
            });

            return this;
        },

        /**
         * Execute callback when lightbox will be loaded
         */
        onLoad: function (callback) {
            var self = this;

            self.timeout(function () {
                if (self.isLoaded()) {
                    callback.call(self);
                } else {
                    self.timeout(arguments.callee, 0);
                }
            }, 0);

            return this;
        },
        /**
         * Execute callback when lightbox will receive empty HTML
         */
        onEmpty: function (callback) {
            var self = this;
            self.timeout(function () {
                if (self.isEmpty()) {
                    callback.call(self);
                } else {
                    self.timeout(arguments.callee, 0);
                }
            }, 0);

            return this;
        },
        /**
         * Check if lightbox loaded now
         */
        isLoaded: function () {
            return this.loaded && this.isHTMLExists() && ADORIC_STYLES_LOADED;
        },
        /**
         * Check if HTML got but empty
         */
        isEmpty: function () {
            return this.loaded && !this.isHTMLExists();
        },
        /**
         * Check if lightbox was showed up
         */
        isShowed: function () {
            return this.showed && this.isHTMLExists();
        },
        /**
         * Check if HTML was loaded into wrapper child
         */
        isHTMLExists: function () {
            return this.wrapper.html() != EMPTY_LIGHTBOX && this.wrapper.html() !== '';
        }
    };

    if (!window.IS_ADORIC_LOADED) {
        window.IS_ADORIC_LOADED = true;
        CLIENT_ID = Util.getClientID();
        var oldOnLoad = ADORIC_SCRIPT.onload;
        ADORIC_SCRIPT.onload = function () {};
        //global listeners

        (function Adoric(window) {
            var campaignVersionsToInit = [];

            /**
             * @param campaign
             * @return version ID
             */
            function getVersionFromCampaign(campaign) {
                /* if (!campaign.versions) {
                    // strange bug after filter by type, some type property versions is removed
                    campaign.versions = {};
                } */

                var versionsIds = Object.keys(campaign.versions);
                var campaignSelectedVersionId = null;

                campaign.versionsEnabled = Object
                    .keys(campaign.versions)
                    .filter(function (item) {
                        return (campaign.versions[item].weight !== 0) && !campaign.versions[item].deleted
                    });

                var noNeedShowVersion = versionsIds.some(function (versionId) {
                    if (Util.localStorageData(storagePrefixes.selectedVersion_ + versionId) &&
                        campaign.versionsEnabled.indexOf(versionId) === -1) {
                        return true;
                    }
                });

                if (noNeedShowVersion) {
                    //client saw versions but she is disabled now
                    currentConfig.debugMode &&
                        console.log("VERSION " + campaignSelectedVersionId + " => saw -> true; enabled -> false");
                    return campaignSelectedVersionId
                }

                versionsIds.forEach(function (versionId) {
                    if (!campaignSelectedVersionId &&
                        Util.localStorageData(storagePrefixes.selectedVersion_ + versionId) &&
                        campaign.versionsEnabled.indexOf(versionId) !== -1) {
                        campaignSelectedVersionId = versionId
                    }
                });

                if (campaignSelectedVersionId) {
                    //client already saw version and she is enabled now
                    currentConfig.debugMode &&
                        console.log("VERSION " + campaignSelectedVersionId + "=> saw -> true; enabled -> true");
                    return campaignSelectedVersionId
                } else {
                    //client did not see this campaign need select versions by weight
                    currentConfig.debugMode &&
                        console.log("VERSION " + campaignSelectedVersionId + "=> saw -> false; enabled -> true");

                    function getRandomByWeight() {
                        var versionsTotalWeight = 0,
                            versionsSumWeight = 0,
                            i;

                        //@return [[versionId, weight],[versionId, weight],[versionId, weight] ...]
                        var versionsEnabled = Object.keys(campaign.versions).filter(function (item) {
                            if (campaign.versions[item].type === DEVICE_TYPE &&
                                campaign.versions[item].weight !== 0 &&
                                !campaign.versions[item].deleted) {
                                return item
                            }
                        }).map(function (item) {
                            return [item, campaign.versions[item].weight || 0]
                        });

                        // sum up the weights
                        for (i = 0; i < versionsEnabled.length; i++) {
                            versionsTotalWeight += versionsEnabled[i][1];
                        }
                        var random = Math.floor(Math.random() * versionsTotalWeight);

                        // now find which bucket out random value is in
                        for (i = 0; i < versionsEnabled.length; i++) {
                            versionsSumWeight += versionsEnabled[i][1];
                            if (random < versionsSumWeight) {
                                return (versionsEnabled[i]);
                            }
                        }
                    }

                    //get 1 version from campaign.versions
                    campaignSelectedVersionId = (getRandomByWeight() || [])[0];

                    //save version ID to localStorage
                    Util.localStorageData(storagePrefixes.selectedVersion_ + campaignSelectedVersionId, true);

                    adoric.trigger(campaign, OWN_EVENTS.versionSelected, {
                        campaignId: campaign._id,
                        versionsId: campaignSelectedVersionId,
                        userId: currentUserId,
                        planType: currentPlanType,
                        planId: currentPlanId,
                        domainId: currentDomain._id,
                        isVisible: currentConfig.isVisible
                    });

                    return campaignSelectedVersionId;
                }
            }

            function initLightbox(lightbox) {
                if (lightbox && lightbox.html) {
                    adoric.trigger(this, OWN_EVENTS.lbBeforeInit, {
                        lightbox: lightbox,
                        lightboxId: lightbox.id,
                        isVisible: currentConfig.isVisible
                    });
                    adoric.lightboxes || (adoric.lightboxes = []);
                    adoric.lightboxes[adoric.lightboxes.length] = Lightbox(lightbox).onLoad(function () {
                        try {
                            this.init();
                        } catch (error) {
                            var errorData = {
                                error: error || navigator && navigator.userAgent,
                                lightboxId: this.id,
                                domainId: currentDomain._id,
                                planId: currentPlanId,
                                planType: currentPlanType,
                                userId: currentUserId,
                                clientId: CLIENT_ID
                            };

                            console.error('_Adoric_error: init lb error:', error);
                            adoric.trigger(this, OWN_EVENTS.lbInitError, {
                                lightbox: this,
                                errorData: errorData,
                                lightboxId: this.id,
                                isVisible: currentConfig.isVisible
                            });
                            Util.ajax(LIGHTBOX_INCREASE_ERROR_API_URL, GET_METHOD, errorData);
                        }
                        adoric.trigger(this, OWN_EVENTS.lbAfterInit, {
                            lightbox: this,
                            lightboxId: this.id,
                            isVisible: currentConfig.isVisible
                        });
                    });
                }
            }

            function initLightboxes() {
                campaignVersionsToInit.forEach(initLightbox);
                if (!currentInitedCount) {
                    adoric.trigger(this, OWN_EVENTS.lbNoLoad, {
                        error: currentInitError
                    });
                }

                refreshProcessing = {
                    ranning: false,
                    location: null
                };
            }

            function showLightbox(lightbox) {
                if (lightbox && lightbox.html) {
                    Lightbox(lightbox).onLoad(function () {
                        try {
                            this.show();
                        } catch (error) {
                            var errorData = {
                                error: error || navigator && navigator.userAgent,
                                lightboxId: this.id,
                                domainId: currentDomain._id,
                                planId: currentPlanId,
                                planType: currentPlanType,
                                userId: currentUserId,
                                clientId: CLIENT_ID
                            };
                            console.error('_Adoric_error: show lb error:', error);
                            Util.ajax(LIGHTBOX_INCREASE_ERROR_API_URL, GET_METHOD, errorData);
                        }
                    });
                }
            }

            function showOtherVersion(version) {
                Lightbox(version).onLoad(function () {
                    this.preShow();

                    this.isShowing = true;
                    this.showed = true;
                    this.isClosed = false;

                    currentConfig.isVisible && this.increaseShow();

                    this.saveShowTime()
                        .bindEscKeyPress()
                        .bindCloseAction()
                        .bindAutoClose()
                        .bindLinksToSBs()
                        .bindTimerCallback()
                        .bindSmartLink()
                        .bindClicksToDynamicLinks()
                        .bindClickToConversionTarget()
                        .replaceVariables()
                        .saveShowLBPerSession()
                        .saveBehaviorConditionShowLB()
                        .setIsShowing()
                        .bindAjaxForm();

                    // if need to disable scroll after show
                    if (this.settings.disableScrollOnOpen) {
                        scrollModule.disableScroll();
                    }
                    this.bindIncreaseClickAction();
                    //"eval" js in script tags
                    Array.prototype.forEach.call(this.wrapper.getDOMElements().querySelectorAll('script'), Util.runScript);
                    if (currentConfig.isVisible) {
                        Element('.' + this.identifier).css({
                            display: 'block'
                        });
                    }

                    this.setPosition(+this.settings.position, (this.settings.positionOffset || {}));

                    return this;
                });
            }

            function clearAllowedShow() {
                Util.localStorageData(localStorageItems.adoric_events_obj, '');
            }

            /**
             * Loads data from server
             */
            function apiLoadData() {
                var params = Util.parseScriptParameters(),
                    user = params.key,
                    domain = window.location.hostname,
                    href = window.location.href,
                    countryCode = Util.sessionStorageData(sessionStorageItems.country_code_cache),
                    currentShowsPerSession = Util.sessionStorageData(sessionStorageItems.showed),
                    browser = Util.getBrowserName(),
                    os = Util.getOSName().os,
                    device = DEVICE_TYPE,
                    partDay = Util.getPartOfDay(new Date().getHours()),
                    language;

                if (navigator.languages) {
                    if (navigator.languages instanceof Array) {
                        language = (navigator.languages[0] || navigator.language)
                    } else {
                        language = navigator.languages
                    }
                } else {
                    language = (navigator.browserLanguage || navigator.language || navigator.systemLanguage ||
                        navigator.userLanguage).slice(0, 2)
                }

                language = language.split('-')[0];
                language = language || "en";

                currentCountry = countryCode;
                currentLanguage = language;
                Util.ajax(LIGHTBOX_API_URL, GET_METHOD, {
                    user: user,
                    language: language,
                    countryCode: countryCode,
                    browser: browser,
                    os: os,
                    href: href,
                    device: device,
                    limitShowPerSession: currentShowsPerSession,
                    partDay: partDay,
                    newVisit: JSON.parse(Util.localStorageData(localStorageItems.adoric_visitors) || '[]').length <= 1,
                    tz: new Date().getTimezoneOffset()
                }, function (response) {
                    campaignVersionsToInit = [];

                    var campaigns = response.campaigns;

                    currentConfig.fastFonts = response.fastFonts;
                    currentConfig.analytics = response.analytics;
                    currentConfig.trackUser = response.trackUser;
                    currentUserId = response.userId || currentUserId;
                    currentPlanId = response.plan && response.plan._id || currentPlanId;
                    currentDomain = response.domain || currentDomain;
                    currentPlanType = response.planType || currentPlanType;
                    currentPlanLimits = response.planLimits || currentPlanLimits;
                    currentGoals = response.goals || currentGoals;
                    currentLift = response.lift || currentLift;
                    currentExposure = response.exposure || currentExposure;
                    showAdoricBranding = response.showAdoricBranding || !!showAdoricBranding;

                    if (campaigns && campaigns.length > 0) {
                        var checkCorrectDomainAndUser = campaigns.every(function (campaign) {
                            return campaign.domainId === currentDomain._id && campaign.userId === currentUserId;
                        });

                        if (!checkCorrectDomainAndUser) {
                            console.error('CAMPAIGNS IS INCORRECT');
                            return false;
                        }
                    }

                    if (!currentDomain || !currentDomain.enabled) return;

                    //run lift test for the client
                    LiftTest.run(currentLift);
                    //init google analytics module tracking
                    AdoricTracking.init(currentDomain);
                    //create window.adoric and init EventEmitter
                    onAdoricReady();

                    adoric.trigger(this, OWN_EVENTS.locationAfterDetect, {
                        countryCode: countryCode,
                        isVisible: currentConfig.isVisible
                    });
                    adoric.trigger(this, OWN_EVENTS.lbBeforeLoad, {
                        user: user,
                        domain: domain,
                        href: href,
                        pathname: window.location.pathname,
                        language: language,
                        countryCode: countryCode,
                        browser: browser,
                        os: os,
                        isVisible: currentConfig.isVisible
                    });
                    if (response.error) {
                        adoric.trigger(this, OWN_EVENTS.lbNoLoad, {
                            error: response.error,
                            reason: NO_CAMPAIGN_FOR_URL
                        });
                    }
                    adoric.trigger(this, OWN_EVENTS.lbAfterLoad, {
                        response: response,
                        campaigns: campaigns,
                        userId: response.userId,
                        planId: response.plan ? response.plan._id : false,
                        plan: response.plan,
                        domain: response.domain,
                        domainId: response.domain ? response.domain._id : false,
                        planType: response.planType,
                        fastFons: response.fastFonts,
                        isVisible: currentConfig.isVisible,
                        error: response.error
                    });

                    if (campaigns && campaigns.length) {
                        var id;
                        //get 1 version from campaign and push to campaignVersionsToInit
                        for (var i = 0; i < campaigns.length; i++) {
                            id = getVersionFromCampaign(campaigns[i]);

                            if (id) {
                                campaignVersionsToInit.push({
                                    id: id,
                                    settings: campaigns[i].settings,
                                    campaignId: String(campaigns[i]._id),
                                    campaignTitle: String(campaigns[i].campaignTitle),
                                    type: DEVICE_TYPE,
                                    title: String(campaigns[i].title),
                                    userId: String(campaigns[i].userId),
                                    robotId: String(campaigns[i].robotId || ""),
                                    robotStatisticId: String(campaigns[i].robotStatisticId || "")
                                });
                            }
                        }

                        if (campaignVersionsToInit.length) {

                            //random sort to show capmaigns with same triggers in randomly order
                            if (campaignVersionsToInit.length > 1) {
                                campaignVersionsToInit.forEach(function (item) {
                                    item.__tmp = Math.random();
                                });
                                campaignVersionsToInit = campaignVersionsToInit.sort(function (a, b) {
                                    return a.__tmp > b.__tmp ? 1 : -1;
                                });
                                campaignVersionsToInit.forEach(function (item) {
                                    delete item.__tmp
                                });
                            }

                            //get html and settings for specific versions
                            Util.ajax(LIGHTBOX_HTML_API_URL, GET_METHOD, {
                                ids: campaignVersionsToInit.map(function (version) {
                                    return version.id
                                }).join(',')
                            }, function (htmlsAdnSettings) {
                                campaignVersionsToInit.forEach(function (version) {
                                    if (htmlsAdnSettings[version.id]) {
                                        //replace data-onclick and data-onsubmit (feature onclick in editor)
                                        htmlsAdnSettings[version.id].html = htmlsAdnSettings[version.id].html
                                            .replace(/data-onclick/g, "onclick")
                                            .replace(/data-onsubmit/g, "onsubmit");

                                        //set versions properties to campaign settings
                                        version.html = htmlsAdnSettings[version.id].html;
                                        version.settings.background = version.settings.robotBackground || htmlsAdnSettings[version.id].settings.background;
                                        version.settings.fontsLink = htmlsAdnSettings[version.id].settings.fontsLink;
                                        version.settings.openEffect = version.settings.robotOpenEffect || htmlsAdnSettings[version.id].settings.openEffect;
                                        version.settings.position = version.settings.robotPosition || htmlsAdnSettings[version.id].settings.position;
                                        version.settings.scaleMobile = htmlsAdnSettings[version.id].settings.scaleMobile;
                                        version.settings.closeEffect = htmlsAdnSettings[version.id].settings.closeEffect;
                                        version.settings.positionOffset = htmlsAdnSettings[version.id].settings.positionOffset;
                                        version.settings.positionPush = htmlsAdnSettings[version.id].settings.positionPush;
                                        version.settings.positionSticky = htmlsAdnSettings[version.id].settings.positionSticky;
                                        version.settings.disabledOverflowCheckbox = htmlsAdnSettings[version.id].settings.disabledOverflowCheckbox;
                                        version.title = htmlsAdnSettings[version.id].title
                                    }
                                });

                                //init campaigns, start this.preShow() and this.initShow()
                                Util.onDocumentReady(initLightboxes);
                            });
                        }
                    }

                });
            }

            /**
             * updating adoric config
             * @param options object with configuration to update
             *
             * example of use:
             * adoric.trigger(this, 'setConfig', {
             *  isVisible: false
             * });
             */
            function setConfig(options) {
                var ACCEPTABLE_SETTINGS = [
                    'isVisible',
                    'debugMode'
                ];

                if (typeof options !== 'object') {
                    console.warn('_Adoric_: setting config failed. Invalid params passed, must be an object!');
                    return;
                }
                if (typeof options.isVisible === 'string') {
                    console.warn('_Adoric_: setting config failed. isVisible option passed in string type, ' +
                        'must be boolean. Checking is it == "true"');
                    options.isVisible = (options.isVisible !== 'false');
                }

                for (var name in options) {
                    if (options.hasOwnProperty(name) || (ACCEPTABLE_SETTINGS.indexOf(name) !== -1)) {
                        if (currentConfig[name] === options[name]) {
                            console.info(Util.getExactTime(), '_Adoric_info: Config: "' + name + '" is up-to-date: ' + options[name])
                        } else {
                            console.info(Util.getExactTime(), '_Adoric_info: Setting config "' + name + '": ' + currentConfig[name] + ' -> ' + options[name]);
                            currentConfig[name] = options[name];
                        }
                    }
                }
            }

            /**
             * Adoric starts work from here
             * Loading adoric data
             */
            function start() {
                currentSessionId = Math.random();

                var countryCode = Util.sessionStorageData(sessionStorageItems.country_code_cache);

                if (countryCode) {
                    apiLoadData();
                } else {
                    var getCountryCodeWithDelay = setTimeout(function () {
                        Util.ajax(LOCATION_API_URL_2, function (location) {
                            if (!Util.sessionStorageData(sessionStorageItems.country_code_cache) && location && location.country) {
                                countryCode = location ? (location.country_code || location.country ? location.country.iso || 'IL' : 'IL') : 'IL';
                                Util.sessionStorageData(sessionStorageItems.country_code_cache, countryCode);
                                Util.sessionStorageData(sessionStorageItems.adoric_ip_info, JSON.stringify({
                                    city: location.city.name_en,
                                    region: location.region.name_en,
                                    country: location.country.name_en,
                                }));
                                apiLoadData();
                            }
                        });
                    }, 1500);

                    Util.ajax(LOCATION_API_URL_0, GET_METHOD, function (location) {
                        if (!Util.sessionStorageData(sessionStorageItems.country_code_cache) && location && location.country) {
                            countryCode = (location.country.country ? location.country.country.iso_code : (location.country.continent ? location.country.continent.code : countryCode));
                            clearTimeout(getCountryCodeWithDelay);
                            Util.sessionStorageData(sessionStorageItems.country_code_cache, countryCode);
                            if (Object.keys(location.city).length) {
                                Util.sessionStorageData(sessionStorageItems.adoric_ip_info, JSON.stringify({
                                    city: location.city && location.city.city && location.city.city.names.en,
                                    region: location.city.subdivisions && location.city.subdivisions[0].names.en,
                                    country: location.city.registered_country && location.city.registered_country.names.en,
                                }));
                            }
                            apiLoadData();
                        }
                    });
                }
            }

            function sendAnalyticEvent(name, data) {
                var showedLbData = Util.getAllShowedLB();
                var withAdoric = showedLbData.withAdoric;
                var showedLbs = showedLbData.showedLbs;
                var eventData = {
                    name: name,
                    user: currentUserId,
                    unique: data.unique,
                    domainId: currentDomain._id,
                    geo: Util.sessionStorageData(sessionStorageItems.country_code_cache),
                    withAdoric: withAdoric,
                    lightboxes: JSON.stringify(showedLbs),
                    clientId: CLIENT_ID
                };

                if (!currentConfig.analytics || ~currentConfig.excludeEvents.indexOf(name)) {
                    return;
                }
                if (!eventData.user) {
                    currentConfig.debugMode && console.error('user is not recognized!');
                    return;
                }
                if (data) {
                    if (isNaN(data)) {
                        eventData.value = data.value;
                    } else {
                        eventData.value = data;
                    }
                }
                Util.ajax(TRACK_EVENT_API_URL, GET_METHOD, eventData, function (response) {
                    if (currentConfig.debugMode) {
                        console.log('successfully tracked event - ' + name, response);
                    }
                });
            }

            function checkAllEvents(allowEvents, cancelEvents) {
                var cancelledSince = Conditions.checkCancelEvents(cancelEvents);
                var isAllowed;
                var waitingAllow;
                var allowedSince;

                if (allowEvents && allowEvents.length && allowEvents[0].length) {
                    waitingAllow = true;
                    allowedSince = Conditions.checkConditions(allowEvents)
                } else {
                    waitingAllow = false;
                    allowedSince = 0
                }
                if (cancelledSince > 0) {
                    waitingAllow = true
                }
                isAllowed = !waitingAllow || (allowedSince > cancelledSince);

                return isAllowed;
            }

            function checkBasedOnEventConditions(eventName) {
                var lightboxes = campaignVersionsToInit;
                var conditions;
                var needCheckEvent;

                lightboxes.forEach(function (lightbox) {
                    var settings = lightbox.settings;

                    conditions = Util
                        .actualizeEventSettings(settings.eventEmitterOptions.allowShowOnEvents)
                        .concat(Conditions[settings.betweenEventsConditions] || Conditions.OR, Util.actualizeEventSettings(settings.allowShowHardcoded));

                    conditions.forEach(function (condition) {
                        if (Array.isArray(condition)) {
                            condition.forEach(function (item) {
                                if (Array.isArray(item)) {
                                    item = item.join(':');
                                }
                                needCheckEvent = (item === eventName);

                                if (needCheckEvent && checkAllEvents(conditions, settings.eventEmitterOptions.cancelShowOnEvents)) {
                                    console.info(Util.getExactTime(), '_Adoric_info: "versionSelectedBasedOnEventConditions" trigger');
                                    adoric.trigger(this, OWN_EVENTS.versionSelectedBasedOnEventConditions, {
                                        lightboxId: lightbox.id,
                                        lightbox: lightbox,
                                        userId: currentUserId,
                                        planType: currentPlanType,
                                        planId: currentPlanId,
                                        domainId: currentDomain._id,
                                        isVisible: currentConfig.isVisible
                                    });
                                }
                            })
                        }
                    });
                });
            }

            function refresh() {
                if (refreshProcessing.ranning && refreshProcessing.location === window.location.href) {
                    // fix if user for example run adoric.refresh();adoric.refresh() (2 times)
                    console.info('you run a new refresh before done previous refresh()');
                    return;
                }

                refreshProcessing = {
                    ranning: true,
                    location: window.location.href
                };

                ADORIC_SCRIPT_LOAD_TIME = Date.now();
                currentSessionId = Math.random();

                Util.countReachingPage();
                Util.saveURLConditions();
                Util.removeIsShowingItems();

                adoric.lightboxes && adoric.lightboxes.forEach(function (lightbox) {
                    lightbox.showed = false;
                    lightbox.close(CLOSED_BY_REFRESH)
                });

                adoric.lightboxes = [];

                for (var node in _eventHandlers) {
                    var eventHandlers = _eventHandlers[node];

                    for (var handler in eventHandlers)
                        if (eventHandlers.hasOwnProperty(handler)) {
                            if (eventHandlers[handler] instanceof Array) {

                                eventHandlers[handler].forEach(function (item) {
                                    if (eventHandlers.element.removeEventListener) {
                                        eventHandlers.element.removeEventListener(handler, item[0], item[1] || false);
                                    } else {
                                        eventHandlers.element.detachEvent('on' + handler, item[0]);
                                    }
                                });
                            }
                        }
                }

                apiLoadData();
            }

            function onAdoricReady() {
                var triggerArguments = window.adoric && window.adoric.trigger && window.adoric.trigger.arg || [];
                var onArguments = window.adoric && window.adoric.on && window.adoric.on.arg || [];
                var offArguments = window.adoric && window.adoric.off && window.adoric.off.arg || [];

                window.adoric = Util.assign({
                    getVersionFromCampaign: getVersionFromCampaign,
                    showLightbox: showLightbox,
                    showOtherVersion: showOtherVersion,
                    clearAllowedShow: clearAllowedShow,
                    setConfig: setConfig,
                    Util: Util,
                    removeEvents: Util.removeEvents,
                    refresh: refresh
                }, EventEmitter);

                adoric.trigger(OWN_EVENTS.infoReady, {
                    eventName: OWN_EVENTS.infoReady
                });
                currentConfig.isApiResponded = true;

                if (currentConfig.trackUser && currentDomain) { //track user if analyticsTracking is enabled
                    Goals.trackUser();
                    Goals.checkUrl();
                    Goals.checkQuery();
                }

                adoric.on(OWN_EVENTS.setConfig, setConfig);
                adoric.on(OWN_EVENTS.clearAllowedShow, clearAllowedShow);
                adoric.on(OWN_EVENTS.eventBeforeTrigger, function (eventName, data) {
                    var events = JSON.parse(Util.sessionStorageData(sessionStorageItems.adoric_session_events) || '{}');
                    var value = isNaN(+data) ? (data ? +data.value : 0 || 0) : +data;
                    var eventOptions = {
                        unique: '',
                        domainId: currentDomain._id,
                        value: value || 0
                    };

                    if (isNaN(+data) && typeof data === 'string') {
                        eventOptions.value = +data.replace(',', '.');
                    }

                    if (isNaN(+data) && typeof data === 'object') {
                        if (data.value) {
                            if (typeof data.value === 'string') {
                                eventOptions.value = +data.value.toString().replace(',', '.');
                            } else if (typeof data.value === 'number') {
                                eventOptions.value = data.value;
                            }
                        }
                    }

                    if (!events[eventName]) {
                        eventOptions.unique = true;
                        events[eventName] = EVENT_IS_UNIQUE;
                        Util.sessionStorageData(sessionStorageItems.adoric_session_events, JSON.stringify(events));
                    }

                    Util.localStorageData().removeItem(storagePrefixes.readed_event_ + eventName);

                    Util.saveEvent(eventName, eventOptions.value);
                    checkBasedOnEventConditions(eventName);
                    if (~OWN_EVENTS_ARR.indexOf(eventName)) {
                        currentConfig.debugMode && console.log('triggered own event: ', eventName);
                    } else {
                        currentConfig.debugMode && console.log('triggered custom event: ', eventName);
                        sendAnalyticEvent(eventName, eventOptions);
                        Goals.checkEvent({
                            name: eventName,
                            value: eventOptions.value
                        });
                        if (data && data.type && data.type.toLowerCase() === 'ecommerce' && currentConfig.trackUser) {
                            Goals.trackECommerceGoal({
                                name: eventName,
                                value: eventOptions.value,
                                data: data, // unused?
                                eCommerce: true // unused?
                            });
                            Util.saveBuyerInfo(eventOptions.value);
                        }
                    }
                });
                adoric.on(OWN_EVENTS.setDynamicLink, function setDynamicLink(data) {
                    adoric.dynamicLinks = adoric.dynamicLinks || {};
                    for (var key in data) {
                        if (!data.hasOwnProperty(key)) {
                            continue;
                        }
                        var links = document.querySelectorAll('.__ADORIC__ [data-track="' + key + '"]');

                        adoric.dynamicLinks[key] = data[key];
                        Array.prototype.forEach.call(links, function (link) {
                            link.href = data[key];
                        });
                    }
                });
                adoric.on(OWN_EVENTS.setDynamicVars, function setDynamicVar(data) {
                    adoric.dynamicVars = Util.assign(adoric.dynamicVars, data);
                });
                //hardcode for wix ^_^ (retrigger events to normal form)
                adoric.on('userProfile', function retriggerEvent(data) {
                    var message = '_Adoric_info: Getting "userProfile" event';

                    currentConfig.debugMode && (message += ', data: ' + data);
                    console.info(Util.getExactTime(), message);
                    for (var name in data) {
                        var newEventName = name + ':' + data[name];
                        var replaceEventName = name + ':' + !data[name];

                        Util.removeEvents(replaceEventName);
                        adoric.trigger(this, newEventName);
                    }
                });

                //on listen triggered event without adoric
                for (var k = 0; k < onArguments.length; k++) {
                    adoric.on.apply(window.adoric, onArguments[k])
                }
                //off listen triggered event without adoric
                for (var j = 0; j < offArguments.length; j++) {
                    adoric.off.apply(window.adoric, offArguments[j])
                }
                //send triggered event without adoric
                for (var i = 0; i < triggerArguments.length; i++) {
                    adoric.trigger.apply(window.adoric, triggerArguments[i])
                }

                typeof oldOnLoad === 'function' && oldOnLoad();

                //chrome adoric extension send post message
                window.postMessage && window.postMessage({
                    from: "ADORIC",
                    message: {
                        adoric_is_loaded: true
                    }
                }, "*");
            }

            Util.loadExternalStyle(ADORIC_CSS_URL, ADORIC_IDENTIFIER, Util.styleFilesHandler);
            Util.countReachingPage();
            Util.saveReferrerURL();
            Util.saveVisitors();
            Util.countTabs();
            Util.saveURLConditions();
            Util.removeIsShowingItems();
            start();
        })(window);
    }
})(window, document);
